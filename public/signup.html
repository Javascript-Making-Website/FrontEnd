<!doctype html>
<html lang="ko"> <!-- í•œêµ­ì–´ ì„¤ì • -->
<head>
  <meta charset="utf-8"/> <!-- í•œê¸€ì´ ê¹¨ì§€ì§€ ì•Šë„ë¡ ì„¤ì • -->
  <meta name="viewport" content="width=device-width,initial-scale=1"/> <!-- ëª¨ë°”ì¼ í™”ë©´ ë§ì¶¤ -->
  <title>Emotion Playlist Â· Signup</title> <!-- ë¸Œë¼ìš°ì € íƒ­ ì œëª© -->
  <link rel="stylesheet" href="./assets/styles.css"/> <!-- CSS ì—°ê²° -->
</head>

<body data-mood="calm">
  <header class="topbar">
    <div class="brand">ğŸ“ íšŒì›ê°€ì…</div> <!-- ìƒë‹¨ ì œëª© -->
    <nav class="nav">
      <!-- ê¸°ë³¸ ë©”ë‰´ ë²„íŠ¼ë“¤ -->
      <a href="./home.html" class="btn">í™ˆ</a> 
      <a href="./search.html" class="btn">ê²€ìƒ‰</a>
      <a href="./playlist.html" class="btn">ì¬ìƒëª©ë¡</a>
      <a href="./login.html" class="btn">ë¡œê·¸ì¸</a>
    </nav>
  </header>

  <main class="panel" style="max-width:420px;margin:16px auto;">
    <div class="title" style="margin-bottom:8px">ìƒˆ ê³„ì • ë§Œë“¤ê¸°</div>

    <!-- íšŒì›ê°€ì… ì…ë ¥ì¹¸ë“¤ -->
    <div style="display:flex;flex-direction:column;gap:8px">
      <input id="username" placeholder="ì•„ì´ë””"/>        <!-- ì•„ì´ë”” ì…ë ¥ -->
      <input id="email" placeholder="ì´ë©”ì¼ (ì„ íƒ)"/>    <!-- ì´ë©”ì¼ ì…ë ¥(ì„ íƒ) -->
      <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"/> <!-- ë¹„ë°€ë²ˆí˜¸ -->
      <input id="password2" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"/> <!-- ë¹„ë°€ë²ˆí˜¸ ì²´í¬ -->

      <button id="signupBtn" class="btn primary">íšŒì›ê°€ì…</button> <!-- íšŒì›ê°€ì… ë²„íŠ¼ -->
    </div>
  </main>

  <!-- ì„œë²„ ìš”ì²­ì„ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="./assets/api.js"></script>
  <script src="./assets/auth.js"></script>

  <script>
    const BASE = 'http://localhost:3001'; // ì •ë³´ë¥¼ ë³´ë‚¼ ì„œë²„ ì£¼ì†Œ

    document.addEventListener('DOMContentLoaded', () => { // í˜ì´ì§€ ë¡œë”© í›„ ì‹¤í–‰
      // ì…ë ¥ì¹¸ê³¼ ë²„íŠ¼ ê°€ì ¸ì˜¤ê¸°
      const usernameEl = document.getElementById('username'); // ì•„ì´ë”” ì…ë ¥ì¹¸
      const emailEl    = document.getElementById('email');    // ì´ë©”ì¼ ì…ë ¥ì¹¸
      const pwEl       = document.getElementById('password'); // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì¹¸
      const pw2El      = document.getElementById('password2'); // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì¹¸
      const btn        = document.getElementById('signupBtn'); // íšŒì›ê°€ì… ë²„íŠ¼

      // í˜¹ì‹œë¼ë„ ì…ë ¥ì¹¸ì´ ì—†ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨ (ì˜ˆì™¸ ì²˜ë¦¬)
      if (!usernameEl || !pwEl || !pw2El || !btn) return;

      // íšŒì›ê°€ì… ë²„íŠ¼ ëˆ„ë¥´ë©´ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
      async function handleSignup(e) {
        if (e) e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë§‰ê¸°

        // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const username = usernameEl.value.trim(); // ì•„ì´ë””
        const email    = (emailEl?.value || '').trim(); // ì´ë©”ì¼
        const pw       = pwEl.value;   // ë¹„ë°€ë²ˆí˜¸
        const pw2      = pw2El.value;  // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì„ ìœ„í•œ 2ì°¨ ì…ë ¥

        // ê¸°ë³¸ ì²´í¬(ë¹ˆì¹¸/ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´/ì¼ì¹˜ ì—¬ë¶€ í™•ì¸)
        if (!username) return alert('ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        if (!pw) return alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        if (pw.length < 6) return alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        if (pw !== pw2) return alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ë‹¤ë¦…ë‹ˆë‹¤.');

        try {
          // ì„œë²„ë¡œ íšŒì›ê°€ì… ìš”ì²­ ë³´ë‚´ê¸°
          const res = await fetch(`${BASE}/api/signup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include', // ì¿ í‚¤ í¬í•¨
            body: JSON.stringify({ username, password: pw, email }) // ë³´ë‚¼ ë°ì´í„°
          });

          const data = await res.json().catch(() => ({})); // ì‘ë‹µì„ JSONìœ¼ë¡œ ë³€í™˜

          if (!res.ok) {
            // ì‹¤íŒ¨ ì‹œ ì„œë²„ ë©”ì‹œì§€ ë³´ì—¬ì£¼ê¸°
            return alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }

          // ì„±ê³µ ì‹œ ë¸Œë¼ìš°ì €ì— ë¡œê·¸ì¸ ì •ë³´ ì €ì¥
          localStorage.setItem('ep_user', JSON.stringify({
            name: username,
            loggedIn: true,
            createdAt: Date.now()
          }));

          alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!'); // ì„±ê³µ ì•ˆë‚´
          location.href = './home.html'; // í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™

        } catch (err) {
          alert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); // ì˜ˆì™¸ ì²˜ë¦¬
        }
      }

      // ë²„íŠ¼ ëˆŒë €ì„ ë•Œ íšŒì›ê°€ì… ì‹¤í–‰
      btn.addEventListener('click', handleSignup);

      // ì…ë ¥ì¹¸ì—ì„œ ì—”í„° í‚¤ë¥¼ ëˆŒëŸ¬ë„ íšŒì›ê°€ì… ì‹¤í–‰ ì—”í„° í‚¤ì˜ ê¸°ë³¸ ë™ì‘ì„ ë§‰ëŠ” ì—­í• 
      [usernameEl, emailEl, pwEl, pw2El].forEach((el) => {
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') handleSignup();
        });
      });
    });
  </script>
</body>
</html>
