<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emotion Playlist Â· Search</title>
  <link rel="stylesheet" href="./assets/styles.css" />

  <style>
    /* ê²€ìƒ‰ ê²°ê³¼ ì¤„ ì˜¤ë¥¸ìª½ ì•¡ì…˜ ì˜ì—­ */
    .track-actions {
      margin-left: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }
    .track-actions .btn {
      padding: 4px 8px;
      font-size: 11px;
      line-height: 1.2;
    }

    /* ì¬ìƒëª©ë¡ ì„ íƒ ëª¨ë‹¬ */
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .6);
      z-index: 50;
    }
    .modal-box {
      max-width: 360px;
      width: 100%;
      padding: 16px;
    }
    .modal-list {
      max-height: 260px;
      overflow-y: auto;
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .modal-list .btn {
      width: 100%;
      justify-content: flex-start;
      font-size: 13px;
      padding: 6px 10px;
    }
    .modal-hint {
      font-size: 11px;
      opacity: .7;
      margin-top: 4px;
    }
  </style>
</head>
<body data-mood="calm">
  <header class="topbar">
    <div class="brand">ğŸ” Search</div>
    <nav class="nav">
      <a href="./home.html" class="btn">í™ˆ</a>
      <a href="./playlist.html" class="btn">ë‚´ ì¬ìƒëª©ë¡</a>
      <a href="./login.html" class="btn" id="loginLink">ë¡œê·¸ì¸</a>
      <span id="userBadge" class="badge hidden"></span>
      <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
    </nav>
  </header>

  <main class="panel" style="max-width:980px;margin:12px auto;">
    <form id="searchForm" class="search">
      <input id="searchInput" placeholder="ë…¸ë˜/ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰" />
      <button class="btn" type="submit">ê²€ìƒ‰</button>
    </form>

    <div class="moods" id="moodChips"></div>

    <div id="resultList" class="list" style="margin-top:10px;"></div>

    <!-- ë” ë³´ê¸° ë²„íŠ¼ -->
    <div style="text-align:center;margin-top:12px;">
      <button id="loadMoreBtn" class="btn hidden" type="button">ë” ë³´ê¸°</button>
    </div>
  </main>

  <footer class="foot">ê²€ìƒ‰ ê²°ê³¼ë¥¼ í´ë¦­í•˜ë©´ ê°ìƒ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.</footer>

  <!-- ì¬ìƒëª©ë¡ ì„ íƒ ëª¨ë‹¬ -->
  <div id="plPicker" class="modal hidden">
    <div class="panel modal-box">
      <div class="title" style="margin-bottom:4px;">ì¬ìƒëª©ë¡ì— ì¶”ê°€</div>
      <div id="plPickerHint" class="modal-hint"></div>
      <div id="plPickerList" class="modal-list"></div>
      <div style="text-align:right;margin-top:10px;">
        <button id="plPickerClose" class="btn" type="button">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì „ì—­ API ë¨¼ì € -->
  <script src="./assets/api.js"></script>
  <!-- í—¤ë” ë¡œê·¸ì¸ ìƒíƒœ ë™ê¸°í™” (API ë’¤ì— ë¡œë“œ) -->
  <script src="./assets/auth.js"></script>

  <script>
  const BASE = 'http://localhost:3001';

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì—ì„œ ì´ˆê¸° ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sp = new URLSearchParams(location.search);
  const initialMood   = sp.get('mood')   || '';
  const initialGenre  = sp.get('genre')  || '';
  const initialNation = sp.get('nation') || '';
  const targetPlaylistIdFromUrl = sp.get('addToPlaylist') || null; // â† playlist_viewì—ì„œ ë„˜ì–´ì˜¨ ëŒ€ìƒ ì¬ìƒëª©ë¡

  let currentMood = initialMood;

  if (initialMood) document.body.setAttribute('data-mood', initialMood);

  // í˜ì´ì§€ë„¤ì´ì…˜ + ìµœê·¼ ê²€ìƒ‰ ê²°ê³¼ ì €ì¥ìš©
  let currentQuery   = '';
  let nextPageToken  = null;
  let lastSearchList = [];   // â˜… playerë¡œ ë„˜ê¸¸ ë¦¬ìŠ¤íŠ¸
  let isLoading      = false; // â˜… ì¤‘ë³µ ë¡œë”© ë°©ì§€

  // ì¬ìƒëª©ë¡ ì¶”ê°€ìš© ìƒíƒœ
  let trackToAdd = null;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // player.htmlë¡œ ì´ë™í•˜ëŠ” ê³µí†µ í•¨ìˆ˜
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function goPlay(track) {
    try {
      localStorage.setItem('lastSearchList', JSON.stringify(lastSearchList));
      localStorage.setItem('lastSearchContext', JSON.stringify({
        mood: initialMood,
        genre: initialGenre,
        nation: initialNation,
        q: currentQuery,
      }));
    } catch (e) {
      console.warn('failed to save lastSearchList', e);
    }

    const params = new URLSearchParams();
    if (initialMood)   params.set('mood',   initialMood);
    if (initialGenre)  params.set('genre',  initialGenre);
    if (initialNation) params.set('nation', initialNation);
    params.set('from', 'search');
    params.set('id', track.id);

    window.location.href = `./player.html?${params.toString()}`;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì¬ìƒëª©ë¡ ì„ íƒ ëª¨ë‹¬ ê´€ë ¨
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const plModal       = document.getElementById('plPicker');
  const plModalList   = document.getElementById('plPickerList');
  const plModalHint   = document.getElementById('plPickerHint');
  const plModalClose  = document.getElementById('plPickerClose');

  function closePlaylistPicker() {
    trackToAdd = null;
    plModal.classList.add('hidden');
  }

  plModalClose.addEventListener('click', closePlaylistPicker);
  // ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œ ë‹«ê¸°
  plModal.addEventListener('click', (e) => {
    if (e.target === plModal) closePlaylistPicker();
  });

  async function openPlaylistPicker(track) {
    trackToAdd = track;
    plModal.classList.remove('hidden');
    plModalList.innerHTML = '<div class="sub">ì¬ìƒëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

    if (targetPlaylistIdFromUrl) {
      plModalHint.textContent = `í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì¬ìƒëª©ë¡ ID: ${targetPlaylistIdFromUrl}`;
    } else {
      plModalHint.textContent = 'ì¶”ê°€í•  ì¬ìƒëª©ë¡ì„ ì„ íƒí•˜ì„¸ìš”.';
    }

    try {
      const res = await fetch(`${BASE}/api/playlists`, {
        credentials: 'include',
      });
      if (res.status === 401) {
        alert('ë¡œê·¸ì¸ í›„ ì¬ìƒëª©ë¡ì— ê³¡ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        location.href = './login.html';
        return;
      }
      const data = await res.json();
      let lists = data.items || [];

      if (!lists.length) {
        plModalList.innerHTML = '<div class="sub">ì•„ì§ ë§Œë“  ì¬ìƒëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      // URLì—ì„œ ë„˜ì–´ì˜¨ ì¬ìƒëª©ë¡ì´ ìˆìœ¼ë©´ ë§¨ ìœ„ë¡œ ì˜¬ë¦¬ê¸°
      if (targetPlaylistIdFromUrl) {
        const idStr = String(targetPlaylistIdFromUrl);
        lists = lists.slice().sort((a, b) => {
          const aKey = String(a.id) === idStr ? -1 : 0;
          const bKey = String(b.id) === idStr ? -1 : 0;
          return aKey - bKey;
        });
      }

      plModalList.innerHTML = '';
      lists.forEach(pl => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn';

        const isTarget =
          targetPlaylistIdFromUrl &&
          String(pl.id) === String(targetPlaylistIdFromUrl);

        btn.innerHTML = `
          <span style="flex:1;">${pl.title} Â· íŠ¸ë™ ${(pl.items || []).length}ê°œ</span>
          <span style="font-size:11px;opacity:.7;">${pl.is_public ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'}</span>
        `;
        btn.style.display = 'flex';
        btn.style.alignItems = 'center';
        btn.style.gap = '6px';

        if (isTarget) {
          btn.style.border = '1px solid var(--accent, #1ed760)';
        }

        btn.addEventListener('click', async () => {
          try {
            const resAdd = await fetch(`${BASE}/api/playlist/items`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                playlistId: pl.id,
                trackId: trackToAdd.id,
                position: 0,
              }),
            });

            const dataAdd = await resAdd.json().catch(() => ({}));

            if (resAdd.status === 401) {
              alert('ë¡œê·¸ì¸ í›„ ì¬ìƒëª©ë¡ì— ê³¡ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              location.href = './login.html';
              return;
            }

            if (!resAdd.ok) {
              alert('ì¶”ê°€ ì‹¤íŒ¨: ' + (dataAdd.error || `${resAdd.status}`));
              return;
            }

            alert(`"${pl.title}" ì¬ìƒëª©ë¡ì— ê³¡ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`);
            closePlaylistPicker();
          } catch (e) {
            console.error(e);
            alert('ì¬ìƒëª©ë¡ì— ì¶”ê°€í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        });

        plModalList.appendChild(btn);
      });
    } catch (e) {
      console.error(e);
      plModalList.innerHTML =
        '<div class="sub" style="color:#f66;">ì¬ìƒëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì•„ì´í…œ ë Œë”ë§
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function itemEl(track) {
    const el = document.createElement('div');
    el.className = 'item';
    const thumb = track.thumb || '';

    el.innerHTML = `
      <img src="${thumb}" alt="thumb" />
      <div style="min-width:0;">
        <div class="t">${API.cleanTitle(track.title)}</div>
        <div class="s">
          ${track.artist ?? ''} Â·
          <span class="badge">${track.source ?? ''}</span>
        </div>
      </div>
      <div class="track-actions">
        <button type="button" class="btn" data-role="play">ì¬ìƒ</button>
        <button type="button" class="btn" data-role="add">â‹¯</button>
      </div>
    `;

    // ì „ì²´ ì¤„ í´ë¦­ -> í”Œë ˆì´ì–´
    el.addEventListener('click', () => {
      goPlay(track);
    });

    // ê°œë³„ ë²„íŠ¼ í•¸ë“¤ëŸ¬ (ë¶€ëª¨ í´ë¦­ ë§‰ê¸°)
    const playBtn = el.querySelector('[data-role="play"]');
    const addBtn  = el.querySelector('[data-role="add"]');

    if (playBtn) {
      playBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        goPlay(track);
      });
    }

    if (addBtn) {
      addBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openPlaylistPicker(track);
      });
    }

    return el;
  }

  function render(list, { append = false } = {}) {
    const holder = document.getElementById('resultList');
    if (!append) {
      holder.innerHTML = '';
    }
    list.forEach(t => holder.appendChild(itemEl(t)));
  }

  function setLoadMoreVisible(visible) {
    const btn = document.getElementById('loadMoreBtn');
    if (!btn) return;
    if (visible) btn.classList.remove('hidden');
    else btn.classList.add('hidden');
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ê°ì • ì¹© ë Œë”ë§ (UIë§Œ, ê²€ìƒ‰ì€ ê·¸ëŒ€ë¡œ)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function renderMoodChips() {
    const holder = document.getElementById('moodChips');
    holder.innerHTML = '';
    API.MOODS.forEach(m => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'chip';
      b.textContent = m.label;
       b.onclick = async () => {
      // 1) ë°°ê²½ ìƒ‰ / í…Œë§ˆ ë³€ê²½
      document.body.setAttribute('data-mood', m.key);

      // 2) í˜„ì¬ ì„ íƒëœ ê°ì • ìƒíƒœ ê°±ì‹ 
      currentMood = m.key;

      // 3) ìƒˆ ê²€ìƒ‰ ì¤€ë¹„
      nextPageToken = null;                 // í˜ì´ì§€ë„¤ì´ì…˜ ì´ˆê¸°í™”
      // ê²€ìƒ‰ì–´ë„ ê°™ì´ ë¦¬ì…‹í•˜ê³  ì‹¶ìœ¼ë©´:
      // currentQuery = '';
      // document.getElementById('searchInput').value = '';

      // 4) ì´ ê°ì •ìœ¼ë¡œ ë‹¤ì‹œ ê²€ìƒ‰
      await fetchAndRender({ append: false });
    };
      holder.appendChild(b);
    });
  })();

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì‹¤ì œ /api/search í˜¸ì¶œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function fetchAndRender({ append = false } = {}) {
    if (isLoading) return;          // â˜… ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
    isLoading = true;
    if (append) setLoadMoreVisible(false); // ë¡œë”© ì¤‘ì—” ë²„íŠ¼ ìˆ¨ê¹€

    const params = {
      q: currentQuery,
      mood: currentMood, 
      genre: initialGenre,
      nation: initialNation,
    };

    if (append && nextPageToken) {
      params.pageToken = nextPageToken;
    }

    try {
      const r = await API.search(params);
      const items = r.items || [];

      // â˜…ìµœê·¼ ê²€ìƒ‰ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
      if (append) {
        lastSearchList = lastSearchList.concat(items);
      } else {
        lastSearchList = items.slice();
      }

      render(items, { append });
      nextPageToken = r.nextPageToken || null;
      setLoadMoreVisible(!!nextPageToken);
    } catch (err) {
      console.warn('search failed, fallback to local', err);

      if (!append) {
        const items = API.list();
        lastSearchList = items.slice();
        render(items, { append: false });
        nextPageToken = null;
        setLoadMoreVisible(false);
      }
    } finally {
      isLoading = false;
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ë¬´í•œ ìŠ¤í¬ë¡¤ ì²´í¬ í•¨ìˆ˜
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function checkInfiniteScroll() {
    if (!nextPageToken || isLoading) return;

    const listEl = document.getElementById('resultList');

    // 1) ë¦¬ìŠ¤íŠ¸ ìì²´ì— ìŠ¤í¬ë¡¤ì´ ìˆëŠ” ê²½ìš°
    let needMore = false;
    if (listEl && listEl.scrollHeight > listEl.clientHeight + 10) {
      const bottom = listEl.scrollTop + listEl.clientHeight;
      const limit  = listEl.scrollHeight - 300; // 300px ë‚¨ì•˜ì„ ë•Œ ë¡œë”©
      if (bottom >= limit) needMore = true;
    }

    // 2) ìœˆë„ìš° ì „ì²´ ìŠ¤í¬ë¡¤ì¸ ê²½ìš°
    const root = document.documentElement;
    const winBottom = root.scrollTop + root.clientHeight;
    const winLimit  = root.scrollHeight - 300;
    if (winBottom >= winLimit) needMore = true;

    if (needMore) {
      await fetchAndRender({ append: true });
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('searchForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const q = document.getElementById('searchInput').value.trim();
    currentQuery = q;
    nextPageToken = null;
    await fetchAndRender({ append: false });
  });

  document.getElementById('loadMoreBtn').addEventListener('click', async () => {
    if (!nextPageToken) return;
    await fetchAndRender({ append: true });
  });

  // â˜… ë¬´í•œ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë“±ë¡
  window.addEventListener('scroll', checkInfiniteScroll);
  document.getElementById('resultList').addEventListener('scroll', checkInfiniteScroll);

  // ì´ˆê¸° ì§„ì… ì‹œ: mood/genre/nationë§Œìœ¼ë¡œ ì²« í˜ì´ì§€ ìë™ ë¡œë“œ
  (async () => {
    currentQuery = '';
    nextPageToken = null;
    await fetchAndRender({ append: false });
  })();
</script>

</body>
</html>