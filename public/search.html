<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emotion Playlist Â· Search</title>
  <link rel="stylesheet" href="./assets/styles.css" />
</head>
<body data-mood="calm">
  <header class="topbar">
    <div class="brand">ğŸ” Search</div>
    <nav class="nav">
      <a href="./home.html" class="btn">í™ˆ</a>
      <a href="./playlist.html" class="btn">ë‚´ ì¬ìƒëª©ë¡</a>
      <a href="./login.html" class="btn" id="loginLink">ë¡œê·¸ì¸</a>
      <span id="userBadge" class="badge hidden"></span>
      <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
    </nav>
  </header>

  <main class="panel" style="max-width:980px;margin:12px auto;">
    <form id="searchForm" class="search">
      <input id="searchInput" placeholder="ë…¸ë˜/ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰" />
      <button class="btn" type="submit">ê²€ìƒ‰</button>
    </form>

    <div class="moods" id="moodChips"></div>

    <div id="resultList" class="list" style="margin-top:10px;"></div>

    <!-- ë” ë³´ê¸° ë²„íŠ¼ -->
    <div style="text-align:center;margin-top:12px;">
      <button id="loadMoreBtn" class="btn hidden" type="button">ë” ë³´ê¸°</button>
    </div>
  </main>

  <footer class="foot">ê²€ìƒ‰ ê²°ê³¼ë¥¼ í´ë¦­í•˜ë©´ ê°ìƒ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.</footer>

  <!-- ì „ì—­ API ë¨¼ì € -->
  <script src="./assets/api.js"></script>
  <!-- í—¤ë” ë¡œê·¸ì¸ ìƒíƒœ ë™ê¸°í™” (API ë’¤ì— ë¡œë“œ) -->
  <script src="./assets/auth.js"></script>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì—ì„œ ì´ˆê¸° ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const sp = new URLSearchParams(location.search);
    const initialMood   = sp.get('mood')   || '';
    const initialGenre  = sp.get('genre')  || '';
    const initialNation = sp.get('nation') || '';
    if (initialMood) document.body.setAttribute('data-mood', initialMood);

    // í˜ì´ì§€ë„¤ì´ì…˜ + ìµœê·¼ ê²€ìƒ‰ ê²°ê³¼ ì €ì¥ìš©
    let currentQuery   = '';
    let nextPageToken  = null;
    let lastSearchList = [];   // â˜… playerë¡œ ë„˜ê¸¸ ë¦¬ìŠ¤íŠ¸

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ì•„ì´í…œ ë Œë”ë§
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function itemEl(track){
      const el = document.createElement('div');
      el.className = 'item';
      const thumb = track.thumb || '';
      el.innerHTML = `
        <img src="${thumb}" alt="thumb" />
        <div>
          <div class="t">${API.cleanTitle(track.title)}</div>
          <div class="s">${track.artist ?? ''} Â· <span class="badge">${track.source ?? ''}</span></div>
        </div>
      `;

      // â˜… í´ë¦­ ì‹œ player.htmlë¡œ ì´ë™í•˜ë„ë¡ ìˆ˜ì •
      el.onclick = () => {
        // ë°©ê¸ˆ ê²€ìƒ‰ ê²°ê³¼ ì „ì²´ë¥¼ localStorageì— ì €ì¥
        try {
          localStorage.setItem('lastSearchList', JSON.stringify(lastSearchList));
          localStorage.setItem('lastSearchContext', JSON.stringify({
            mood: initialMood,
            genre: initialGenre,
            nation: initialNation,
            q: currentQuery,
          }));
        } catch (e) {
          console.warn('failed to save lastSearchList', e);
        }

        const params = new URLSearchParams();
        if (initialMood)   params.set('mood',   initialMood);
        if (initialGenre)  params.set('genre',  initialGenre);
        if (initialNation) params.set('nation', initialNation);
        params.set('from', 'search');
        params.set('id', track.id);

        window.location.href = `./player.html?${params.toString()}`;
      };

      return el;
    }

    function render(list, { append = false } = {}) {
      const holder = document.getElementById('resultList');
      if (!append) {
        holder.innerHTML = '';
      }
      list.forEach(t => holder.appendChild(itemEl(t)));
    }

    function setLoadMoreVisible(visible) {
      const btn = document.getElementById('loadMoreBtn');
      if (!btn) return;
      if (visible) btn.classList.remove('hidden');
      else btn.classList.add('hidden');
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ê°ì • ì¹© ë Œë”ë§ (UIë§Œ, ê²€ìƒ‰ì€ ê·¸ëŒ€ë¡œ)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function renderMoodChips(){
      const holder = document.getElementById('moodChips');
      holder.innerHTML = '';
      API.MOODS.forEach(m => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'chip';
        b.textContent = m.label;
        b.onclick = () => {
          document.body.setAttribute('data-mood', m.key);
        };
        holder.appendChild(b);
      });
    })();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ì‹¤ì œ /api/search í˜¸ì¶œ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchAndRender({ append = false } = {}) {
      const params = {
        q: currentQuery,
        mood: initialMood,
        genre: initialGenre,
        nation: initialNation,
      };

      if (append && nextPageToken) {
        params.pageToken = nextPageToken;
      }

      try {
        const r = await API.search(params);
        const items = r.items || [];

        // â˜…ìµœê·¼ ê²€ìƒ‰ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
        if (append) {
          lastSearchList = lastSearchList.concat(items);
        } else {
          lastSearchList = items.slice();
        }

        render(items, { append });
        nextPageToken = r.nextPageToken || null;
        setLoadMoreVisible(!!nextPageToken);
      } catch (err) {
        console.warn('search failed, fallback to local', err);

        if (!append) {
          const items = API.list();
          lastSearchList = items.slice();
          render(items, { append: false });
          setLoadMoreVisible(false);
        }
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('searchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = document.getElementById('searchInput').value.trim();
      currentQuery = q;
      nextPageToken = null;
      await fetchAndRender({ append: false });
    });

    document.getElementById('loadMoreBtn').addEventListener('click', async () => {
      if (!nextPageToken) return;
      await fetchAndRender({ append: true });
    });

    // ì´ˆê¸° ì§„ì… ì‹œ: mood/genre/nationë§Œìœ¼ë¡œ ì²« í˜ì´ì§€ ìë™ ë¡œë“œ
    (async () => {
      currentQuery = '';
      nextPageToken = null;
      await fetchAndRender({ append: false });
    })();
  </script>
</body>
</html>
