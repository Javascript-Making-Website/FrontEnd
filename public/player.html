<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Emotion Playlist Â· Player</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
  <style>
    .iframe-wrap{ position:relative; padding-top:56.25%; background:#000; }
    .iframe-wrap > #player{ position:absolute; inset:0; }
    .item.active{ outline:2px solid #b39dff; }
  </style>
</head>
<body data-mood="calm">
  <header class="topbar">
    <div class="brand">ğŸ§ ê°ìƒ</div>
    <nav class="nav">
      <a href="./home.html" class="btn">í™ˆ</a>
      <a href="./search.html" class="btn">ê²€ìƒ‰</a>
      <a href="./playlist.html" class="btn">ì¬ìƒëª©ë¡</a>
      <a href="./login.html" id="loginLink" class="btn">ë¡œê·¸ì¸</a>
      <span id="userBadge" class="badge hidden"></span>
      <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
    </nav>
  </header>

  <main class="grid">
    <section class="panel">
      <div class="iframe-wrap">
        <div id="player"></div>
      </div>

      <div class="controls">
        <button id="playBtn" class="btn primary">ì¬ìƒ</button>
        <button id="pauseBtn" class="btn">ì¼ì‹œì •ì§€</button>
        <button id="addToPlaylistBtn" class="btn">ì¬ìƒëª©ë¡ì— ì¶”ê°€</button>
        <a id="openOnYT" class="btn" target="_blank" rel="noopener">YouTubeì—ì„œ ì—´ê¸°</a>
      </div>

      <div class="meta">
        <img id="nowThumb" alt="thumb"/>
        <div>
          <div id="nowTitle" class="title">ê³¡ì„ ì„ íƒí•˜ì„¸ìš”</div>
          <div id="nowSub" class="sub">ì•„í‹°ìŠ¤íŠ¸ Â· ì›ë³¸ ì œëª©</div>
        </div>
        <span id="nowSource" class="badge">â€“</span>
      </div>

      <div class="moods" id="rateMoods" style="margin-top:10px"></div>
    </section>

    <aside class="panel">
      <div class="sub" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <span>ì¶”ì²œ</span>
        <div id="moodChips" class="moods"></div>
      </div>
      <div id="recList" class="list"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px">
        <a id="moreRecsBtn" class="btn">ë‹¤ë¥¸ ê³¡ë„ ì¶”ì²œë°›ê¸° â†’</a>
      </div>
    </aside>

    <!-- ì„ë² ë“œ ë¶ˆê°€ ëª¨ë‹¬ -->
    <div id="embedBlockedPopup" class="modal hidden">
      <div class="box">
        <div class="title">ì´ ì˜ìƒì€ ì‚¬ì´íŠ¸ ì•ˆì—ì„œ ì¬ìƒí•  ìˆ˜ ì—†ì–´ìš”.</div>
        <p style="margin-bottom:14px;">
          í•´ë‹¹ ì˜ìƒì€ ìœ íŠœë¸Œ ì •ì±… ë•Œë¬¸ì— ì™¸ë¶€ ì‚¬ì´íŠ¸ì—ì„œ ì¬ìƒì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
          ì•„ë˜ ì¤‘ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.
        </p>

        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button id="ignoreBlocked" class="btn">ë‹«ê¸°</button>
          <a id="openBlockedYT" class="btn primary" target="_blank">YouTubeì—ì„œ ì—´ê¸°</a>
        </div>
      </div>
    </div>
  </main>

  <!-- ì¬ìƒ ì¢…ë£Œ í›„ íŒì—… -->
  <div id="afterPopup" class="modal hidden">
    <div class="box">
      <div class="title" style="margin-bottom:8px">ì´ ê³¡ì„ ë“£ê³  ë‚œ ì§€ê¸ˆ ê¸°ë¶„ì€?</div>
      <div id="afterMoods" class="moods"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <a class="btn" href="./home.html">ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ë‹¤ì‹œ í•˜ê¸°</a>
        <button id="closePopup" class="btn primary">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ìˆœì„œ ì¤‘ìš”: API(IIFE) â†’ auth í—¤ë” â†’ YouTube API â†’ í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="./assets/api.js"></script>
  <script src="./assets/auth.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìœ í‹¸
    const $ = (s) => document.querySelector(s);
    const MOODS = API.MOODS;

    const urlParams    = new URLSearchParams(location.search);
    const initialMood  = urlParams.get('mood')  || 'calm';
    const initialGenre = urlParams.get('genre') || '';
    const initialNation= urlParams.get('nation')|| '';
    const fromSearch   = (urlParams.get('from') || '') === 'search';
    const idParam      = urlParams.get('id') || null;

    document.body.setAttribute('data-mood', initialMood);

    async function gate(fn, { silent = false } = {}) {
      try {
        const { user } = await API.me();
        if (!user) {
          if (!silent) alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
          return;
        }
        await fn();
      } catch (e) {
        console.warn(e);
      }
    }

    const cleanTitle = (s) => (s || '')
      .replace(/\s*\([^\)]*\)|\s*\[[^\]]*\]/g, '')
      .replace(/\s{2,}/g, ' ')
      .trim();

    function getYouTubeId(track) {
      if (!track) return '';
      if (typeof track.id === 'string' && track.id.startsWith('youtube:')) {
        return track.id.split(':')[1];
      }
      const url = track.url || track.source || track.original_title || '';
      const m = /(?:v=|be\/)([\w-]{6,})/i.exec(url);
      return m ? m[1] : '';
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒíƒœ
    let ytPlayer = null;
    let currentTrack = null;
    let currentParams = { mood: initialMood, genre: initialGenre, nation: initialNation };
    let lastRecs = [];   // ì˜¤ë¥¸ìª½ ì¶”ì²œ ëª©ë¡ (ê²€ìƒ‰ì—ì„œ ì˜¨ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©)

    // YouTube Iframe API ì½œë°±
    window.onYouTubeIframeAPIReady = function () {
      ytPlayer = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: '',
        playerVars: { autoplay: 0, rel: 0, modestbranding: 1 },
        events: {
          onReady: onReady,
          onStateChange: onStateChange,
          onError: onError
        }
      });
    };

    async function onReady(){
      renderMoodChips();
      setupMoodChange();

      // 1) ê²€ìƒ‰ í™”ë©´ì—ì„œ ë„˜ì–´ì˜¨ ê²½ìš° â†’ lastSearchList ê·¸ëŒ€ë¡œ ì‚¬ìš©
      if (fromSearch) {
        let list = [];
        try {
          list = JSON.parse(localStorage.getItem('lastSearchList') || '[]') || [];
        } catch { list = []; }

        if (list.length) {
          lastRecs = list;
          const first = list.find(x => String(x.id) === String(idParam)) || list[0];
          setNow(first);
          renderRecList(lastRecs, first.id);
          return;   // â˜… /api/recs í˜¸ì¶œ ì•ˆ í•¨ â†’ ì‹œë“œ ë°ì´í„°ë¡œ ì•ˆ ë–¨ì–´ì§
        }
      }

      // 2) ê¸°ë³¸ ë™ì‘: ì„œë²„ ì¶”ì²œ ì‚¬ìš© (í™ˆì—ì„œ ë°”ë¡œ ì˜¨ ê²½ìš° ë“±)
      await refreshRecs();
      if (idParam) {
        const target = lastRecs.find(x => String(x.id) === String(idParam));
        if (target) {
          setNow(target);
          renderRecList(lastRecs, target.id);
        }
      }
    }

    function onStateChange(e) {
      if (e.data === YT.PlayerState.ENDED) {
        showEndPopup();
      }
    }

    function onError(e){
      console.warn('YouTube player error:', e.data);

      if (e.data === 101 || e.data === 150) {
        const popup = document.getElementById('embedBlockedPopup');
        const openBtn = document.getElementById('openBlockedYT');
        const closeBtn = document.getElementById('ignoreBlocked');

        const link = document.getElementById('openOnYT');
        if (link && link.href) {
          openBtn.href = link.href;   // YouTube ë§í¬ ì—°ê²°
        }

        popup.classList.remove('hidden');   // ëª¨ë‹¬ ì—´ê¸°
        closeBtn.onclick = () => popup.classList.add('hidden');
      }
    }


    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¶”ì²œ ëª©ë¡ ë Œë”ë§
    function renderRecList(list, highlightId){
      const holder = $('#recList');
      holder.innerHTML = '';
      list.forEach(t => {
        const el = document.createElement('div');
        el.className = 'item' + (highlightId && String(highlightId) === String(t.id) ? ' active' : '');
        const thumb = t.thumb || '';
        el.innerHTML = `
          <img src="${thumb}" alt="thumb"/>
          <div>
            <div class="title">${cleanTitle(t.title || '')}</div>
            <div class="sub">${t.artist || ''} Â· <span class="badge">${t.source || ''}</span></div>
          </div>
        `;
        el.onclick = () => {
          setNow(t);
          renderRecList(list, t.id);
        };
        holder.appendChild(el);
      });
    }

    async function refreshRecs(){
      const { mood, genre, nation } = currentParams;
      let items = [];
      try{
        const r = await API.recs({ mood, genre, nation });
        items = r.items || [];
      }catch{
        items = API.list();  // ìœ íŠœë¸Œ ë§‰íŒ ê²½ìš° í´ë°±
      }
      lastRecs = items;
      renderRecList(lastRecs, currentTrack?.id);
      if (!currentTrack && lastRecs[0]) setNow(lastRecs[0]);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê°ì • ì¹©
    function setupMoodChange() {
      const chips = $('#moodChips');
      chips.addEventListener('click', async (ev) => {
        const b = ev.target.closest('button[data-mood]');
        if (!b) return;
        const mood = b.dataset.mood;
        document.body.setAttribute('data-mood', mood);
        currentParams.mood = mood;
        await refreshRecs();
      });
    }

    function renderMoodChips() {
      const holder = $('#moodChips');
      holder.innerHTML = '';
      MOODS.forEach(m => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'chip' + (m.key === initialMood ? ' active' : '');
        b.dataset.mood = m.key;
        b.textContent = m.label;
        holder.appendChild(b);
      });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ í˜„ì¬ íŠ¸ë™ ì„¸íŒ…
    function setNow(t) {
      currentTrack = t;

      const vid = getYouTubeId(t);
      if (ytPlayer && ytPlayer.loadVideoById && vid) ytPlayer.loadVideoById(vid);

      $('#nowThumb').src = t.thumb || '';
      $('#nowTitle').textContent = cleanTitle(t.title || '');
      $('#nowSub').textContent = `${t.artist || ''} Â· ${(t.original_title || t.originalTitle || '')}`;
      $('#nowSource').textContent = t.source || 'YouTube';
      $('#openOnYT').href = t.url || (vid ? `https://www.youtube.com/watch?v=${vid}` : '#');

      renderRateChips();

      gate(async () => { await API.watch(t.id); }, { silent: true });
    }

    function renderRateChips() {
      const box = $('#rateMoods');
      box.innerHTML = '';
      MOODS.forEach(m => {
        const b = document.createElement('button');
        b.className = 'chip';
        b.textContent = m.label;
        b.onclick = () => gate(async () => {
          await API.rate(currentTrack.id, m.key);
          document.body.setAttribute('data-mood', m.key);
          currentParams.mood = m.key;
          await refreshRecs();
          alert(`"${m.label}"ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        });
        box.appendChild(b);
      });
    }

    function showEndPopup() {
      const wrap = $('#afterPopup');
      const holder = $('#afterMoods');
      holder.innerHTML = '';
      MOODS.forEach(m => {
        const b = document.createElement('button');
        b.className = 'chip';
        b.textContent = m.label;
        b.onclick = () => gate(async () => {
          await API.rate(currentTrack.id, m.key);
          document.body.setAttribute('data-mood', m.key);
          currentParams.mood = m.key;
          wrap.classList.add('hidden');
          await refreshRecs();
        });
        holder.appendChild(b);
      });
      wrap.classList.remove('hidden');
      $('#closePopup').onclick = () => wrap.classList.add('hidden');
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë²„íŠ¼ë“¤
    $('#playBtn').onclick  = () => { try { ytPlayer.playVideo(); } catch {} };
    $('#pauseBtn').onclick = () => { try { ytPlayer.pauseVideo(); } catch {} };

    $('#addToPlaylistBtn').onclick = () => gate(async () => {
      if (!currentTrack) return;
      let { items } = await API.playlists().catch(() => ({ items: [] }));
      if (!items || !items[0]) {
        const created = await API.createPlaylist({ title: 'ë‚´ ì¬ìƒëª©ë¡', isPublic: false });
        items = [{ id: created.id, title: 'ë‚´ ì¬ìƒëª©ë¡' }];
      }
      await API.addToPlaylist({
        playlistId: items[0].id,
        trackId: currentTrack.id,
        position: 0
      });
      alert('ì¬ìƒëª©ë¡ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.');
    });

    // "ë‹¤ë¥¸ ê³¡ë„ ì¶”ì²œë°›ê¸°" â†’ ë‹¤ì‹œ searchë¡œ
    $('#moreRecsBtn').onclick = () => {
      const { mood, genre, nation } = currentParams;
      const sp = new URLSearchParams();
      if (mood)   sp.set('mood', mood);
      if (genre)  sp.set('genre', genre);
      if (nation) sp.set('nation', nation);
      location.href = `./search.html?${sp.toString()}`;
    };
  </script>
</body>
</html>
