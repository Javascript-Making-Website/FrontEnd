<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Emotion Playlist Â· Player</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
  <style>
    .iframe-wrap{ position:relative; padding-top:56.25%; background:#000; }
    .iframe-wrap > #player{ position:absolute; inset:0; }
  </style>
</head>
<body data-mood="calm">
  <header class="topbar">
    <div class="brand">ğŸ§ ê°ìƒ</div>
    <nav class="nav">
      <a href="./home.html" class="btn">í™ˆ</a>
      <a href="./search.html" class="btn">ê²€ìƒ‰</a>
      <a href="./playlist.html" class="btn">ì¬ìƒëª©ë¡</a>
      <a href="./login.html" id="loginLink" class="btn">ë¡œê·¸ì¸</a>
      <span id="userBadge" class="badge hidden"></span>
      <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
    </nav>
  </header>

  <main class="grid">
    <section class="panel">
      <div class="iframe-wrap">
        <div id="player"></div>
      </div>

      <div class="controls">
        <button id="playBtn" class="btn primary">ì¬ìƒ</button>
        <button id="pauseBtn" class="btn">ì¼ì‹œì •ì§€</button>
        <button id="addToPlaylistBtn" class="btn">ì¬ìƒëª©ë¡ì— ì¶”ê°€</button>
        <a id="openOnYT" class="btn" target="_blank" rel="noopener">YouTubeì—ì„œ ì—´ê¸°</a>
      </div>

      <div class="meta">
        <img id="nowThumb" alt="thumb"/>
        <div>
          <div id="nowTitle" class="title">ê³¡ì„ ì„ íƒí•˜ì„¸ìš”</div>
          <div id="nowSub" class="sub">ì•„í‹°ìŠ¤íŠ¸ Â· ì›ë³¸ ì œëª©</div>
        </div>
        <span id="nowSource" class="badge">â€“</span>
      </div>

      <div class="moods" id="rateMoods" style="margin-top:10px"></div>
    </section>

    <aside class="panel">
      <div class="sub" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <span>ì¶”ì²œ</span>
        <div id="moodChips" class="moods"></div>
      </div>
      <div id="recList" class="list"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px">
        <a id="moreRecsBtn" class="btn">ë‹¤ë¥¸ ê³¡ë„ ì¶”ì²œë°›ê¸° â†’</a>
      </div>
    </aside>
  </main>

  <!-- ì¬ìƒ ì¢…ë£Œ í›„ íŒì—… -->
  <div id="afterPopup" class="modal hidden">
    <div class="box">
      <div class="title" style="margin-bottom:8px">ì´ ê³¡ì„ ë“£ê³  ë‚œ ì§€ê¸ˆ ê¸°ë¶„ì€?</div>
      <div id="afterMoods" class="moods"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <a class="btn" href="./home.html">ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ë‹¤ì‹œ í•˜ê¸°</a>
        <button id="closePopup" class="btn primary">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ìˆœì„œ ì¤‘ìš”: API(IIFE) â†’ auth í—¤ë” â†’ YouTube API â†’ í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="./assets/api.js"></script>
  <script src="./assets/auth.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìœ í‹¸
    const $ = (s)=>document.querySelector(s);
    const MOODS = API.MOODS;

    // ë¡œê·¸ì¸ í•„ìš”í•œ ë™ì‘ ê°ì‹¸ê¸°
    async function gate(fn, { silent = false } = {}) {
      try {
        const { user } = await API.me();
        if (!user) {
          if (!silent) {
            alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
          }
          // ë¦¬ë‹¤ì´ë ‰íŠ¸ ì ˆëŒ€ ì•ˆ í•¨
          return;
        }
        await fn();
      } catch (e) {
        console.warn(e);
      }
    }

    const cleanTitle = (s)=> (s || '')
      .replace(/\s*\([^\)]*\)|\s*\[[^\]]*\]/g,'')
      .replace(/\s{2,}/g,' ')
      .trim();

    // YouTube ID ì¶”ì¶œ: "youtube:ID" ë˜ëŠ” source/urlì—ì„œ v= ì¶”ì¶œ
    function getYouTubeId(track){
      if (!track) return '';
      if (typeof track.id === 'string' && track.id.startsWith('youtube:')) {
        return track.id.split(':')[1];
      }
      const url = track.url || track.source || track.original_title || '';
      const m = /(?:v=|be\/)([\w-]{6,})/i.exec(url);
      return m ? m[1] : '';
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒíƒœ
    let ytPlayer = null;
    let currentTrack = null;

    // YouTube Iframe API ì½œë°±
    window.onYouTubeIframeAPIReady = function(){
      ytPlayer = new YT.Player('player', {
        height:'100%', width:'100%', videoId:'',
        playerVars:{autoplay:0, rel:0, modestbranding:1},
        events:{
          onReady: onReady,
          onStateChange: onStateChange
        }
      });
    };

    async function onReady(){
      renderMoodChips();
      setupMoodChange();

      // URL íŒŒë¼ë¯¸í„°ë¡œ idê°€ ì˜¨ ê²½ìš° ìš°ì„  ì ìš©
      const p = new URLSearchParams(location.search);
      const mood = p.get('mood') || 'calm';
      document.body.setAttribute('data-mood', mood);

      await refreshRecs();

      const idParam = p.get('id');
      if (idParam) {
        // ì¶”ì²œëª©ë¡ê³¼ ë³„ê°œë¡œ ë°”ë¡œ ì„¸íŒ… ì‹œë„ (ë”ë¯¸/ë°±ì—”ë“œ ëª¨ë‘ ëŒ€ì‘)
        const list = (await API.search({ q: '' }).catch(()=>({items: API.list()}))).items || [];
        const t = list.find(x => String(x.id) === idParam) || { id: idParam, title:'', artist:'', thumb:'', source:'YouTube' };
        setNow(t);
      }
    }

    function onStateChange(e){
      if (e.data === YT.PlayerState.ENDED){
        showEndPopup();
      }
    }

    function setupMoodChange(){
      const chips = $('#moodChips');
      chips.addEventListener('click', async (ev)=>{
        const b = ev.target.closest('button[data-mood]');
        if (!b) return;
        document.body.setAttribute('data-mood', b.dataset.mood);
        await refreshRecs();
      });
    }

    function renderMoodChips(){
      const holder = $('#moodChips');
      holder.innerHTML = '';
      MOODS.forEach(m=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'chip';
        b.dataset.mood = m.key;
        b.textContent = m.label;
        holder.appendChild(b);
      });
    }

    async function refreshRecs(){
      const mood = document.body.getAttribute('data-mood') || 'calm';
      let items = [];
      try{
        const r = await API.recs(mood);
        items = r.items || [];
      }catch{
        // í´ë°±: ë¡œì»¬ ë”ë¯¸
        items = API.list();
      }

      const holder = $('#recList');
      holder.innerHTML = '';
      items.forEach(t=>{
        const el = document.createElement('div');
        el.className = 'item';
        const thumb = t.thumb || '';
        el.innerHTML = `
          <img src="${thumb}" alt="thumb"/>
          <div>
            <div class="title">${cleanTitle(t.title || '')}</div>
            <div class="sub">${t.artist || ''} Â· <span class="badge">${t.source || ''}</span></div>
          </div>
        `;
        el.onclick = ()=> setNow(t);
        holder.appendChild(el);
      });

      if (!currentTrack && items[0]) setNow(items[0]);
    }

    function setNow(t){
      currentTrack = t;

      const vid = getYouTubeId(t);
      if (ytPlayer && ytPlayer.loadVideoById && vid) ytPlayer.loadVideoById(vid);

      $('#nowThumb').src = t.thumb || '';
      $('#nowTitle').textContent = cleanTitle(t.title || '');
      $('#nowSub').textContent = `${t.artist || ''} Â· ${(t.original_title || t.originalTitle || '')}`;
      $('#nowSource').textContent = t.source || 'YouTube';
      $('#openOnYT').href = t.url || (vid ? `https://www.youtube.com/watch?v=${vid}` : '#');

      renderRateChips();

       // ì‹œì²­ê¸°ë¡ (ë¡œê·¸ì¸ í•„ìš”í•˜ì§€ë§Œ, ë¹„ë¡œê·¸ì¸ì´ë©´ ì•„ë¬´ ì•Œë¦¼ ì—†ì´ ë¬´ì‹œ)
      gate(async () => { await API.watch(t.id); }, { silent: true });
    }

    function renderRateChips(){
      const box = $('#rateMoods');
      box.innerHTML = '';
      MOODS.forEach(m=>{
        const b = document.createElement('button');
        b.className = 'chip';
        b.textContent = m.label;
        b.onclick = ()=> gate(async ()=>{
          await API.rate(currentTrack.id, m.key);
          document.body.setAttribute('data-mood', m.key);
          await refreshRecs();
          alert(`"${m.label}"ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        });
        box.appendChild(b);
      });
    }

    function showEndPopup(){
      const wrap = $('#afterPopup');
      const holder = $('#afterMoods');
      holder.innerHTML = '';
      MOODS.forEach(m=>{
        const b = document.createElement('button');
        b.className = 'chip';
        b.textContent = m.label;
        b.onclick = ()=> gate(async ()=>{
          await API.rate(currentTrack.id, m.key);
          document.body.setAttribute('data-mood', m.key);
          wrap.classList.add('hidden');
          await refreshRecs();
        });
        holder.appendChild(b);
      });
      wrap.classList.remove('hidden');
      $('#closePopup').onclick = ()=> wrap.classList.add('hidden');
    }

    // ë²„íŠ¼ë“¤
    $('#playBtn').onclick = ()=>{ try{ ytPlayer.playVideo(); }catch{} };
    $('#pauseBtn').onclick = ()=>{ try{ ytPlayer.pauseVideo(); }catch{} };
    $('#addToPlaylistBtn').onclick = ()=> gate(async ()=>{
      if (!currentTrack) return;
      let { items } = await API.playlists().catch(()=>({items:[]}));
      // ì—†ìœ¼ë©´ í•˜ë‚˜ ìƒì„±
      if (!items || !items[0]) {
        const created = await API.createPlaylist({ title:'ë‚´ ì¬ìƒëª©ë¡', isPublic:false });
        items = [{ id: created.id, title:'ë‚´ ì¬ìƒëª©ë¡' }];
      }
      await API.addToPlaylist({ playlistId: items[0].id, trackId: currentTrack.id, position: 0 });
      alert('ì¬ìƒëª©ë¡ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.');
    });

    $('#moreRecsBtn').onclick = ()=>{
      const mood = document.body.getAttribute('data-mood') || '';
      location.href = `./search.html?mood=${encodeURIComponent(mood)}`;
    };
  </script>
</body>
</html>
