<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Emotion Playlist Â· Player</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
  <style>
    .iframe-wrap{ position:relative; padding-top:56.25%; background:#000; }
    .iframe-wrap > #player{ position:absolute; inset:0; }
  </style>
</head>
<body data-mood="calm">
  <header class="topbar">
    <div class="brand">ğŸ§ ê°ìƒ</div>
    <nav class="nav">
      <a href="./home.html" class="btn">í™ˆ</a>
      <a href="./search.html" class="btn">ê²€ìƒ‰</a>
      <a href="./playlist.html" class="btn">ì¬ìƒëª©ë¡</a>
      <a href="./login.html" id="loginLink" class="btn">ë¡œê·¸ì¸</a>
      <span id="userBadge" class="badge hidden"></span>
      <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
    </nav>
  </header>

  <main class="grid">
    <section class="panel">
      <div class="iframe-wrap">
        <div id="player"></div>
      </div>

      <div class="controls">
        <button id="playBtn" class="btn primary">ì¬ìƒ</button>
        <button id="pauseBtn" class="btn">ì¼ì‹œì •ì§€</button>
        <button id="addToPlaylistBtn" class="btn">ì¬ìƒëª©ë¡ì— ì¶”ê°€</button>
        <a id="openOnYT" class="btn" target="_blank" rel="noopener">YouTubeì—ì„œ ì—´ê¸°</a>
      </div>

      <div class="meta">
        <img id="nowThumb" alt="thumb"/>
        <div>
          <div id="nowTitle" class="title">ê³¡ì„ ì„ íƒí•˜ì„¸ìš”</div>
          <div id="nowSub" class="sub">ì•„í‹°ìŠ¤íŠ¸ Â· ì›ë³¸ ì œëª©</div>
        </div>
        <span id="nowSource" class="badge">â€“</span>
      </div>

      <div class="moods" id="rateMoods" style="margin-top:10px"></div>
    </section>

    <aside class="panel">
      <div class="sub" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <span>ì¶”ì²œ</span>
        <div id="moodChips" class="moods"></div>
      </div>
      <div id="recList" class="list"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px">
        <a id="moreRecsBtn" class="btn">ë‹¤ë¥¸ ê³¡ë„ ì¶”ì²œë°›ê¸° â†’</a>
      </div>
    </aside>
  </main>

  <!-- ì¬ìƒ ì¢…ë£Œ í›„ íŒì—… -->
  <div id="afterPopup" class="modal hidden">
    <div class="box">
      <div class="title" style="margin-bottom:8px">ì´ ê³¡ì„ ë“£ê³  ë‚œ ì§€ê¸ˆ ê¸°ë¶„ì€?</div>
      <div id="afterMoods" class="moods"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <a class="btn" href="./home.html">ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ë‹¤ì‹œ í•˜ê¸°</a>
        <button id="closePopup" class="btn primary">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ìˆœì„œ ì¤‘ìš”: API(IIFE) â†’ auth í—¤ë” â†’ YouTube API â†’ í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="./assets/api.js"></script>
  <script src="./assets/auth.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìœ í‹¸
    const $ = (s)=>document.querySelector(s);
    const MOODS = API.MOODS;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìœ í‹¸ & ìƒíƒœ
    // [ë‹¨ì¶•í‚¤ ë§Œë“¤ê¸°] 
    // "document.querySelector(...)"ë¼ê³  ë§¤ë²ˆ ê¸¸ê²Œ ì¹˜ê¸° ê·€ì°®ìœ¼ë‹ˆê¹Œ,
    // ì•ìœ¼ë¡œëŠ” "$"ë¼ê³ ë§Œ ì³ë„ ë˜‘ê°™ì´ ë™ì‘í•˜ê²Œ ë§Œë“  'ë³„ëª…(ë‹¨ì¶•í‚¤)'ì…ë‹ˆë‹¤.
    const $ = (s) => document.querySelector(s);

    // [ë°ì´í„° ê°€ì ¸ì˜¤ê¸°]
    // ë‹¤ë¥¸ íŒŒì¼(API)ì— ì •ì˜ëœ 'ê¸°ë¶„ ëª©ë¡(MOODS)'ì„ ê°€ì ¸ì™€ì„œ ë‚´ ì±…ìƒ ìœ„(ë³€ìˆ˜)ì— ì˜¬ë ¤ë†“ê³  ì“°ê¸° í¸í•˜ê²Œ ì¤€ë¹„í•©ë‹ˆë‹¤.
    const MOODS = API.MOODS;

    // [ì£¼ì†Œì°½ ë¶„ì„ê¸° ê°€ë™]
    // í˜„ì¬ ì›¹ë¸Œë¼ìš°ì € ì£¼ì†Œì°½(location)ì˜ '?' ë’¤ì— ìˆëŠ” ë‚´ìš©ë“¤ì„ ì½ì–´ì˜µë‹ˆë‹¤.
    const urlParams     = new URLSearchParams(location.search);

    // [ì´ˆê¸° ì„¤ì •ê°’ ì •í•˜ê¸°] (ë§¤ìš° ì¤‘ìš”! â˜…â˜…â˜…)
    // 'mood'ë¼ê³  ì íŒ ê²Œ ìˆì–´?"ë¼ê³  ë¬¼ì–´ë´…ë‹ˆë‹¤.
    // -> || (ë˜ëŠ”): "ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´(nullì´ë©´) ë’¤ì— ìˆëŠ” 'calm'ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì¨ë¼."
    // ì¦‰, ì•„ë¬´ ì„¤ì • ì—†ì´ ë“¤ì–´ì˜¤ë©´ ë¬´ì¡°ê±´ 'ì°¨ë¶„í•œ(calm)' ëª¨ë“œë¡œ ì‹œì‘í•œë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.
    const initialMood   = urlParams.get('mood')   || 'calm';

    // [ë‚˜ë¨¸ì§€ ì„¤ì •ë“¤ë„ ë˜‘ê°™ì´ í™•ì¸]
    // "ì£¼ì†Œì°½ì— 'genre'ê°€ ìˆìœ¼ë©´ ì“°ê³ , ì—†ìœ¼ë©´ ë¹ˆì¹¸('')ìœ¼ë¡œ ë‘¬."
    const initialGenre  = urlParams.get('genre')  || '';
    // "ì£¼ì†Œì°½ì— 'nation'(êµ­ê°€)ì´ ìˆìœ¼ë©´ ì“°ê³ , ì—†ìœ¼ë©´ ë¹ˆì¹¸."
    const initialNation = urlParams.get('nation') || '';
    // "ì£¼ì†Œì°½ì— 'sub'(ì„¸ë¶€ì¥ë¥´)ê°€ ìˆìœ¼ë©´ ì“°ê³ , ì—†ìœ¼ë©´ ë¹ˆì¹¸."
    const initialSub    = urlParams.get('sub')    || '';
    // "ì£¼ì†Œì°½ì— 'tone'(í†¤)ì´ ìˆìœ¼ë©´ ì“°ê³ , ì—†ìœ¼ë©´ ë¹ˆì¹¸."
    const initialTone   = urlParams.get('tone')   || '';
    // "ì–´ë””ì„œ íƒ€ê³  ë“¤ì–´ì™”ëŠ”ì§€('from') ì •ë³´ê°€ ìˆìœ¼ë©´ ì“°ê³ , ì—†ìœ¼ë©´ ë¹ˆì¹¸."
    const fromParam     = urlParams.get('from')   || '';
    // "íŠ¹ì • í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ IDê°€ ìˆìœ¼ë©´ ì“°ê³ , ì—†ìœ¼ë©´ ë¹ˆì¹¸."
    const playlistIdParam = urlParams.get('playlistId') || '';
    // bodyì— ê¸°ë³¸ mood ì ìš©
    document.body.setAttribute('data-mood', initialMood);

    // ëª¨ë“œ: recs / search / playlist
    let mode = 'recs';
    let ytPlayer = null;
    let currentTrack = null;
    let currentParams = {
      mood: initialMood,
      genre: initialGenre,
      nation: initialNation,
      sub: initialSub,
      tone:   initialTone,
    };

    // í(ê²€ìƒ‰ ê²°ê³¼ë‚˜ ì¬ìƒëª©ë¡ ê³¡ë“¤)
    let queue = [];
    let queueIndex = -1;

    // â˜…â˜…â˜… ìŠ¤í‚µ íŒë‹¨ìš© ì „ì—­ ìƒíƒœ
    let currentTrackId = null;  // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ íŠ¸ë™ id
    let playStartMs    = null;  // ì´ íŠ¸ë™ì„ ì¬ìƒí•˜ê¸° ì‹œì‘í•œ ì‹œê°(ms)

    // ë¡œê·¸ì¸ í•„ìš”í•œ ë™ì‘ ê°ì‹¸ê¸°
    async function gate(fn, { silent = false } = {}) {
      try {
        const { user } = await API.me();
        if (!user) {
          if (!silent) {
            alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
          }
          // ë¦¬ë‹¤ì´ë ‰íŠ¸ ì ˆëŒ€ ì•ˆ í•¨
          return;
        }
        await fn();
      } catch (e) {
        console.warn(e);
      }
    }

    const cleanTitle = (s)=> (s || '')
      .replace(/\s*\([^\)]*\)|\s*\[[^\]]*\]/g,'')
      .replace(/\s{2,}/g,' ')
      .trim();

    // YouTube ID ì¶”ì¶œ: "youtube:ID" ë˜ëŠ” source/urlì—ì„œ v= ì¶”ì¶œ
    function getYouTubeId(track){
    // YouTube ID ì¶”ì¶œ: "youtube:ID" ë˜ëŠ” URLì—ì„œ v= ì¶”ì¶œ
    // â˜…â˜…â˜… ë…¸ë˜ ì •ë³´(track)ì—ì„œ ìœ íŠœë¸Œ ID(ì˜ìƒ ê³ ìœ ë²ˆí˜¸)ë§Œ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
    function getYouTubeId(track) {
    
      // ë…¸ë˜ ì •ë³´ ìì²´ê°€ ì—†ë‹¤ë©´ ë¶„ì„í•  ê²Œ ì—†ìœ¼ë‹ˆ ë¹ˆ ë¬¸ìì—´('')ì„ ì£¼ê³  ëëƒ…ë‹ˆë‹¤.
      if (!track) return '';

      // IDê°€ "youtube:ABCDEFG" ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì í˜€ ìˆëŠ” ê²½ìš°
      // -> track.idê°€ ê¸€ì(string)ì´ê³ , "youtube:"ë¡œ ì‹œì‘í•œë‹¤ë©´?
      if (typeof track.id === 'string' && track.id.startsWith('youtube:')) {
        // -> ì½œë¡ (:)ì„ ê¸°ì¤€ìœ¼ë¡œ ê°€ìœ„ì§ˆ(split)ì„ í•©ë‹ˆë‹¤.
        // -> [0]ì€ "youtube", [1]ì€ "ABCDEFG"ê°€ ë˜ë¯€ë¡œ, ë’¤ìª½([1])ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
        return track.id.split(':')[1];
      }

      // IDê°€ ì¸í„°ë„· ì£¼ì†Œ(URL) ì†ì— ìˆ¨ì–´ìˆëŠ” ê²½ìš°
      // -> ì£¼ì†Œê°€ 'url'ì— ìˆì„ ìˆ˜ë„, 'source'ì— ìˆì„ ìˆ˜ë„, 'original_title'ì— ìˆì„ ìˆ˜ë„ ìˆì–´ì„œ
      // -> ìˆœì„œëŒ€ë¡œ ì£¼ë¨¸ë‹ˆë¥¼ ë’¤ì ¸ë´…ë‹ˆë‹¤. (||ëŠ” "ì—†ìœ¼ë©´ ë‹¤ìŒ ê±°!"ë¼ëŠ” ëœ»)
      // -> ë‹¤ ë’¤ì ¸ë„ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´('')ì„ ì”ë‹ˆë‹¤.
      const url = track.url || track.source || track.original_title || '';

      // 4. ì •ê·œí‘œí˜„ì‹(Regex)ì´ë¼ëŠ” ê°•ë ¥í•œ ìŠ¤ìºë„ˆë¥¼ ëŒë¦½ë‹ˆë‹¤.
      // -> í•´ì„: "v=" ë’¤ì— ìˆê±°ë‚˜, "be/" ë’¤ì— ìˆëŠ” ì•ŒíŒŒë²³/ìˆ«ì ë­‰ì¹˜ë¥¼ ì°¾ì•„ë¼!
      // -> (ì˜ˆ: watch?v=ABCDEFG ë˜ëŠ” youtu.be/ABCDEFG)
      const m = /(?:v=|be\/)([\w-]{6,})/i.exec(url);

      // 5. ìŠ¤ìºë„ˆê°€ ë­”ê°€ë¥¼ ì°¾ì•˜ë‚˜ìš”(m)?
      // -> ì°¾ì•˜ìœ¼ë©´ ê·¸ ì•Œë§¹ì´(m[1])ë¥¼ ëŒë ¤ì£¼ê³ , ëª» ì°¾ì•˜ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´('')ì„ ì¤ë‹ˆë‹¤.
      return m ? m[1] : '';
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒíƒœ
    let ytPlayer = null;
    let currentTrack = null;

    // YouTube Iframe API ì½œë°±
    window.onYouTubeIframeAPIReady = function(){
  // ì˜ìƒ ìŠ¤í‚µì‹œ ì •ë³´ ìˆ˜ì§‘
  async function sendSkipIfNeeded() {

  if (!currentTrackId || playStartMs == null) return;  // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ë…¸ë˜ ì •ë³´ë‚˜ ì¬ìƒ ê¸°ë¡ì´ ì—†ë‹¤ë©´ ì¦‰ì‹œ ì¢…ë£Œ

  // ì‚¬ìš©ìê°€ ë…¸ë˜ë¥¼ ì‹¤ì œë¡œ ë“¤ì€ ì‹œê°„ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
  // -> (í˜„ì¬ ì‹œê°„ - ì‹œì‘ ì‹œê°„)ì€ ë°€ë¦¬ì´ˆ(ms) ë‹¨ìœ„ì´ë¯€ë¡œ 1000ìœ¼ë¡œ ë‚˜ëˆ ì„œ 'ì´ˆ(Seconds)' ë‹¨ìœ„ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
  const listenedSec = (Date.now() - playStartMs) / 1000;

  // ì‚¬ìš©ìê°€ 5ì´ˆ ì´ìƒ ì²­ì·¨í•˜ì˜€ë‹¤ë©´, ìŠ¤í‚µìœ¼ë¡œ ë³´ì§€ ì•ŠìŒ
  if (listenedSec > 5) return;

  try { // ì„œë²„(ë°±ì—”ë“œ)ì˜ '/api/skip' ì£¼ì†Œë¡œ ë°ì´í„°ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
    await fetch('http://localhost:3001/api/skip', {
      method: 'POST', // ë°ì´í„°ë¥¼ 'ìƒì„±/ì „ì†¡'í•˜ëŠ” ë°©ì‹
      headers: { 'Content-Type': 'application/json' }, // JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³´ëƒ„
      credentials: 'include', // ë¡œê·¸ì¸ ì •ë³´(ì¿ í‚¤ ë“±)ê°€ ìˆë‹¤ë©´ ê°™ì´ ì±™ê²¨ ë³´ëƒ„
      
      body: JSON.stringify({
        trackId: currentTrackId, // ì–´ë–¤ ë…¸ë˜ë¥¼ ë„˜ê²¼ëŠ”ì§€ (ë…¸ë˜ ID)
        seconds: listenedSec,    // ëª‡ ì´ˆ ë“£ê³  ë„˜ê²¼ëŠ”ì§€ (ì²­ì·¨ ì‹œê°„)
      }),
    });

  } catch (err) {
    console.error('skip ê¸°ë¡ ì‹¤íŒ¨:', err); 
    //ë§Œì•½ ì „ì†¡ì— ì‹¤íŒ¨í–ˆì„ ê²½ìš°, ì‚¬ì´íŠ¸ ì´ìš©ì— ë¬¸ì œê°€ ê°€ì§€ ì•Šë„ë¡ ê¸°ë¡ë§Œ í•˜ê³  ë„˜ì–´ê°
  }
}

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ YouTube Iframe API
    window.onYouTubeIframeAPIReady = function () {
      ytPlayer = new YT.Player('player', {
        height:'100%', width:'100%', videoId:'',
        playerVars:{autoplay:0, rel:0, modestbranding:1},
        events:{
          onReady: onReady,
          onStateChange: onStateChange
        }
      });
    };

    async function onReady(){
      renderMoodChips();
      setupMoodChange();

      // URL íŒŒë¼ë¯¸í„°ë¡œ idê°€ ì˜¨ ê²½ìš° ìš°ì„  ì ìš©
      const p = new URLSearchParams(location.search);
      const mood = p.get('mood') || 'calm';
      document.body.setAttribute('data-mood', mood);

      await refreshRecs();

      const idParam = p.get('id');
      if (idParam) {
        // ì¶”ì²œëª©ë¡ê³¼ ë³„ê°œë¡œ ë°”ë¡œ ì„¸íŒ… ì‹œë„ (ë”ë¯¸/ë°±ì—”ë“œ ëª¨ë‘ ëŒ€ì‘)
        const list = (await API.search({ q: '' }).catch(()=>({items: API.list()}))).items || [];
        const t = list.find(x => String(x.id) === idParam) || { id: idParam, title:'', artist:'', thumb:'', source:'YouTube' };
        setNow(t);
      }
    }

    function onStateChange(e){
      if (e.data === YT.PlayerState.ENDED){
        showEndPopup();
      }
    }

    function setupMoodChange(){
      const chips = $('#moodChips');
      chips.addEventListener('click', async (ev)=>{
        const b = ev.target.closest('button[data-mood]');
        if (!b) return;
        document.body.setAttribute('data-mood', b.dataset.mood);
        await refreshRecs();
      });
    }

    function renderMoodChips(){
      const holder = $('#moodChips');
      holder.innerHTML = '';
      MOODS.forEach(m=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'chip';
        b.dataset.mood = m.key;
        b.textContent = m.label;
        holder.appendChild(b);
      });
    function onError(e){ //(e): YouTube APIê°€ ì—ëŸ¬ ì •ë³´ë¥¼ ë‹´ì•„ì„œ ë„˜ê²¨ì£¼ëŠ” ì´ë²¤íŠ¸ ê°ì²´
      console.warn('YouTube player error:', e.data);
      //e.data: YouTubeê°€ ë³´ë‚´ì¤€ êµ¬ì²´ì ì¸ ì—ëŸ¬ ë²ˆí˜¸

      // ì—ëŸ¬ ë²ˆí˜¸ 101ë²ˆê³¼ 150ë²ˆì€ ì†Œìœ ìê°€ í¼ê°€ê¸°(ì„ë² ë“œ)ë¥¼ ë§‰ì•„ë†“ì€ ì˜ìƒ.
      if (e.data === 101 || e.data === 150) { // ì—ëŸ¬ ë²ˆí˜¸ê°€ 101ì´ë‚˜ 150ì¼ ê²½ìš°
        const link = document.getElementById('openOnYT');
        const msg =
          'ì´ ì˜ìƒì€ ìœ íŠœë¸Œì—ì„œ ì™¸ë¶€ ì‚¬ì´íŠ¸ ì¬ìƒì´ ë§‰í˜€ ìˆì–´ì„œ,\n' +
          'ì‚¬ì´íŠ¸ ì•ˆì—ì„œëŠ” ì¬ìƒí•  ìˆ˜ ì—†ì–´ìš”.\n\n' +
          'ìƒˆ íƒ­ì—ì„œ YouTubeë¡œ ë°”ë¡œ ì—´ê¹Œìš”?';

        if (link && link.href && link.href !== '#' && confirm(msg)) {
          // ë§í¬ê°€ ì¡´ì¬í•˜ê³ , ë§í¬ ì£¼ì†Œê°€ ì„ì‹œì£¼ì†Œê°€ ì•„ë‹Œê²½ìš°ë¼ë©´
          window.open(link.href, '_blank');   // ì‚¬ìš©ìê°€ í™•ì¸ì„ ëˆ„ë¥´ë©´ ìƒˆ íƒ­ì—ì„œ ì‹¤í–‰ì‹œí‚´
        }
      }
    }

    async function refreshRecs(){
      const mood = document.body.getAttribute('data-mood') || 'calm';
      let items = [];
      try{
        const r = await API.recs(mood);
        items = r.items || [];
      }catch{
        // í´ë°±: ë¡œì»¬ ë”ë¯¸
        items = API.list();
      }

      const holder = $('#recList');
      holder.innerHTML = '';
      items.forEach(t=>{
        const el = document.createElement('div');
        el.className = 'item';
        const thumb = t.thumb || '';
        el.innerHTML = `
          <img src="${thumb}" alt="thumb"/>
          <div>
            <div class="title">${cleanTitle(t.title || '')}</div>
            <div class="sub">${t.artist || ''} Â· <span class="badge">${t.source || ''}</span></div>
          </div>
        `;
        el.onclick = ()=> setNow(t);
        holder.appendChild(el);
      });

      if (!currentTrack && items[0]) setNow(items[0]);
    }

    function setNow(t){
      currentTrack = t;
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê²€ìƒ‰ ê²°ê³¼ ëª¨ë“œ
    async function initFromSearch() {
      const p = new URLSearchParams(location.search);
      const idParam = p.get('id');

      // lastSearchList ë¶ˆëŸ¬ì˜¤ê¸°
      let list = [];
      try {
        const saved = localStorage.getItem('lastSearchList');
        if (saved) list = JSON.parse(saved) || [];
      } catch (e) {
        console.warn('failed to parse lastSearchList', e);
      }

      if (!Array.isArray(list) || list.length === 0) {
        // í´ë°±: ì¶”ì²œ ëª¨ë“œë¡œ
        mode = 'recs';
        await refreshRecs();
        return;
      }

      // context(ê°ì •/ì¥ë¥´/êµ­ê°€)ë„ ìˆìœ¼ë©´ ë°˜ì˜
      // 1. [ê¸°ì–µ ë˜ì‚´ë¦¬ê¸°] ë¸Œë¼ìš°ì €ì˜ 'ê¸°ì–µ ìƒì(localStorage)'ë¥¼ ë’¤ì ¸ë´…ë‹ˆë‹¤.
      try {
        // "í˜¹ì‹œ 'ë§ˆì§€ë§‰ ê²€ìƒ‰ í™˜ê²½(lastSearchContext)'ì´ë¼ê³  ì ì–´ë‘” ìª½ì§€ ìˆì–´?"
        // -> localStorageëŠ” ë¸Œë¼ìš°ì €ë¥¼ ê»ë‹¤ ì¼œë„ ì§€ì›Œì§€ì§€ ì•ŠëŠ” ì˜êµ¬ ì €ì¥ì†Œì…ë‹ˆë‹¤.
        const ctxStr = localStorage.getItem('lastSearchContext');

        // "ìª½ì§€ê°€ ìˆë‹¤ë©´?"
        if (ctxStr) {
          // ìª½ì§€ì— ì íŒ ê¸€ì(JSON ë¬¸ìì—´)ë¥¼ ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
          const ctx = JSON.parse(ctxStr);

          // ìª½ì§€ì— ì í˜€ìˆë˜ ê¸°ë¶„, ì¥ë¥´, êµ­ê°€ ì„¤ì •ì„ ë‹¤ì‹œ ì ìš©í•©ë‹ˆë‹¤.
          if (ctx.mood)   currentParams.mood   = ctx.mood;
          if (ctx.genre)  currentParams.genre  = ctx.genre;
          if (ctx.nation) currentParams.nation = ctx.nation;

          // ë³µêµ¬ëœ 'ê¸°ë¶„(mood)'ì— ë§ì¶° ì›¹ì‚¬ì´íŠ¸ ë°°ê²½ìƒ‰ ë“±ì„ ì¦‰ì‹œ ë°”ê¿‰ë‹ˆë‹¤.
          document.body.setAttribute('data-mood', currentParams.mood);
        }
      } catch (e) {
        // [ì—ëŸ¬ ì²˜ë¦¬] ìª½ì§€ ë‚´ìš©ì„ í•´ì„í•˜ë‹¤ê°€ ì—ëŸ¬ê°€ ë‚˜ë„(ê¹¨ì§„ ë°ì´í„° ë“±),
        // -> í”„ë¡œê·¸ë¨ì´ ë©ˆì¶”ì§€ ì•Šê²Œ ê²½ê³ ë§Œ ì‚´ì§ ë‚¨ê¸°ê³  ë„˜ì–´ê°‘ë‹ˆë‹¤.
        console.warn('failed to parse lastSearchContext', e);
      }


      // 2. [ì¬ìƒ ìˆœì„œ ì •í•˜ê¸°] ë°›ì•„ì˜¨ ë…¸ë˜ ëª©ë¡(list)ì„ ì¬ìƒí•  ì¤€ë¹„ë¥¼ í•©ë‹ˆë‹¤.

      // (1) [ì¥ì „] ë°›ì•„ì˜¨ ë…¸ë˜ ë¦¬ìŠ¤íŠ¸ë¥¼ í˜„ì¬ ì¬ìƒ ëŒ€ê¸°ì—´(queue)ë¡œ í™•ì •í•©ë‹ˆë‹¤.
      queue = list;

      // (2) [ìœ„ì¹˜ ì°¾ê¸°] "ë‚´ê°€ í‹€ê³  ì‹¶ì€ ê·¸ ë…¸ë˜(idParam)ê°€ ë¦¬ìŠ¤íŠ¸ì˜ ëª‡ ë²ˆì§¸ì— ìˆë‹ˆ?"
      // -> ë¦¬ìŠ¤íŠ¸ë¥¼ ì­‰ í›‘ìœ¼ë©´ì„œ IDê°€ ë˜‘ê°™ì€ ë…€ì„ì„ ì°¾ìŠµë‹ˆë‹¤. (ëª» ì°¾ìœ¼ë©´ -1ì´ ë‚˜ì˜µë‹ˆë‹¤)
      const idx = list.findIndex(x => String(x.id) === String(idParam));

      // (3) [ìˆœì„œ ê²°ì •] â˜…â˜…â˜…
      // -> ì°¾ì•˜ìœ¼ë©´(0ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ìœ¼ë©´) ê·¸ ë²ˆí˜¸(idx)ë¶€í„° í‹€ê³ ,
      // -> ëª» ì°¾ì•˜ìœ¼ë©´(ì—†ëŠ” ë…¸ë˜ë©´) ê·¸ëƒ¥ ë§¨ ì²˜ìŒ(0ë²ˆ) ë…¸ë˜ë¶€í„° í‹€ì–´ë¼.
      queueIndex = idx >= 0 ? idx : 0;

      // 3. [í™”ë©´ ê°±ì‹  & ì¬ìƒ]
      
      // (1) ì œëª©ì„ 'ê²€ìƒ‰ ê²°ê³¼'ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
      $('#sideTitle').textContent = 'ê²€ìƒ‰ ê²°ê³¼';

      // (2) ëŒ€ê¸°ì—´ ëª©ë¡ì„ í™”ë©´ì— ì´¤ë¼ë½ ê·¸ë¦½ë‹ˆë‹¤.
      renderQueueList();

      // (3) ì•„ê¹Œ ì •í•œ ìˆœì„œ(queueIndex)ì˜ ë…¸ë˜ë¥¼ ì¬ìƒí•©ë‹ˆë‹¤!
      setNow(queue[queueIndex]);
    }

    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¬ìƒëª©ë¡ ëª¨ë“œ
    // â˜…â˜…â˜… íŠ¹ì • í”Œë ˆì´ë¦¬ìŠ¤íŠ¸(pid)ë¥¼ ë¡œë”©í•´ì„œ ì¬ìƒ ì¤€ë¹„ë¥¼ í•˜ëŠ” í•¨ìˆ˜
      async function initFromPlaylist(pid) {
        
        // 1. [ì œëª© ì¤€ë¹„] í™”ë©´ ì™¼ìª½ ìœ„ì— ì œëª©(sideTitle)ì„ í‘œì‹œí•  ê³³ì„ ì°¾ìŠµë‹ˆë‹¤.
        const holderTitle = $('#sideTitle');
        
        // 2. [ì„ì‹œ ì œëª©] ë¡œë”©ë˜ëŠ” ë™ì•ˆ ì¼ë‹¨ "ì¬ìƒëª©ë¡"ì´ë¼ê³  ì ì–´ë‘¡ë‹ˆë‹¤.
        if (holderTitle) holderTitle.textContent = 'ì¬ìƒëª©ë¡';

        try {
          // 3. [ë°ì´í„° ê°€ì ¸ì˜¤ê¸°] ì„œë²„ì— "ë‚´ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ëª©ë¡ ì¢€ ë‹¤ ì¤˜ë´"ë¼ê³  ìš”ì²­í•©ë‹ˆë‹¤.
          const { items } = await API.playlists(); 

          // 4. [ì°¾ê¸°] ê°€ì ¸ì˜¨ ëª©ë¡(items) ì¤‘ì—ì„œ ë‚´ê°€ ì›í•˜ëŠ” ë²ˆí˜¸(pid)ë¥¼ ê°€ì§„ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸(pl)ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
          // -> String(...): í˜¹ì‹œ í•˜ë‚˜ëŠ” ìˆ«ìê³  í•˜ë‚˜ëŠ” ë¬¸ìì¼ê¹Œ ë´, ë‘˜ ë‹¤ ë¬¸ìë¡œ ë°”ê¿”ì„œ ì•ˆì „í•˜ê²Œ ë¹„êµí•©ë‹ˆë‹¤.
          const pl = (items || []).find(x => String(x.id) === String(pid));

          // 5. ì‚­ì œëê±°ë‚˜ ì£¼ì†Œê°€ ì˜ëª»ëœ ê²½ìš°
          if (!pl) {
            // -> [í”Œëœ B ê°€ë™] ë‹¹í™©í•˜ì§€ ì•Šê³  ëª¨ë“œë¥¼ 'ì¶”ì²œ(recs)'ìœ¼ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
            mode = 'recs';
            // -> ì¶”ì²œ ë…¸ë˜ë“¤ì„ ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê³  í•¨ìˆ˜ë¥¼ ëëƒ…ë‹ˆë‹¤.
            await refreshRecs();
            return;
          }

          // 6. [ë‚´ìš©ë¬¼ í™•ì¸] í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ëŠ” ì°¾ì•˜ëŠ”ë°, ê·¸ ì•ˆì— ë…¸ë˜(tracks)ê°€ ìˆëŠ”ì§€ ë´…ë‹ˆë‹¤.
          const tracks = pl.items || [];
          
          // 7. "í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ëŠ” ìˆëŠ”ë° ë…¸ë˜ê°€ í•œ ê³¡ë„ ì—†ëŠ”ë°ìš”?"
          if (!tracks.length) {
            // -> [í”Œëœ B ê°€ë™] ì—­ì‹œë‚˜ 'ì¶”ì²œ ëª¨ë“œ'ë¡œ ì „í™˜í•´ì„œ ë‹¤ë¥¸ ë…¸ë˜ë¼ë„ í‹€ì–´ì¤ë‹ˆë‹¤.
            mode = 'recs';
            await refreshRecs();
            return;
          }

          // === ì—¬ê¸°ê¹Œì§€ í†µê³¼í–ˆìœ¼ë©´ ì •ìƒì ì¸ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤! ===

          // 8. [ì¥ì „] ì°¾ì•„ë‚¸ ë…¸ë˜ë“¤(tracks)ì„ í˜„ì¬ ì¬ìƒ ëŒ€ê¸°ì—´(queue)ì— ì§‘ì–´ë„£ìŠµë‹ˆë‹¤.
          queue = tracks;
          
          // 9. [ìˆœì„œ ì´ˆê¸°í™”] ì²« ë²ˆì§¸ ê³¡(0ë²ˆ)ë¶€í„° í‹€ ì¤€ë¹„ë¥¼ í•©ë‹ˆë‹¤.
          queueIndex = 0;

          // 10. [ì œëª© ì—…ë°ì´íŠ¸] ì´ì œ ì§„ì§œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì´ë¦„(pl.title)ì„ í™”ë©´ì— ì˜ˆì˜ê²Œ ì ì–´ì¤ë‹ˆë‹¤.
          // -> ì˜ˆ: "ì¬ìƒëª©ë¡ Â· ë“œë¼ì´ë¸Œ í•  ë•Œ ë“£ëŠ” ë…¸ë˜"
          if (holderTitle) holderTitle.textContent = `ì¬ìƒëª©ë¡ Â· ${pl.title}`;

          // 11. [í™”ë©´ ê·¸ë¦¬ê¸°] ëŒ€ê¸°ì—´ ëª©ë¡ì„ í™”ë©´ì— ì´¤ë¼ë½ ê·¸ë¦½ë‹ˆë‹¤. (ì•„ê¹Œ ë³¸ renderQueueList í•¨ìˆ˜)
          renderQueueList();
          
          // 12. [ì¬ìƒ ì‹œì‘] ëŒ€ê¸°ì—´ì˜ ì²« ë²ˆì§¸ ê³¡(queue[0])ì„ ì¬ìƒí•©ë‹ˆë‹¤.
          setNow(queue[queueIndex]);

        } catch (e) {
          // 13. [ì—ëŸ¬ ì²˜ë¦¬] ì¸í„°ë„·ì´ ëŠê²¼ê±°ë‚˜ ì„œë²„ê°€ ê³ ì¥ ë‚˜ì„œ ìœ„ ê³¼ì • ì¤‘ ë­”ê°€ í„°ì¡Œë‹¤ë©´?
          // -> ì½˜ì†”ì— "ì‹¤íŒ¨í–ˆìŒ"ì´ë¼ê³  ê¸°ë¡ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
          console.warn('initFromPlaylist failed', e);
          
          // -> [í”Œëœ B ê°€ë™] ì—¬ê¸°ì„œë„ í¬ê¸°í•˜ì§€ ì•Šê³  'ì¶”ì²œ ëª¨ë“œ'ë¡œ ì „í™˜í•´ ìŒì•…ì„ í‹€ì–´ì¤ë‹ˆë‹¤.
          mode = 'recs';
          await refreshRecs();
        }
      }

    // í(ê²€ìƒ‰/ì¬ìƒëª©ë¡) ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
      // â˜…â˜…â˜… ëŒ€ê¸°ì—´(ë…¸ë˜ ëª©ë¡)ì„ í™”ë©´ì— ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜
      function renderQueueList() {

        // [ìœ„ì¹˜ ì°¾ê¸°] ë…¸ë˜ ëª©ë¡ì„ ì§‘ì–´ë„£ì„ 'ë°”êµ¬ë‹ˆ(HTML ìš”ì†Œ)'ë¥¼ ì°¾ì•„ì˜µë‹ˆë‹¤.
        const holder = $('#recList');

        // ë°”êµ¬ë‹ˆë¥¼ ê¹¨ë—ì´ ë¹„ì›ë‹ˆë‹¤.
        // -> ì´ê±¸ ì•ˆ í•˜ë©´ ëª©ë¡ì´ ê°±ì‹ ë  ë•Œë§ˆë‹¤ ê¸°ì¡´ ëª©ë¡ ë°‘ì— ë˜ ìŒ“ì—¬ì„œ ë˜‘ê°™ì€ ê²Œ ì—¬ëŸ¬ ê°œ ë‚˜ì˜´
        holder.innerHTML = '';

        // 3. [ë°˜ë³µ ì‘ì—…] ëŒ€ê¸°ì—´(queue)ì— ìˆëŠ” ë…¸ë˜ë“¤ì„ í•˜ë‚˜ì”© êº¼ë‚´ì„œ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.
        // -> t: ë…¸ë˜ í•˜ë‚˜ (track)
        // -> idx: ë²ˆí˜¸í‘œ (0ë²ˆ, 1ë²ˆ, 2ë²ˆ...)
        queue.forEach((t, idx) => {

          // ë…¸ë˜ í•˜ë‚˜ë¥¼ ë‹´ì„ íˆ¬ëª…í•œ ìƒì(div)ë¥¼ ë§Œë“­ë‹ˆë‹¤.
          const el = document.createElement('div');
          
          // CSS ìŠ¤íƒ€ì¼ì„ ì…íˆê¸° ìœ„í•´ 'item'ì´ë¼ëŠ” ì´ë¦„í‘œë¥¼ ë¶™ì…ë‹ˆë‹¤.
          el.className = 'item';

          // ì•¨ë²” í‘œì§€ ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. (ì—†ìœ¼ë©´ ë¹ˆì¹¸)
          const thumb = t.thumb || '';

          // (4) [ë‚´ìš© ì±„ìš°ê¸°] ìƒì ì•ˆì— ë“¤ì–´ê°ˆ HTML(ê·¸ë¦¼, ì œëª©, ê°€ìˆ˜)ì„ í•œ ë²ˆì— ì ì–´ ë„£ìŠµë‹ˆë‹¤.
          // -> ë°±í‹±(`)ì„ ì‚¬ìš©í•˜ë©´ ë³€ìˆ˜(${...})ë¥¼ ì¤‘ê°„ì— ì™ì™ ë¼ì›Œ ë„£ê¸° í¸í•©ë‹ˆë‹¤.
          el.innerHTML = `
            <img src="${thumb}" alt="thumb"/>           <div>
              <div class="title">${cleanTitle(t.title || '')}</div>  <div class="sub">${t.artist || ''} Â· <span class="badge">${t.source || ''}</span></div>
            </div>
          `;

          // ì‚¬ìš©ìê°€ ì´ ìƒì(ë…¸ë˜)ë¥¼ 'í´ë¦­'í–ˆì„ ë•Œ í•  ì¼
          el.onclick = () => {
            queueIndex = idx; // "ì§€ê¸ˆ ìš°ë¦¬ëŠ” 'idx'ë²ˆ ë…¸ë˜ë¥¼ ë“£ëŠ” ì¤‘ì´ì•¼"ë¼ê³  ìˆœì„œë¥¼ ê¸°ì–µí•©ë‹ˆë‹¤.
            setNow(t);        // "ì, ì´ ë…¸ë˜(t)ë¥¼ ì¬ìƒí•´!" (ì•„ê¹Œ ë°°ìš´ í•¨ìˆ˜ í˜¸ì¶œ)
          };

          // ì™„ì„±ëœ ìƒì(el)ë¥¼ ì•„ê¹Œ ë¹„ì›Œë‘” ë°”êµ¬ë‹ˆ(holder)ì— ì§‘ì–´ë„£ìŠµë‹ˆë‹¤.
          holder.appendChild(el);
        });
      }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ í˜„ì¬ ê³¡ ì„¤ì •
    // â˜…â˜…â˜… ì§€ê¸ˆ ì¬ìƒí•  ê³¡ì„ ì„¸íŒ…í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜ ('t'ëŠ” ìƒˆë¡œìš´ ë…¸ë˜ ì •ë³´)
    function setNow(t) {
      
      // "í‹€ì–´ë‹¬ë¼ëŠ” ë…¸ë˜ê°€ ë¹„ì–´ìˆë‚˜ìš”?"
      // -> ë…¸ë˜ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ ëª» í•˜ë‹ˆê¹Œ ê·¸ëƒ¥ ëŒì•„ê°‘ë‹ˆë‹¤.
      if (!t) return;

      // ì´ì „ì— ë“£ë˜ ë…¸ë˜ê°€ ìˆê³  ì§€ê¸ˆ ë‹¤ë¥¸ ë…¸ë˜ë¡œ ë°”ê¾¸ëŠ” ê²½ìš°ë¼ë©´?
      if (currentTrack && currentTrack.id && currentTrack.id !== t.id) {
        // ê·¸ë ‡ë‹¤ë©´ "ë°©ê¸ˆ ë“£ë˜ ë…¸ë˜, 5ì´ˆ ì•ˆì— ë„˜ê¸´ ê±´ì§€ í™•ì¸í•´ë´!"ë¼ê³  ë³´ê³ ì„œë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
        // fire-and-forget: "ë³´ê³ ì„œ ë³´ëƒˆìœ¼ë©´ ê²°ê³¼ ê¸°ë‹¤ë¦¬ì§€ ë§ê³ (await ì—†ì´) ë°”ë¡œ ë‹¤ìŒ ì¼ ì§„í–‰í•´."
        sendSkipIfNeeded();
      }

      // í”Œë ˆì´ì–´ì˜ í˜„ì¬ ìƒíƒœë¥¼ ìƒˆ ë…¸ë˜ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
      currentTrack = t;               // "ì§€ê¸ˆ ê³¡ì€ ì´ê±°ì•¼."
      currentTrackId = t.id || null;  // "IDëŠ” ì´ê±°ê³ ."
      playStartMs = Date.now();       // (ìŠ¤í‚µ íŒë‹¨ìš© ìŠ¤í†±ì›Œì¹˜ ë¦¬ì…‹)

      const vid = getYouTubeId(t); // "ìœ íŠœë¸Œ IDë§Œ ë½‘ì•„ì™€."
      
      // í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ëê³ , IDë„ ìˆë‹¤ë©´ ì˜ìƒì„ í‹€ì–´ë¼!
      if (ytPlayer && ytPlayer.loadVideoById && vid) ytPlayer.loadVideoById(vid);

      // ì›¹ì‚¬ì´íŠ¸ í™”ë©´ì˜ ê¸€ì”¨ì™€ ê·¸ë¦¼ì„ ìƒˆ ë…¸ë˜ ì •ë³´ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
      $('#nowThumb').src = t.thumb || '';           // ì•¨ë²” í‘œì§€ ì‚¬ì§„ ë³€ê²½
      $('#nowTitle').textContent = cleanTitle(t.title || ''); // ë…¸ë˜ ì œëª© ë³€ê²½ (ì§€ì €ë¶„í•œ íŠ¹ìˆ˜ë¬¸ì ì²­ì†Œ)
      
      // ê°€ìˆ˜ ì´ë¦„ Â· ì›ì œ (ì˜ˆ: ì•„ì´ìœ  Â· ë°¤í¸ì§€)
      $('#nowSub').textContent = `${t.artist || ''} Â· ${(t.original_title || t.originalTitle || '')}`;
      $('#nowSource').textContent = t.source || 'YouTube'; // ì¶œì²˜ í‘œì‹œ
      
      // 'ìœ íŠœë¸Œì—ì„œ ë³´ê¸°' ë²„íŠ¼ì˜ ë§í¬ ì£¼ì†Œ ë³€ê²½
      $('#openOnYT').href = t.url || (vid ? `https://www.youtube.com/watch?v=${vid}` : '#');

      // -> ìƒˆ ë…¸ë˜ê°€ ë‚˜ì™”ìœ¼ë‹ˆ, ì´ ë…¸ë˜ì— ë§ëŠ” 'ê¸°ë¶„ íˆ¬í‘œ ë²„íŠ¼'ë“¤ì„ ë‹¤ì‹œ ê·¸ë ¤ì¤ë‹ˆë‹¤.
      renderRateChips();

       // ì‹œì²­ê¸°ë¡ (ë¡œê·¸ì¸ í•„ìš”í•˜ì§€ë§Œ, ë¹„ë¡œê·¸ì¸ì´ë©´ ì•„ë¬´ ì•Œë¦¼ ì—†ì´ ë¬´ì‹œ)
      gate(async () => { await API.watch(t.id); }, { silent: true });
    }

    function renderRateChips(){
      const box = $('#rateMoods');
      box.innerHTML = '';
      MOODS.forEach(m=>{
        const b = document.createElement('button');
        b.className = 'chip';
        b.textContent = m.label;
        b.onclick = ()=> gate(async ()=>{
          await API.rate(currentTrack.id, m.key);
          document.body.setAttribute('data-mood', m.key);
          await refreshRecs();
          alert(`"${m.label}"ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        });
        box.appendChild(b);
      });
    }

    function showEndPopup(){
      const wrap = $('#afterPopup');
      const holder = $('#afterMoods');
      holder.innerHTML = '';
      MOODS.forEach(m=>{
        const b = document.createElement('button');
        b.className = 'chip';
        b.textContent = m.label;
        b.onclick = ()=> gate(async ()=>{
          await API.rate(currentTrack.id, m.key);
          document.body.setAttribute('data-mood', m.key);
          wrap.classList.add('hidden');
          await refreshRecs();
        });
        holder.appendChild(b);
      });
      wrap.classList.remove('hidden');
      $('#closePopup').onclick = ()=> wrap.classList.add('hidden');
    }
      // "ì‚¬ìš©ìê°€ ì´ ë…¸ë˜ë¥¼ ë“£ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤"ë¼ê³  ì„œë²„ì— ê¸°ë¡í•©ë‹ˆë‹¤.
      // -> gate: ì¤‘ë³µ ìš”ì²­ ë°©ì§€
      // -> silent: true (ì¤‘ìš”): "ê¸°ë¡ì— ì‹¤íŒ¨í•´ë„ ì‚¬ìš©ìí•œí…Œ ì—ëŸ¬ ë©”ì‹œì§€ ë„ìš°ì§€ ë§ˆ." (ì¡°ìš©íˆ ì²˜ë¦¬)
      gate(async () => { await API.watch(t.id); }, { silent: true });
    }

  
  // "ì´ ë…¸ë˜ ê¸°ë¶„ì´ ì–´ë•Œìš”?" í‰ê°€ ë²„íŠ¼ë“¤ì„ ë§Œë“¤ì–´ì£¼ëŠ” í•¨ìˆ˜
  function renderRateChips() {

    // ë²„íŠ¼ë“¤ì´ ë“¤ì–´ê°ˆ 'ë²„íŠ¼ ì˜ì—­'ì„ ì°¾ì•„ì˜µë‹ˆë‹¤.
    // -> HTMLì—ì„œ idê°€ 'rateMoods'ì¸ ê³³ì„ ì§€ëª©í•©ë‹ˆë‹¤.
    const box = $('#rateMoods');
    // ë‚¨ì•„ìˆëŠ” ë²„íŠ¼ ì˜ì—­ì„ ë¹„ì›€.
    box.innerHTML = '';
    // ê¸°ë³¸ ê°ì • ëª©ë¡(MOODS)ì— ìˆëŠ” ê²ƒë“¤ì„ í•˜ë‚˜ì”© êº¼ë‚´ì„œ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.
    MOODS.forEach(m => {

      // ë¹„ì–´ìˆëŠ” <button> íƒœê·¸ë¥¼ í•˜ë‚˜ ë§Œë“­ë‹ˆë‹¤.
      const b = document.createElement('button');
      // CSS ì ìš©
      b.className = 'chip rate-chip';
      // ë²„íŠ¼ ìœ„ì— ê°ì •ì„ ì ìŒ. (í™ˆ í™”ë©´ì—ì„œ ë‚˜ì˜¨ ê¸°ë³¸ ê°ì •ë“¤)
      b.textContent = m.label;
      // ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì‘ì—…ì„ ì‹œì‘í•˜ë˜, ì¤‘ë³µí´ë¦­ì€ ë°©ì§€
      b.onclick = () => gate(async () => {

        // "í˜„ì¬ ë…¸ë˜(currentTrack.id)ëŠ” ì´ëŸ° ê¸°ë¶„(m.key)ì´ì•¼"ë¼ê³  ì„œë²„ì— ì „ì†¡í•¨.
        await API.rate(currentTrack.id, m.key);

        // í”„ë¡œê·¸ë¨ ë‚´ë¶€ì—ì„œë„ ê¸°ë¶„(m.key)ì„ ê¸°ë¡.
        currentParams.mood = m.key;

        // ì›¹ì‚¬ì´íŠ¸ ì „ì²´ ë°°ê²½ìƒ‰ ë“±ì„ ì„ íƒí•œ ê¸°ë¶„ì— ë§ì¶° ë°”ê¿ˆ.
        // -> body íƒœê·¸ì— ê¸°ë¶„í‘œ(data-mood)ë¥¼ ë¶™ì—¬ì£¼ë©´ CSSê°€ ì•Œì•„ì„œ ìƒ‰ì„ ë°”ê¿ˆ.
        document.body.setAttribute('data-mood', m.key);

        // ë§Œì•½ ì§€ê¸ˆ 'ì¶”ì²œ ëª¨ë“œ'ë¡œ ë“£ê³  ìˆë‹¤ë©´?
        if (mode === 'recs') {
          // ê¸°ë¶„ì´ ë°”ë€Œì—ˆìœ¼ë‹ˆ ê·¸ ê¸°ë¶„ì— ë§ëŠ” ìƒˆ ë…¸ë˜ë“¤ì„ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°.
          await refreshRecs();
        }

        // ì €ì¥ì´ ì˜ ë˜ì—ˆë‹¤ê³  ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ë„ì›ë‹ˆë‹¤.
        alert(`"${m.label}"ë¡œ ì´ ê³¡ì˜ ê¸°ë¶„ì„ ì €ì¥í–ˆì–´ìš”.`);
      });

      box.appendChild(b);
    });
  }


  // ì¬ìƒì´ ëë‚¬ì„ë•Œ "ë…¸ë˜ ì–´ë• ë‚˜ìš”?" ë¬»ëŠ” íŒì—…ì°½ì„ ë„ìš°ëŠ” í•¨ìˆ˜
  function showEndPopup() {

    // íŒì—…ì°½ ì „ì²´ ê»ë°ê¸°(wrap)ë¥¼ ì°¾ì•„ì˜µë‹ˆë‹¤. (í‰ì†Œì—” ìˆ¨ê²¨ì ¸ ìˆìŒ)
    const wrap = $('#afterPopup');

    // íŒì—…ì°½ ì•ˆì—ì„œ ë²„íŠ¼ë“¤ì„ ë‹´ì„ ì˜ì—­(holder)ì„ ì°¾ìŠµë‹ˆë‹¤.
    const holder = $('#afterMoods');

    // ë²„ë“  ì˜ì—­ë¥¼ ê¹¨ë—ì´ ë¹„ì›ë‹ˆë‹¤. (ì´ì „ ë°ì´í„° ì œê±°)
    holder.innerHTML = '';

    // ê¸°ë¶„ ëª©ë¡(MOODS)ë§Œí¼ ë²„íŠ¼ì„ ì°ì–´ëƒ…ë‹ˆë‹¤.
    MOODS.forEach(m => {
      // ë²„íŠ¼ íƒœê·¸ ìƒì„±
      const b = document.createElement('button');
      
      // CSS ì…íˆê¸°
      b.className = 'chip rate-chip';
      
      // ë²„íŠ¼ ì´ë¦„ ì ê¸° (í™ˆ í™”ë©´ì—ì„œ ë‚˜ì˜¨ ê¸°ë³¸ ê°ì • 5ê°œ)
      b.textContent = m.label;

      // ë²„íŠ¼ í´ë¦­ ì‹œ í–‰ë™ ì •ì˜
      // -> gate(...)ëŠ” ì¤‘ë³µ í´ë¦­ ë°©ì§€ìš© ë¬¸ì§€ê¸°ì…ë‹ˆë‹¤.
      b.onclick = () => gate(async () => {
        
        // "ì´ ë…¸ë˜ëŠ” ì´ ê¸°ë¶„ì´ì—ìš”"ë¼ê³  ì„œë²„ì— ê¸°ë¡
        await API.rate(currentTrack.id, m.key);
        // í˜„ì¬ ê¸°ë¶„ ì„¤ì •ì„ ì¶”ì²œ ê²°ê³¼ë¡œ ìƒˆë¡­ê²Œ ì—…ë°ì´íŠ¸
        currentParams.mood = m.key;
        // ì›¹ì‚¬ì´íŠ¸ ë°°ê²½ìƒ‰ ë“±ì„ í•´ë‹¹ ê¸°ë¶„ì— ë§ì¶° ë³€ê²½
        document.body.setAttribute('data-mood', m.key);
        //  íˆ¬í‘œë¥¼ ë§ˆì³¤ìœ¼ë‹ˆ 'hidden'ì„ ë¶™ì—¬ íŒì—…ì°½ì„ ë‹¤ì‹œ ìˆ¨ê¹€
        wrap.classList.add('hidden');
        // ì¶”ì²œ ëª¨ë“œë¼ë©´, ë°”ë€ ê¸°ë¶„ì— ë§ì¶° ìƒˆ ë…¸ë˜ë“¤ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
        if (mode === 'recs') {
          await refreshRecs();
        }
      });

      // ë‹¤ ë§Œë“  ë²„íŠ¼ì„ ë²„íŠ¼ ì˜ì—­ì— ë„£ìŠµë‹ˆë‹¤.
      holder.appendChild(b);
    });

    // -> 'hidden'ì„ ì œê±°í•´ íŒì—…ì°½ì„ í™”ë©´ì— ë‚˜íƒ€ë‚˜ê²Œ í•¨
    wrap.classList.remove('hidden');

    // íˆ¬í‘œë¥¼ í•˜ê¸° ì‹«ì–´ì„œ ë‹«ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, ë‹¤ì‹œ 'hidden'ì„ ë¶™ì—¬ì„œ ìˆ¨ê¹€.
    $('#closePopup').onclick = () => wrap.classList.add('hidden');
  }

    // ë²„íŠ¼ë“¤
    $('#playBtn').onclick = ()=>{ try{ ytPlayer.playVideo(); }catch{} };
    $('#pauseBtn').onclick = ()=>{ try{ ytPlayer.pauseVideo(); }catch{} };
    $('#addToPlaylistBtn').onclick = ()=> gate(async ()=>{
      if (!currentTrack) return;
      let { items } = await API.playlists().catch(()=>({items:[]}));
      // ì—†ìœ¼ë©´ í•˜ë‚˜ ìƒì„±
      if (!items || !items[0]) {
        const created = await API.createPlaylist({ title:'ë‚´ ì¬ìƒëª©ë¡', isPublic:false });
        items = [{ id: created.id, title:'ë‚´ ì¬ìƒëª©ë¡' }];
      }
      await API.addToPlaylist({ playlistId: items[0].id, trackId: currentTrack.id, position: 0 });
      alert('ì¬ìƒëª©ë¡ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.');
    });

    $('#moreRecsBtn').onclick = ()=>{
      const mood = document.body.getAttribute('data-mood') || '';
      location.href = `./search.html?mood=${encodeURIComponent(mood)}`;
    };
  </script>
</body>
</html>
