<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Emotion Playlist Â· Player</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
  <style>
    .iframe-wrap{ position:relative; padding-top:56.25%; background:#000; }
    .iframe-wrap > #player{ position:absolute; inset:0; }
  </style>
</head>
<body data-mood="calm">
  <header class="topbar">
    <div class="brand">ğŸ§ ê°ìƒ</div>
    <nav class="nav">
      <a href="./home.html" class="btn">í™ˆ</a>
      <a href="./search.html" class="btn">ê²€ìƒ‰</a>
      <a href="./playlist.html" class="btn">ì¬ìƒëª©ë¡</a>
      <a href="./login.html" id="loginLink" class="btn">ë¡œê·¸ì¸</a>
      <span id="userBadge" class="badge hidden"></span>
      <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
    </nav>
  </header>

  <main class="grid">
    <!-- ë©”ì¸ í”Œë ˆì´ì–´ ì˜ì—­ -->
    <section class="panel">
      <div class="iframe-wrap">
        <div id="player"></div>
      </div>

      <div class="controls">
        <button id="playBtn" class="btn primary">ì¬ìƒ</button>
        <button id="pauseBtn" class="btn">ì¼ì‹œì •ì§€</button>
        <button id="addToPlaylistBtn" class="btn">ì¬ìƒëª©ë¡ì— ì¶”ê°€</button>
        <a id="openOnYT" class="btn" target="_blank" rel="noopener">YouTubeì—ì„œ ì—´ê¸°</a>
      </div>

      <div class="meta">
        <img id="nowThumb" alt="thumb"/>
        <div>
          <div id="nowTitle" class="title">ê³¡ì„ ì„ íƒí•˜ì„¸ìš”</div>
          <div id="nowSub" class="sub">ì•„í‹°ìŠ¤íŠ¸ Â· ì›ë³¸ ì œëª©</div>
        </div>
        <span id="nowSource" class="badge">â€“</span>
      </div>

      <!-- ì´ ê³¡ì— ëŒ€í•œ ê°ì • í‰ê°€ ì˜ì—­ -->
      <div class="rating-block" style="margin-top:10px">
        <div class="sub">
          ì´ ê³¡ì˜ ë¶„ìœ„ê¸°ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”!
          <span style="opacity:.75;font-size:0.9em;">(ë‚´ ì¶”ì²œì— ë°˜ì˜ë¼ìš”)</span>
        </div>
        <div class="moods" id="rateMoods" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- ì˜¤ë¥¸ìª½ ë¦¬ìŠ¤íŠ¸: ì¶”ì²œ / ê²€ìƒ‰ ê²°ê³¼ / ì¬ìƒëª©ë¡ ê³¡ -->
    <aside class="panel">
      <div class="sub" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <span id="sideTitle">ì¶”ì²œ</span>
      </div>
      <div id="recList" class="list"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px">
        <a id="moreRecsBtn" class="btn">ë‹¤ë¥¸ ê³¡ë„ ì¶”ì²œë°›ê¸° â†’</a>
      </div>
    </aside>
  </main>

  <!-- ì¬ìƒ ì¢…ë£Œ í›„ íŒì—… -->
  <div id="afterPopup" class="modal hidden">
    <div class="box">
      <div class="title" style="margin-bottom:8px">
        ì´ ê³¡ì„ ë“£ê³  ë‚œ ì§€ê¸ˆ ê¸°ë¶„ì€?
      </div>
      <div class="sub" style="margin-bottom:8px">
        ì„ íƒí•œ ê°ì •ì´ ì•ìœ¼ë¡œ ì¶”ì²œì— ì‚¬ìš©ë¼ìš”.
      </div>
      <div id="afterMoods" class="moods"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <a class="btn" href="./home.html">ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ë‹¤ì‹œ í•˜ê¸°</a>
        <button id="closePopup" class="btn primary">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ìˆœì„œ ì¤‘ìš”: API(IIFE) â†’ auth í—¤ë” â†’ YouTube API â†’ í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="./assets/api.js"></script>
  <script src="./assets/auth.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìœ í‹¸ & ìƒíƒœ
    const $ = (s) => document.querySelector(s);
    const MOODS = API.MOODS;

    const urlParams     = new URLSearchParams(location.search);
    const initialMood   = urlParams.get('mood')   || 'calm';
    const initialGenre  = urlParams.get('genre')  || '';
    const initialNation = urlParams.get('nation') || '';
    const initialSub    = urlParams.get('sub')    || '';
    const initialTone   = urlParams.get('tone')   || '';
    const fromParam     = urlParams.get('from')   || '';
    const playlistIdParam = urlParams.get('playlistId') || urlParams.get('id') || '';

    // bodyì— ê¸°ë³¸ mood ì ìš©
    document.body.setAttribute('data-mood', initialMood);

    // ëª¨ë“œ: recs / search / playlist
    let mode = 'recs';
    let ytPlayer = null;
    let currentTrack = null;
    let currentParams = {
      mood: initialMood,
      genre: initialGenre,
      nation: initialNation,
      sub: initialSub,
      tone:   initialTone,
    };

    // í(ê²€ìƒ‰ ê²°ê³¼ë‚˜ ì¬ìƒëª©ë¡ ê³¡ë“¤)
    let queue = [];
    let queueIndex = -1;

    // â˜…â˜…â˜… ìŠ¤í‚µ íŒë‹¨ìš© ì „ì—­ ìƒíƒœ
    let currentTrackId = null;  // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ íŠ¸ë™ id
    let playStartMs    = null;  // ì´ íŠ¸ë™ì„ ì¬ìƒí•˜ê¸° ì‹œì‘í•œ ì‹œê°(ms)

    // ë¡œê·¸ì¸ í•„ìš”í•œ ë™ì‘ ê°ì‹¸ê¸°
    async function gate(fn, { silent = false } = {}) {
      try {
        const { user } = await API.me();
        if (!user) {
          if (!silent) {
            alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
          }
          return;
        }
        await fn();
      } catch (e) {
        console.warn(e);
      }
    }

    const cleanTitle = (s) => (s || '')
      .replace(/\s*\([^\)]*\)|\s*\[[^\]]*\]/g, '')
      .replace(/\s{2,}/g, ' ')
      .trim();

    // YouTube ID ì¶”ì¶œ: "youtube:ID" ë˜ëŠ” URLì—ì„œ v= ì¶”ì¶œ
    function getYouTubeId(track) {
      if (!track) return '';
      if (typeof track.id === 'string' && track.id.startsWith('youtube:')) {
        return track.id.split(':')[1];
      }
      const url = track.url || track.source || track.original_title || '';
      const m = /(?:v=|be\/)([\w-]{6,})/i.exec(url);
      return m ? m[1] : '';
    }

    // â˜…â˜…â˜… 5ì´ˆ ì´í•˜ ìŠ¤í‚µì‹œ /api/skip í˜¸ì¶œ
    async function sendSkipIfNeeded() {
      // ì•„ì§ ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ì—†ê±°ë‚˜, ì‹œì‘ ì‹œê°„ì´ ì—†ìœ¼ë©´ íŒ¨ìŠ¤
      if (!currentTrackId || playStartMs == null) return;

      const listenedSec = (Date.now() - playStartMs) / 1000;
      // 5ì´ˆ ì´ˆê³¼ë©´ "ì •ìƒ ì²­ì·¨"ë¡œ ë³´ê³  ìŠ¤í‚µ X
      if (listenedSec > 5) return;

      try {
        await fetch('http://localhost:3001/api/skip', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            trackId: currentTrackId,
            seconds: listenedSec,
          }),
        });
      } catch (err) {
        console.error('skip ê¸°ë¡ ì‹¤íŒ¨:', err);
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ YouTube Iframe API
    window.onYouTubeIframeAPIReady = function () {
      ytPlayer = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: '',
        playerVars: { autoplay: 0, rel: 0, modestbranding: 1 },
        events: {
          onReady: onReady,
          onStateChange: onStateChange,
          onError: onError
        }
      });
    };

    async function onReady() {

      currentParams = {
        mood:   initialMood,
        genre:  initialGenre,
        nation: initialNation,
        sub:    initialSub,
        tone:   initialTone,
      };

      // body mood ì—…ë°ì´íŠ¸
      document.body.setAttribute('data-mood', currentParams.mood);

      const from = fromParam;
      const pid  = playlistIdParam;

      if (pid) {
        // ì¬ìƒëª©ë¡ì—ì„œ ì§„ì…
        mode = 'playlist';
        await initFromPlaylist(pid);

      } else if (from === 'search') {
        // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì§„ì…
        mode = 'search';
        await initFromSearch();

      } else {
        // ê¸°ë³¸ ì¶”ì²œ ëª¨ë“œ
        mode = 'recs';
        await refreshRecs();
      }
    }


    function onStateChange(e) {
      if (e.data === YT.PlayerState.ENDED) {
        showEndPopup();
      }
    }

    function onError(e){
      console.warn('YouTube player error:', e.data);

      // ìœ íŠœë¸Œ ì •ì±… ë•Œë¬¸ì— ì„ë² ë“œê°€ ë§‰íŒ ê²½ìš° ì½”ë“œ 101, 150
      if (e.data === 101 || e.data === 150) {
        const link = document.getElementById('openOnYT');
        const msg =
          'ì´ ì˜ìƒì€ ìœ íŠœë¸Œì—ì„œ ì™¸ë¶€ ì‚¬ì´íŠ¸ ì¬ìƒì´ ë§‰í˜€ ìˆì–´ì„œ,\n' +
          'ì‚¬ì´íŠ¸ ì•ˆì—ì„œëŠ” ì¬ìƒí•  ìˆ˜ ì—†ì–´ìš”.\n\n' +
          'ìƒˆ íƒ­ì—ì„œ YouTubeë¡œ ë°”ë¡œ ì—´ê¹Œìš”?';

        if (link && link.href && link.href !== '#' && confirm(msg)) {
          window.open(link.href, '_blank');   // ì‚¬ìš©ìê°€ ì›í•  ë•Œë§Œ ì´ë™
        }
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¶”ì²œ ëª¨ë“œ: ê°ì • ê¸°ë°˜ ì¶”ì²œ
    async function refreshRecs(){
      const { mood, genre, nation, sub, tone } = currentParams;
      let items = [];
      try{
        const r = await API.recs({ mood, genre, nation, sub, tone });
        items = r.items || [];
      }catch{
        items = API.list();
      }

      const holder = $('#recList');
      holder.innerHTML = '';
      $('#sideTitle').textContent = 'ì¶”ì²œ';

      items.forEach(t=>{
        const el = document.createElement('div');
        el.className = 'item';
        const thumb = t.thumb || '';
        el.innerHTML = `
          <img src="${thumb}" alt="thumb"/>
          <div>
            <div class="title">${cleanTitle(t.title || '')}</div>
            <div class="sub">${t.artist || ''} Â· <span class="badge">${t.source || ''}</span></div>
          </div>
        `;
        el.onclick = ()=> setNow(t);
        holder.appendChild(el);
      });

      if (!currentTrack && items[0]) setNow(items[0]);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê²€ìƒ‰ ê²°ê³¼ ëª¨ë“œ
    async function initFromSearch() {
      const p = new URLSearchParams(location.search);
      const idParam = p.get('id');

      // lastSearchList ë¶ˆëŸ¬ì˜¤ê¸°
      let list = [];
      try {
        const saved = localStorage.getItem('lastSearchList');
        if (saved) list = JSON.parse(saved) || [];
      } catch (e) {
        console.warn('failed to parse lastSearchList', e);
      }

      if (!Array.isArray(list) || list.length === 0) {
        // í´ë°±: ì¶”ì²œ ëª¨ë“œë¡œ
        mode = 'recs';
        await refreshRecs();
        return;
      }

      // context(ê°ì •/ì¥ë¥´/êµ­ê°€)ë„ ìˆìœ¼ë©´ ë°˜ì˜
      try {
        const ctxStr = localStorage.getItem('lastSearchContext');
        if (ctxStr) {
          const ctx = JSON.parse(ctxStr);
          if (ctx.mood)   currentParams.mood   = ctx.mood;
          if (ctx.genre)  currentParams.genre  = ctx.genre;
          if (ctx.nation) currentParams.nation = ctx.nation;
          document.body.setAttribute('data-mood', currentParams.mood);
        }
      } catch (e) {
        console.warn('failed to parse lastSearchContext', e);
      }

      queue = list;
      const idx = list.findIndex(x => String(x.id) === String(idParam));
      queueIndex = idx >= 0 ? idx : 0;

      $('#sideTitle').textContent = 'ê²€ìƒ‰ ê²°ê³¼';
      renderQueueList();
      setNow(queue[queueIndex]);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¬ìƒëª©ë¡ ëª¨ë“œ
    async function initFromPlaylist(pid) {
      const holderTitle = $('#sideTitle');
      if (holderTitle) holderTitle.textContent = 'ì¬ìƒëª©ë¡';

      try {
        const { items } = await API.playlists(); // ë‚´ ì¬ìƒëª©ë¡ë“¤ë§Œ
        const pl = (items || []).find(x => String(x.id) === String(pid));

        if (!pl) {
          // ëª» ì°¾ìœ¼ë©´ ê·¸ëƒ¥ ì¶”ì²œ ëª¨ë“œ
          mode = 'recs';
          await refreshRecs();
          return;
        }

        const tracks = pl.items || [];
        if (!tracks.length) {
          mode = 'recs';
          await refreshRecs();
          return;
        }

        queue = tracks;
        queueIndex = 0;

        if (holderTitle) holderTitle.textContent = `ì¬ìƒëª©ë¡ Â· ${pl.title}`;

        renderQueueList();
        setNow(queue[queueIndex]);
      } catch (e) {
        console.warn('initFromPlaylist failed', e);
        mode = 'recs';
        await refreshRecs();
      }
    }

    // í(ê²€ìƒ‰/ì¬ìƒëª©ë¡) ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderQueueList() {
      const holder = $('#recList');
      holder.innerHTML = '';

      queue.forEach((t, idx) => {
        const el = document.createElement('div');
        el.className = 'item';
        const thumb = t.thumb || '';
        el.innerHTML = `
          <img src="${thumb}" alt="thumb"/>
          <div>
            <div class="title">${cleanTitle(t.title || '')}</div>
            <div class="sub">${t.artist || ''} Â· <span class="badge">${t.source || ''}</span></div>
          </div>
        `;
        el.onclick = () => {
          queueIndex = idx;
          setNow(t);
        };
        holder.appendChild(el);
      });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ í˜„ì¬ ê³¡ ì„¤ì •
    function setNow(t) {
      if (!t) return;

      // â˜…â˜…â˜… ì´ì „ ê³¡ì´ ìˆê³ , ë‹¤ë¥¸ ê³¡ìœ¼ë¡œ ë°”ê¾¸ëŠ” ê²½ìš°ë§Œ ìŠ¤í‚µ ì²´í¬
      if (currentTrack && currentTrack.id && currentTrack.id !== t.id) {
        // fire-and-forget (await ì•ˆ í•´ë„ ë¨)
        sendSkipIfNeeded();
      }

      currentTrack = t;
      currentTrackId = t.id || null;
      playStartMs = Date.now();  // ìƒˆ ê³¡ ì¬ìƒ ì‹œì‘ ì‹œê° ê¸°ë¡

      const vid = getYouTubeId(t);
      if (ytPlayer && ytPlayer.loadVideoById && vid) ytPlayer.loadVideoById(vid);

      $('#nowThumb').src = t.thumb || '';
      $('#nowTitle').textContent = cleanTitle(t.title || '');
      $('#nowSub').textContent = `${t.artist || ''} Â· ${(t.original_title || t.originalTitle || '')}`;
      $('#nowSource').textContent = t.source || 'YouTube';
      $('#openOnYT').href = t.url || (vid ? `https://www.youtube.com/watch?v=${vid}` : '#');

      renderRateChips();

      // ì‹œì²­ê¸°ë¡ (ë¹„ë¡œê·¸ì¸ì€ ì¡°ìš©íˆ ë¬´ì‹œ)
      gate(async () => { await API.watch(t.id); }, { silent: true });
    }

    // ì´ ê³¡ì— ëŒ€í•œ ê°ì • í‰ê°€ ë²„íŠ¼ë“¤
    function renderRateChips() {
      const box = $('#rateMoods');
      box.innerHTML = '';
      MOODS.forEach(m => {
        const b = document.createElement('button');
        b.className = 'chip rate-chip';
        b.textContent = m.label;
        b.onclick = () => gate(async () => {
          await API.rate(currentTrack.id, m.key);
          currentParams.mood = m.key;                  // í˜„ì¬ mood ë³€ê²½
          document.body.setAttribute('data-mood', m.key);
          // ì¶”ì²œ ëª¨ë“œì¼ ë•Œë§Œ ì¶”ì²œ ê°±ì‹ 
          if (mode === 'recs') {
            await refreshRecs();
          }
          alert(`"${m.label}"ë¡œ ì´ ê³¡ì˜ ê¸°ë¶„ì„ ì €ì¥í–ˆì–´ìš”.`);
        });
        box.appendChild(b);
      });
    }

    // ì¬ìƒ ëë‚¬ì„ ë•Œ íŒì—…
    function showEndPopup() {
      const wrap = $('#afterPopup');
      const holder = $('#afterMoods');
      holder.innerHTML = '';
      MOODS.forEach(m => {
        const b = document.createElement('button');
        b.className = 'chip rate-chip';
        b.textContent = m.label;
        b.onclick = () => gate(async () => {
          await API.rate(currentTrack.id, m.key);
          currentParams.mood = m.key;
          document.body.setAttribute('data-mood', m.key);
          wrap.classList.add('hidden');
          if (mode === 'recs') {
            await refreshRecs();
          }
        });
        holder.appendChild(b);
      });
      wrap.classList.remove('hidden');
      $('#closePopup').onclick = () => wrap.classList.add('hidden');
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë²„íŠ¼ë“¤
    $('#playBtn').onclick = () => { try { ytPlayer.playVideo(); } catch { } };
    $('#pauseBtn').onclick = () => { try { ytPlayer.pauseVideo(); } catch { } };

    $('#addToPlaylistBtn').onclick = () => gate(async () => {
      if (!currentTrack) return;
      let { items } = await API.playlists().catch(() => ({ items: [] }));
      // ì—†ìœ¼ë©´ í•˜ë‚˜ ìƒì„±
      if (!items || !items[0]) {
        const created = await API.createPlaylist({ title: 'ë‚´ ì¬ìƒëª©ë¡', isPublic: false });
        items = [{ id: created.id, title: 'ë‚´ ì¬ìƒëª©ë¡' }];
      }
      await API.addToPlaylist({
        playlistId: items[0].id,
        trackId: currentTrack.id,
        position: 0
      });
      alert('ì¬ìƒëª©ë¡ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.');
    });

    $('#moreRecsBtn').onclick = ()=> {
      const { mood, genre, nation, tone, sub } = currentParams;
      const sp = new URLSearchParams();
      if (mood)  sp.set('mood',  mood);
      if (genre) sp.set('genre', genre);
      if (nation)sp.set('nation',nation);
      if (tone)  sp.set('tone',  tone);  
      if (sub)   sp.set('sub',   sub);  
      location.href = `./search.html?${sp.toString()}`;
    };
  </script>
</body>
</html>
