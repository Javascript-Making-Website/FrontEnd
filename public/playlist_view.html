<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Emotion Playlist Â· Playlist</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
  <style>
    #headerSection{
      border-radius:18px;
      overflow:hidden;
      /* ê¸°ë³¸ íŒ¨ë„ ì»¬ëŸ¬ë§Œ ì‚¬ìš© (styles.css ìª½ ë³€ìˆ˜) */
      background: var(--panel, rgba(15,23,42,0.98));
      border:1px solid rgba(148,163,184,0.25);
      transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease;
    }
    #headerSection.theme-colored{
      box-shadow:0 22px 60px rgba(0,0,0,.75);
    }

    .plv-wrap {
      display:flex;
      flex-direction:column;
      gap:16px;
      padding:16px;
    }
    .plv-header {
      display:flex;
      gap:20px;
      align-items:flex-end;
    }
    .plv-cover {
      width:180px;
      height:180px;
      border-radius:16px;
      background:#020617;
      overflow:hidden;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      grid-template-rows:repeat(2,1fr);
      gap:2px;
      flex-shrink:0;
    }
    .plv-cover img {
      width:100%;height:100%;object-fit:cover;
    }
    .plv-title {
      font-size:28px;
      font-weight:700;
      margin-bottom:4px;
    }
    .plv-sub {
      font-size:13px;
      opacity:.7;
    }
    .plv-controls {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
      align-items:center;
    }
    .plv-track-row {
      display:grid;
      grid-template-columns:24px minmax(0,1fr) 80px;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
    }
    .plv-track-row:hover {
      background:rgba(148,163,184,.10);
    }
    .plv-track-main {
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .plv-track-main img {
      width:44px;height:44px;border-radius:8px;object-fit:cover;flex-shrink:0;
    }
    .plv-track-title {
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .plv-track-sub {
      font-size:12px;
      opacity:.7;
    }
    /* ì¬ìƒëª©ë¡ ì‚­ì œ ë²„íŠ¼(ìœ„í—˜ ë²„íŠ¼) ìŠ¤íƒ€ì¼ */
    .btn-danger {
      background:#d14343;
    }
    .btn-danger:hover {
      background:#e25555;
    }

    /* ğŸ¨ í…Œë§ˆ ìƒ‰ ë³€ê²½ UI */
    .theme-color-wrap{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
    }
    .theme-color-wrap input[type="color"]{
      width:28px;
      height:28px;
      border-radius:50%;
      border:none;
      padding:0;
      background:transparent;
      cursor:pointer;
    }
  </style>
</head>
<body data-mood="calm">
<header class="topbar">
  <div class="brand">ğŸ“‚ ì¬ìƒëª©ë¡</div>
  <nav class="nav">
    <a href="./home.html" class="btn">í™ˆ</a>
    <a href="./search.html" class="btn">ê²€ìƒ‰</a>
    <a href="./playlist.html" class="btn">ì¬ìƒëª©ë¡</a>
    <a href="./login.html" id="loginLink" class="btn">ë¡œê·¸ì¸</a>
    <span id="userBadge" class="badge hidden"></span>
    <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </nav>
</header>

<main class="plv-wrap">
  <section id="headerSection" class="panel">
    <!-- JSì—ì„œ ì±„ì›€ -->
  </section>

  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <div class="sub">íŠ¸ë™ ëª©ë¡</div>
      <button id="goAddFromSearch" class="btn">ê³¡ ì¶”ê°€í•˜ê¸° (ê²€ìƒ‰ìœ¼ë¡œ ì´ë™)</button>
    </div>
    <div id="trackList">
      <!-- JSì—ì„œ íŠ¸ë™ ë Œë”ë§ -->
    </div>
  </section>
</main>

<script src="./assets/api.js"></script>
<script src="./assets/auth.js"></script>
<script>
  const $ = (s) => document.querySelector(s);
  const searchParams = new URLSearchParams(location.search);
  const playlistId = searchParams.get('id');

  if (!playlistId) {
    alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
    location.href = './playlist.html';
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìƒ‰ ìœ í‹¸: hex â†” rgb, ìƒ‰ ì„ê¸°, css ì¶œë ¥
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function hexToRgb(hex) {
    if (!hex) return { r: 255, g: 255, b: 255 };
    let c = hex.replace('#', '').trim();
    if (c.length === 3) {
      c = c.split('').map(ch => ch + ch).join('');
    }
    const num = parseInt(c, 16);
    return {
      r: (num >> 16) & 255,
      g: (num >> 8) & 255,
      b: num & 255,
    };
  }

  function rgbToCss({ r, g, b }, alpha) {
    if (typeof alpha === 'number') {
      return `rgba(${r},${g},${b},${alpha})`;
    }
    return `rgb(${r},${g},${b})`;
  }

  // base(ì–´ë‘ìš´ ê¸°ë³¸ìƒ‰)ê³¼ accent(í…Œë§ˆìƒ‰)ë¥¼ ì„ì–´ì„œ ê³„ì¡° ë§Œë“¤ê¸°
  // ratio: 0 = base, 1 = accent
  function mixColor(base, accent, ratio) {
    const t = Math.max(0, Math.min(1, ratio));
    return {
      r: Math.round(base.r + (accent.r - base.r) * t),
      g: Math.round(base.g + (accent.g - base.g) * t),
      b: Math.round(base.b + (accent.b - base.b) * t),
    };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ í…Œë§ˆë¥¼ í˜ì´ì§€ ì „ì²´ì— ì ìš©
  // (í™ˆ í™”ë©´ mood í…Œë§ˆì²˜ëŸ¼: ë°°ê²½ + ì¹´ë“œ + ë²„íŠ¼ ì„¸íŠ¸)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyPlaylistTheme(themeHex) {
    const accent = hexToRgb(themeHex || '#22d3ee');

    // ì‚¬ì´íŠ¸ ê¸°ë³¸ ì–´ë‘ìš´ ë² ì´ìŠ¤(ë„¤ì´ë¹„ ê³„ì—´ ëŠë‚Œ)
    const base = { r: 3, g: 7, b: 18 };

    // í˜ì´ì§€ ì „ì²´ ë°°ê²½, íŒ¨ë„, í—¤ë”ìš© í†¤ ë§Œë“¤ê¸°
    const pageBg   = mixColor(base, accent, 0.28); // ì œì¼ ì–´ë‘ìš´ í†¤
    const panelBg  = mixColor(base, accent, 0.40); // ì¹´ë“œ / íŒ¨ë„ ë°°ê²½
    const headerBg = mixColor(base, accent, 0.52); // ìœ„ í° í—¤ë” íŒ¨ë„
    const border   = mixColor(base, accent, 0.70); // í…Œë‘ë¦¬
    const accentSoft = mixColor(accent, { r: 255, g: 255, b: 255 }, 0.18);

    // 1) body ë°°ê²½
    document.body.style.background = rgbToCss(pageBg);

    // 2) ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°”
    const topbar = document.querySelector('.topbar');
    if (topbar) {
      topbar.style.background = rgbToCss(panelBg);
      topbar.style.borderBottom = `1px solid ${rgbToCss(border, 0.7)}`;
      topbar.style.boxShadow = `0 10px 30px ${rgbToCss(base, 0.85)}`;
    }

    // 3) íŒ¨ë„(ì¹´ë“œ)ë“¤ ë°°ê²½ + í…Œë‘ë¦¬
    document.querySelectorAll('.panel').forEach(panel => {
      if (panel.id === 'headerSection') {
        panel.style.background = rgbToCss(headerBg);
      } else {
        panel.style.background = rgbToCss(panelBg);
      }
      panel.style.border = `1px solid ${rgbToCss(border, 0.55)}`;
      panel.style.boxShadow = `0 20px 50px ${rgbToCss(accent, 0.35)}`;
    });

    // 4) ì „ì—­ CSS ë³€ìˆ˜ë„ ê°™ì´ ë°”ê¾¸ê¸°
    //    (ë²„íŠ¼, ë°°ì§€ ë“± styles.cssì—ì„œ --accent, --cardë¥¼ ì“°ê³  ìˆì„ ê±°ë¼ì„œ)
    const rootStyle = document.documentElement.style;
    rootStyle.setProperty('--bg', rgbToCss(pageBg));
    rootStyle.setProperty('--bg-soft', rgbToCss(panelBg));
    rootStyle.setProperty('--card', rgbToCss(panelBg));
    rootStyle.setProperty('--accent', rgbToCss(accent));
    rootStyle.setProperty('--accent-soft', rgbToCss(accentSoft));
    rootStyle.setProperty('--border-subtle', rgbToCss(border, 0.55));


    // 5) ë²„íŠ¼ ìƒ‰ í…Œë§ˆì— ë§ê²Œ ì¡°ì •

    // (1) ê¸°ë³¸ ë²„íŠ¼ë“¤ - ìœ„í—˜ ë²„íŠ¼(.btn-danger) ë§ê³  ì „ë¶€
    document.querySelectorAll('.btn:not(.btn-danger)').forEach(btn => {
      btn.style.background = rgbToCss(panelBg);
      btn.style.borderColor = rgbToCss(border, 0.7);
      btn.style.boxShadow = `0 4px 12px ${rgbToCss(accent, 0.3)}`;
    });

    // (2) ì£¼ìš” ë²„íŠ¼(ì „ì²´ ì¬ìƒ ê°™ì€ primary / play ë²„íŠ¼)ì€ í…Œë§ˆìƒ‰ìœ¼ë¡œ
    document.querySelectorAll('.btn.primary, .btn[data-role="play"]').forEach(btn => {
      btn.style.background = rgbToCss(accent);
      btn.style.borderColor = rgbToCss(accent);
      btn.style.color = '#fff';
    });

    // (3) ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ë„ ì‚´ì§ ê°•ì¡°
    document.querySelectorAll('.topbar .btn').forEach(btn => {
      btn.style.background = rgbToCss(panelBg);
      btn.style.borderColor = rgbToCss(border, 0.7);
    });

  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // API í˜¸ì¶œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildCoverThumbs(items) {
    const thumbs = (items || []).map(t => t.thumb).filter(Boolean).slice(0, 4);
    return thumbs;
  }

  async function fetchPlaylist() {
    const res = await fetch(
      `http://localhost:3001/api/playlists/${encodeURIComponent(playlistId)}`,
      { credentials: 'include' }
    );
    if (!res.ok) throw new Error('playlist load fail');
    return res.json();
  }

  async function updateThemeColor(id, themeColor) {
    const res = await fetch(
      `http://localhost:3001/api/playlists/${encodeURIComponent(id)}/theme`,
      {
        method: 'PATCH',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ themeColor }),
      }
    );
    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok) {
      const msg = data.error || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ë Œë”ë§
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderHeader(pl) {
    const header = $('#headerSection');
    header.innerHTML = '';

    // ì´ ì¬ìƒëª©ë¡ì˜ í…Œë§ˆ ìƒ‰ (ì—†ìœ¼ë©´ ê¸°ë³¸ accent)
    let theme = pl.theme_color || '#22d3ee';

    // â˜… í˜ì´ì§€ ì „ì²´ ìƒ‰ ì„¸íŠ¸ ì ìš© (body, topbar, panel, ë²„íŠ¼ ë“±)
    applyPlaylistTheme(theme);

    const box = document.createElement('div');
    box.className = 'plv-header';

    const cover = document.createElement('div');
    cover.className = 'plv-cover';
    const thumbs = buildCoverThumbs(pl.items);
    if (thumbs.length) {
      thumbs.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        img.alt = 'thumb';
        cover.appendChild(img);
      });
      while (cover.childElementCount < 4) {
        const d = document.createElement('div');
        d.style.background = '#020617';
        cover.appendChild(d);
      }
    } else {
      const d = document.createElement('div');
      d.style.gridColumn = '1/3';
      d.style.gridRow = '1/3';
      d.style.display = 'flex';
      d.style.alignItems = 'center';
      d.style.justifyContent = 'center';
      d.textContent = 'ğŸµ';
      cover.appendChild(d);
    }

    const meta = document.createElement('div');
    const title = document.createElement('div');
    title.className = 'plv-title';
    title.textContent = pl.title;

    const sub = document.createElement('div');
    sub.className = 'plv-sub';
    sub.textContent =
      `${pl.owner_name || 'ë‚˜'} Â· íŠ¸ë™ ${(pl.items || []).length}ê°œ `
      + `Â· â™¥ ${pl.likes || 0} Â· ${pl.is_public ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'}`;

    const controls = document.createElement('div');
    controls.className = 'plv-controls';

    // â–¶ ì „ì²´ ì¬ìƒ ë²„íŠ¼ (accent ê¸°ë°˜)
    const playBtn = document.createElement('button');
    playBtn.className = 'btn primary';
    playBtn.textContent = 'â–¶ ì „ì²´ ì¬ìƒ';
    playBtn.addEventListener('click', () => {
      const first = (pl.items || [])[0];
      if (!first) {
        alert('ì¬ìƒí•  ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      localStorage.setItem('currentTrackId', first.track_id);
      location.href = './player.html';
    });

    // âŒ ì¬ìƒëª©ë¡ ì‚­ì œ ë²„íŠ¼
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn btn-danger';
    deleteBtn.textContent = 'ì¬ìƒëª©ë¡ ì‚­ì œ';
    deleteBtn.addEventListener('click', async () => {
      if (!confirm(`"${pl.title}" ì¬ìƒëª©ë¡ì„ ì‚­ì œí• ê¹Œìš”?`)) return;

      try {
        const res = await API.deletePlaylist(pl.id);
        if (res.ok) {
          alert('ì¬ìƒëª©ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.href = './playlist.html';
        } else {
          if (res.error === 'login required' || res.status === 401) {
            alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.');
            location.href = './login.html?redirect=playlist';
          } else if (res.error === 'forbidden' || res.status === 403) {
            alert('ì´ ì¬ìƒëª©ë¡ì€ ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
          } else {
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + (res.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        }
      } catch (e) {
        console.error('playlist delete error:', e);
        alert('ì¬ìƒëª©ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ğŸ¨ í…Œë§ˆ ìƒ‰ ë³€ê²½ UI
    const colorWrap = document.createElement('div');
    colorWrap.className = 'theme-color-wrap';

    const colorLabel = document.createElement('span');
    colorLabel.className = 'sub';
    colorLabel.style.opacity = '.85';
    colorLabel.textContent = 'í…Œë§ˆ ìƒ‰';

    const colorInput = document.createElement('input');
    colorInput.type = 'color';
    colorInput.value = theme;

    const saveColorBtn = document.createElement('button');
    saveColorBtn.className = 'btn';
    saveColorBtn.textContent = 'ìƒ‰ ì €ì¥';

    saveColorBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const newColor = colorInput.value || theme;

      try {
        await updateThemeColor(pl.id, newColor);

        // í™”ë©´ ì „ì²´ í…Œë§ˆë¥¼ ìƒˆ ìƒ‰ìœ¼ë¡œ ë‹¤ì‹œ ì ìš©
        theme = newColor;
        applyPlaylistTheme(theme);

        alert('í…Œë§ˆ ìƒ‰ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (err) {
        console.error('update theme error:', err);
        alert('í…Œë§ˆ ìƒ‰ ì €ì¥ ì‹¤íŒ¨: ' + err.message);
      }
    });

    colorWrap.appendChild(colorLabel);
    colorWrap.appendChild(colorInput);
    colorWrap.appendChild(saveColorBtn);

    controls.appendChild(playBtn);
    controls.appendChild(deleteBtn);
    controls.appendChild(colorWrap);

    meta.appendChild(title);
    meta.appendChild(sub);
    meta.appendChild(controls);

    box.appendChild(cover);
    box.appendChild(meta);

    header.appendChild(box);
  }

  function renderTracks(pl) {
    const list = $('#trackList');
    list.innerHTML = '';

    const items = pl.items || [];
    if (!items.length) {
      list.innerHTML =
        '<div class="sub" style="opacity:.7;padding:8px;">'
        + 'ì•„ì§ ì´ ì¬ìƒëª©ë¡ì— ê³¡ì´ ì—†ìŠµë‹ˆë‹¤. '
        + 'ìœ„ì˜ "ê³¡ ì¶”ê°€í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²€ìƒ‰ í™”ë©´ì—ì„œ ì¶”ê°€í•´ ë³´ì„¸ìš”.'
        + '</div>';
      return;
    }

    items.forEach((t, idx) => {
      const row = document.createElement('div');
      row.className = 'plv-track-row';

      const index = document.createElement('div');
      index.className = 'sub';
      index.style.textAlign = 'right';
      index.textContent = idx + 1;

      const main = document.createElement('div');
      main.className = 'plv-track-main';
      const img = document.createElement('img');
      img.src = t.thumb || '';
      img.alt = 'thumb';

      const texts = document.createElement('div');
      texts.style.minWidth = 0;
      texts.innerHTML = `
        <div class="plv-track-title">${t.title || ''}</div>
        <div class="plv-track-sub">${t.artist || ''} Â· ${t.source || ''}</div>
      `;

      main.appendChild(img);
      main.appendChild(texts);

      const right = document.createElement('div');
      right.style.textAlign = 'right';
      right.innerHTML = `<button class="btn" data-role="play">ì¬ìƒ</button>`;

      row.appendChild(index);
      row.appendChild(main);
      row.appendChild(right);

      row.addEventListener('click', (e) => {
        e.stopPropagation();
        localStorage.setItem('currentTrackId', t.track_id);
        location.href = './player.html';
      });

      list.appendChild(row);
    });
  }

  // ê²€ìƒ‰ í™”ë©´ìœ¼ë¡œ ì´ë™í•  ë•Œ ì¬ìƒëª©ë¡ idë¥¼ ê°™ì´ ë„˜ê¹€
  $('#goAddFromSearch').addEventListener('click', () => {
    location.href = `./search.html?addToPlaylist=${encodeURIComponent(playlistId)}`;
  });

  // ì´ˆê¸° ë¡œë“œ
  (async function init() {
    try {
      const pl = await fetchPlaylist();
      renderHeader(pl);
      renderTracks(pl);
    } catch (e) {
      console.error(e);
      alert('ì¬ìƒëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      location.href = './playlist.html';
    }
  })();
</script>
</body>
</html>