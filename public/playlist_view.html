<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Emotion Playlist Â· Playlist</title>

  <!-- ì™¸ë¶€ CSS ë¶ˆëŸ¬ì˜¤ê¸° -->
  <link rel="stylesheet" href="./assets/styles.css"/>

  <style>
    /* ================================
       ìƒë‹¨ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì •ë³´ í—¤ë” ì˜ì—­
       ================================ */
    #headerSection{
      border-radius:18px;
      overflow:hidden;
      /* ì „ì²´ íŒ¨ë„ ê¸°ë³¸ ìƒ‰ (styles.cssì˜ ë³€ìˆ˜ ì‚¬ìš©) */
      background: var(--panel, rgba(15,23,42,0.98));
      /* í…Œë‘ë¦¬ ìƒ‰ */
      border:1px solid rgba(148,163,184,0.25);
      /* hover, theme ë³€í™”ì— ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ */
      transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease;
    }

    /* í…Œë§ˆ ì ìš© ì‹œ ê·¸ë¦¼ì ê°•ì¡° */
    #headerSection.theme-colored{
      box-shadow:0 22px 60px rgba(0,0,0,.75);
    }

    /* ================================
       ì „ì²´ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒì„¸ í˜ì´ì§€ Wrapper
       ================================ */
    .plv-wrap {
      display:flex;
      flex-direction:column;
      gap:16px;
      padding:16px;
    }

    /* í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒë‹¨ ì •ë³´(ì»¤ë²„ + ì œëª© + ë²„íŠ¼) */
    .plv-header {
      display:flex;
      gap:20px;
      align-items:flex-end;
    }

    /* ================================
       í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì»¤ë²„ ì´ë¯¸ì§€(2Ã—2 Grid êµ¬ì„±)
       ================================ */
    .plv-cover {
      width:180px;
      height:180px;
      border-radius:16px;
      background:#020617;
      overflow:hidden;

      /* 2Ã—2 ì´ë¯¸ì§€ ë°°ì¹˜ */
      display:grid;
      grid-template-columns:repeat(2,1fr);
      grid-template-rows:repeat(2,1fr);
      gap:2px;

      flex-shrink:0; /* ì˜¤ë¥¸ìª½ ë‚´ìš© ë•Œë¬¸ì— ëˆŒë¦¬ì§€ ì•Šë„ë¡ ê³ ì • */
    }

    .plv-cover img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    /* í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì œëª© */
    .plv-title {
      font-size:28px;
      font-weight:700;
      margin-bottom:4px;
    }

    /* ë¶€ì œëª© (ê³¡ ìˆ˜, ì—…ë°ì´íŠ¸ ì‹œê°„ ë“±) */
    .plv-sub {
      font-size:13px;
      opacity:.7;
    }

    /* ì¬ìƒ ë²„íŠ¼, ì¢‹ì•„ìš” ë²„íŠ¼ ë“± ì»¨íŠ¸ë¡¤ ì˜ì—­ */
    .plv-controls {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
      align-items:center;
    }

    /* ================================
       ê° íŠ¸ë™(ë…¸ë˜) Row ìŠ¤íƒ€ì¼
       ================================ */
    .plv-track-row {
      display:grid;

      /* ì•„ì´ì½˜, ì œëª©, ê¸¸ì´ ì´ë ‡ê²Œ 3ì¹¸ ë°°ì¹˜ */
      grid-template-columns:24px minmax(0,1fr) 80px;
      gap:8px;
      align-items:center;

      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
    }

    /* íŠ¸ë™ Hover íš¨ê³¼ */
    .plv-track-row:hover {
      background:rgba(148,163,184,.10);
    }

    /* íŠ¸ë™ ë©”ì¸: ì•¨ë²” ì´ë¯¸ì§€ + í…ìŠ¤íŠ¸ ë¬¶ìŒ */
    .plv-track-main {
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ì²˜ë¦¬ ìœ„í•´ í•„ìš” */
    }

    /* ì•¨ë²” ì´ë¯¸ì§€ */
    .plv-track-main img {
      width:44px;
      height:44px;
      border-radius:8px;
      object-fit:cover;
      flex-shrink:0;
    }

    /* ê³¡ ì œëª© */
    .plv-track-title {
      font-size:14px;

      /* ì œëª©ì´ ê¸¸ë©´ ... ì²˜ë¦¬ */
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ì•„í‹°ìŠ¤íŠ¸ */
    .plv-track-sub {
      font-size:12px;
      opacity:.7;
    }

    /* ğŸ¨ í…Œë§ˆ ìƒ‰ ë³€ê²½ UI */
    .theme-color-wrap{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
    }
    .theme-color-wrap input[type="color"]{
      width:28px;
      height:28px;
      border-radius:50%;
      border:none;
      padding:0;
      background:transparent;
      cursor:pointer;
    }
  </style>
</head>
<body data-mood="calm">
<header class="topbar">
  <div class="brand">ğŸ“‚ ì¬ìƒëª©ë¡</div>
  <nav class="nav">
    <!-- ìƒë‹¨ ë‚´ë¹„ê²Œì´ì…˜ ë©”ë‰´ -->
    <a href="./home.html" class="btn">í™ˆ</a>
    <a href="./search.html" class="btn">ê²€ìƒ‰</a>
    <a href="./playlist.html" class="btn">ì¬ìƒëª©ë¡</a>
    <a href="./login.html" id="loginLink" class="btn">ë¡œê·¸ì¸</a>
    <span id="userBadge" class="badge hidden"></span> <!-- ë¡œê·¸ì¸ í›„ ì‚¬ìš©ìëª… í‘œì‹œ -->
    <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button> <!-- ë¡œê·¸ì¸ ì‹œ í™œì„±í™” -->
  </nav>
</header>

<main class="plv-wrap">
  <section id="headerSection" class="panel">
    <!-- JSì—ì„œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ í—¤ë” ì •ë³´(ì œëª©, ì„¤ëª… ë“±)ë¥¼ ì±„ì›Œ ë„£ìŒ -->
  </section>

  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <div class="sub">íŠ¸ë™ ëª©ë¡</div> <!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì˜ ë…¸ë˜ ë¦¬ìŠ¤íŠ¸ ì œëª© -->
      <button id="goAddFromSearch" class="btn">ê³¡ ì¶”ê°€í•˜ê¸° (ê²€ìƒ‰ìœ¼ë¡œ ì´ë™)</button> <!-- ê²€ìƒ‰ í˜ì´ì§€ë¡œ ì´ë™ -->
    </div>
    <div id="trackList">
      <!-- JSì—ì„œ íŠ¸ë™(ë…¸ë˜) ëª©ë¡ ë Œë”ë§ -->
    </div>
  </section>
</main>

<!-- API í˜¸ì¶œ ê´€ë ¨ JS -->
<script src="./assets/api.js"></script>
<!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ JS -->
<script src="./assets/auth.js"></script>
<script>
  const $ = (s) => document.querySelector(s); // ì§§ê²Œ ì„ íƒì í•¨ìˆ˜ ì„ ì–¸
  const searchParams = new URLSearchParams(location.search); // URL íŒŒë¼ë¯¸í„° ì½ê¸°
  const playlistId = searchParams.get('id'); // ?id=ê°’ ê°€ì ¸ì˜¤ê¸°

  if (!playlistId) {
    alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.'); // idê°€ ì—†ìœ¼ë©´ ê²½ê³ 
    location.href = './playlist.html'; // ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìƒ‰ ìœ í‹¸: hex â†” rgb, ìƒ‰ ì„ê¸°, css ì¶œë ¥
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function hexToRgb(hex) {
    if (!hex) return { r: 255, g: 255, b: 255 };
    let c = hex.replace('#', '').trim();
    if (c.length === 3) {
      c = c.split('').map(ch => ch + ch).join('');
    }
    const num = parseInt(c, 16);
    return {
      r: (num >> 16) & 255,
      g: (num >> 8) & 255,
      b: num & 255,
    };
  }

  function rgbToCss({ r, g, b }, alpha) {
    if (typeof alpha === 'number') {
      return `rgba(${r},${g},${b},${alpha})`;
    }
    return `rgb(${r},${g},${b})`;
  }

  // base(ì–´ë‘ìš´ ê¸°ë³¸ìƒ‰)ê³¼ accent(í…Œë§ˆìƒ‰)ë¥¼ ì„ì–´ì„œ ê³„ì¡° ë§Œë“¤ê¸°
  // ratio: 0 = base, 1 = accent
  function mixColor(base, accent, ratio) {
    const t = Math.max(0, Math.min(1, ratio));
    return {
      r: Math.round(base.r + (accent.r - base.r) * t),
      g: Math.round(base.g + (accent.g - base.g) * t),
      b: Math.round(base.b + (accent.b - base.b) * t),
    };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ í…Œë§ˆë¥¼ í˜ì´ì§€ ì „ì²´ì— ì ìš©
  // (í™ˆ í™”ë©´ mood í…Œë§ˆì²˜ëŸ¼: ë°°ê²½ + ì¹´ë“œ + ë²„íŠ¼ ì„¸íŠ¸)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyPlaylistTheme(themeHex) {
    const accent = hexToRgb(themeHex || '#22d3ee');

    // ì‚¬ì´íŠ¸ ê¸°ë³¸ ì–´ë‘ìš´ ë² ì´ìŠ¤(ë„¤ì´ë¹„ ê³„ì—´ ëŠë‚Œ)
    const base = { r: 3, g: 7, b: 18 };

    // í˜ì´ì§€ ì „ì²´ ë°°ê²½, íŒ¨ë„, í—¤ë”ìš© í†¤ ë§Œë“¤ê¸°
    const pageBg   = mixColor(base, accent, 0.28); // ì œì¼ ì–´ë‘ìš´ í†¤
    const panelBg  = mixColor(base, accent, 0.40); // ì¹´ë“œ / íŒ¨ë„ ë°°ê²½
    const headerBg = mixColor(base, accent, 0.52); // ìœ„ í° í—¤ë” íŒ¨ë„
    const border   = mixColor(base, accent, 0.70); // í…Œë‘ë¦¬
    const accentSoft = mixColor(accent, { r: 255, g: 255, b: 255 }, 0.18);

    // 1) body ë°°ê²½
    document.body.style.background = rgbToCss(pageBg);

    // 2) ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°”
    const topbar = document.querySelector('.topbar');
    if (topbar) {
      topbar.style.background = rgbToCss(panelBg);
      topbar.style.borderBottom = `1px solid ${rgbToCss(border, 0.7)}`;
      topbar.style.boxShadow = `0 10px 30px ${rgbToCss(base, 0.85)}`;
    }

    // 3) íŒ¨ë„(ì¹´ë“œ)ë“¤ ë°°ê²½ + í…Œë‘ë¦¬
    document.querySelectorAll('.panel').forEach(panel => {
      if (panel.id === 'headerSection') {
        panel.style.background = rgbToCss(headerBg);
      } else {
        panel.style.background = rgbToCss(panelBg);
      }
      panel.style.border = `1px solid ${rgbToCss(border, 0.55)}`;
      panel.style.boxShadow = `0 20px 50px ${rgbToCss(accent, 0.35)}`;
    });

    // 4) ì „ì—­ CSS ë³€ìˆ˜ë„ ê°™ì´ ë°”ê¾¸ê¸°
    //    (ë²„íŠ¼, ë°°ì§€ ë“± styles.cssì—ì„œ --accent, --cardë¥¼ ì“°ê³  ìˆì„ ê±°ë¼ì„œ)
    const rootStyle = document.documentElement.style;
    rootStyle.setProperty('--bg', rgbToCss(pageBg));
    rootStyle.setProperty('--bg-soft', rgbToCss(panelBg));
    rootStyle.setProperty('--card', rgbToCss(panelBg));
    rootStyle.setProperty('--accent', rgbToCss(accent));
    rootStyle.setProperty('--accent-soft', rgbToCss(accentSoft));
    rootStyle.setProperty('--border-subtle', rgbToCss(border, 0.55));


    // 5) ë²„íŠ¼ ìƒ‰ í…Œë§ˆì— ë§ê²Œ ì¡°ì •

    // (1) ê¸°ë³¸ ë²„íŠ¼ë“¤ - ìœ„í—˜ ë²„íŠ¼(.btn-danger) ë§ê³  ì „ë¶€
    document.querySelectorAll('.btn:not(.btn-danger)').forEach(btn => {
      btn.style.background = rgbToCss(panelBg);
      btn.style.borderColor = rgbToCss(border, 0.7);
      btn.style.boxShadow = `0 4px 12px ${rgbToCss(accent, 0.3)}`;
    });

    // (2) ì£¼ìš” ë²„íŠ¼(ì „ì²´ ì¬ìƒ ê°™ì€ primary / play ë²„íŠ¼)ì€ í…Œë§ˆìƒ‰ìœ¼ë¡œ
    document.querySelectorAll('.btn.primary, .btn[data-role="play"]').forEach(btn => {
      btn.style.background = rgbToCss(accent);
      btn.style.borderColor = rgbToCss(accent);
      btn.style.color = '#fff';
    });

    // (3) ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ë„ ì‚´ì§ ê°•ì¡°
    document.querySelectorAll('.topbar .btn').forEach(btn => {
      btn.style.background = rgbToCss(panelBg);
      btn.style.borderColor = rgbToCss(border, 0.7);
    });

  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // API í˜¸ì¶œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildCoverThumbs(items) {
    // items ë°°ì—´ì—ì„œ thumb ê°’ë§Œ ì¶”ì¶œ â†’ null/undefined ì œê±° â†’ ìµœëŒ€ 4ê°œë§Œ ì‚¬ìš©
    const thumbs = (items || []).map(t => t.thumb).filter(Boolean).slice(0, 4);
    return thumbs; // ìµœì¢… ì¸ë„¤ì¼ ë°°ì—´ ë°˜í™˜
  }

  async function fetchPlaylist() {
    // playlistId ê¸°ë°˜ìœ¼ë¡œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì •ë³´ ìš”ì²­ (ë¡œê·¸ì¸ ì¿ í‚¤ í¬í•¨)
    const res = await fetch(
      `http://localhost:3001/api/playlists/${encodeURIComponent(playlistId)}`,
      { credentials: 'include' } // ì¿ í‚¤ í¬í•¨í•˜ì—¬ ì¸ì¦ ì²˜ë¦¬
    );

    if (!res.ok) throw new Error('playlist load fail'); // ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ ë°œìƒ

    return res.json(); // JSON ë°ì´í„° ë°˜í™˜
  }

  async function updateThemeColor(id, themeColor) {
    // íŠ¹ì • í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì˜ í…Œë§ˆ ìƒ‰ìƒì„ PATCH ìš”ì²­ìœ¼ë¡œ ìˆ˜ì •
    const res = await fetch(
      `http://localhost:3001/api/playlists/${encodeURIComponent(id)}/theme`,
      {
        method: 'PATCH',
        credentials: 'include', // ì¿ í‚¤ í¬í•¨ (ë¡œê·¸ì¸ ì¸ì¦)
        headers: { 'Content-Type': 'application/json' }, // JSON ë³¸ë¬¸ ì „ì†¡
        body: JSON.stringify({ themeColor }), // ì—…ë°ì´íŠ¸í•  í…Œë§ˆ ì»¬ëŸ¬
      }
    );

    // ì„œë²„ì—ì„œ ë°˜í™˜í•œ JSON íŒŒì‹± (ì‹¤íŒ¨í•˜ë©´ ë¹ˆ ê°ì²´ {})
    const data = await res.json().catch(() => ({}));

    // ì„œë²„ ì‘ë‹µ ë˜ëŠ” data.ok ê°’ì´ falseë©´ ì˜¤ë¥˜ ì²˜ë¦¬
    if (!res.ok || !data.ok) {
      const msg = data.error || `HTTP ${res.status}`;
      throw new Error(msg); // ì˜¤ë¥˜ ë©”ì‹œì§€ throw
    }

    return data; // ì„±ê³µ ì‹œ ì„œë²„ì—ì„œ ì¤€ ì‘ë‹µ ë°˜í™˜
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ë Œë”ë§
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderHeader(pl) {
    const header = $('#headerSection');
    header.innerHTML = '';

    // ì´ ì¬ìƒëª©ë¡ì˜ í…Œë§ˆ ìƒ‰ (ì—†ìœ¼ë©´ ê¸°ë³¸ accent)
    let theme = pl.theme_color || '#22d3ee';

    // â˜… í˜ì´ì§€ ì „ì²´ ìƒ‰ ì„¸íŠ¸ ì ìš© (body, topbar, panel, ë²„íŠ¼ ë“±)
    applyPlaylistTheme(theme);

   const box = document.createElement('div');
box.className = 'plv-header'; // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒë‹¨ í—¤ë” ì»¨í…Œì´ë„ˆ

const cover = document.createElement('div');
cover.className = 'plv-cover'; // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì˜ì—­

const thumbs = buildCoverThumbs(pl.items); // ìµœëŒ€ 4ê°œì˜ ì¸ë„¤ì¼ ê°€ì ¸ì˜¤ê¸°
if (thumbs.length) {
  // ì¸ë„¤ì¼ì´ ìˆìœ¼ë©´ ì´ë¯¸ì§€ ìš”ì†Œ ìƒì„±í•˜ì—¬ coverì— ì¶”ê°€
  thumbs.forEach(src => {
    const img = document.createElement('img');
    img.src = src; // ì´ë¯¸ì§€ ì£¼ì†Œ
    img.alt = 'thumb'; // ëŒ€ì²´ í…ìŠ¤íŠ¸
    cover.appendChild(img);
  });
  // ì¸ë„¤ì¼ì´ 4ê°œ ë¯¸ë§Œì´ë©´ ë‚¨ì€ ì¹¸ì„ ì–´ë‘ìš´ ë°°ê²½ divë¡œ ì±„ì›€
  while (cover.childElementCount < 4) {
    const d = document.createElement('div');
    d.style.background = '#020617';
    cover.appendChild(d);
  }
} else {
  // ì¸ë„¤ì¼ì´ ì—†ìœ¼ë©´ ì¤‘ì•™ì— ìŒì•… ì•„ì´ì½˜ í‘œì‹œ
  const d = document.createElement('div');
  d.style.gridColumn = '1/3';
  d.style.gridRow = '1/3';
  d.style.display = 'flex';
  d.style.alignItems = 'center';
  d.style.justifyContent = 'center';
  d.textContent = 'ğŸµ';
  cover.appendChild(d);
}

const meta = document.createElement('div'); // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì •ë³´ ì˜ì—­

const title = document.createElement('div');
title.className = 'plv-title'; // ì œëª© ìŠ¤íƒ€ì¼
title.textContent = pl.title; // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì œëª©

const sub = document.createElement('div');
sub.className = 'plv-sub'; // ë¶€ê°€ ì •ë³´ ìŠ¤íƒ€ì¼
sub.textContent =
  `${pl.owner_name || 'ë‚˜'} Â· íŠ¸ë™ ${(pl.items || []).length}ê°œ ` // ì†Œìœ ì ë° íŠ¸ë™ ìˆ˜
  + `Â· â™¥ ${pl.likes || 0} Â· ${pl.is_public ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'}`; // ì¢‹ì•„ìš” ìˆ˜ ë° ê³µê°œ ì—¬ë¶€

const controls = document.createElement('div');
controls.className = 'plv-controls'; // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒë‹¨ ì¡°ì‘ ë²„íŠ¼ ì˜ì—­

    // â–¶ ì „ì²´ ì¬ìƒ ë²„íŠ¼ (accent ê¸°ë°˜)
    const playBtn = document.createElement('button');
    playBtn.className = 'btn primary';
    playBtn.textContent = 'â–¶ ì „ì²´ ì¬ìƒ';
    playBtn.addEventListener('click', () => {
      const first = (pl.items || [])[0];
      if (!first) {
        alert('ì¬ìƒí•  ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      localStorage.setItem('currentTrackId', first.track_id);
      location.href = './player.html';
    });

    // âŒ ì¬ìƒëª©ë¡ ì‚­ì œ ë²„íŠ¼
    const deleteBtn = document.createElement('button');
deleteBtn.className = 'btn btn-danger'; // ë¶‰ì€ìƒ‰ ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼
deleteBtn.textContent = 'ì¬ìƒëª©ë¡ ì‚­ì œ'; // ë²„íŠ¼ í…ìŠ¤íŠ¸

deleteBtn.addEventListener('click', async () => {
  // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì²˜ë¦¬
  if (!confirm(`"${pl.title}" ì¬ìƒëª©ë¡ì„ ì‚­ì œí• ê¹Œìš”?`)) return; // í™•ì¸ íŒì—…

  try {
    const res = await API.deletePlaylist(pl.id); // API í˜¸ì¶œ: í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì‚­ì œ

    if (res.ok) {
      alert('ì¬ìƒëª©ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); // ì„±ê³µ ì•Œë¦¼
      location.href = './playlist.html'; // ì¬ìƒëª©ë¡ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
    } else {
      // ì‹¤íŒ¨ ì²˜ë¦¬: ìƒíƒœ ì½”ë“œ ë° ì—ëŸ¬ ë©”ì‹œì§€ì— ë”°ë¼ ë¶„ê¸°
      if (res.error === 'login required' || res.status === 401) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.');
        location.href = './login.html?redirect=playlist'; // ë¡œê·¸ì¸ í˜ì´ì§€ ì´ë™
      } else if (res.error === 'forbidden' || res.status === 403) {
        alert('ì´ ì¬ìƒëª©ë¡ì€ ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
      } else {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + (res.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜')); // ê¸°íƒ€ ì˜¤ë¥˜
      }
    }
  } catch (e) {
    console.error('playlist delete error:', e); // ì½˜ì†” ë¡œê·¸ ì¶œë ¥
    alert('ì¬ìƒëª©ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); // ì˜ˆì™¸ ì²˜ë¦¬ ì•Œë¦¼
  }
});


    // ğŸ¨ í…Œë§ˆ ìƒ‰ ë³€ê²½ UI
    const colorWrap = document.createElement('div');
colorWrap.className = 'theme-color-wrap'; // í…Œë§ˆ ìƒ‰ìƒ ì„ íƒ ì˜ì—­ ì»¨í…Œì´ë„ˆ

const colorLabel = document.createElement('span');
colorLabel.className = 'sub'; // ì†Œì œëª© ìŠ¤íƒ€ì¼
colorLabel.style.opacity = '.85';
colorLabel.textContent = 'í…Œë§ˆ ìƒ‰'; // ë¼ë²¨ í…ìŠ¤íŠ¸

const colorInput = document.createElement('input');
colorInput.type = 'color'; // ì»¬ëŸ¬ ì„ íƒ input
colorInput.value = theme; // í˜„ì¬ í…Œë§ˆ ìƒ‰ ì´ˆê¸°ê°’

const saveColorBtn = document.createElement('button');
saveColorBtn.className = 'btn'; // ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼
saveColorBtn.textContent = 'ìƒ‰ ì €ì¥'; // ë²„íŠ¼ í…ìŠ¤íŠ¸

saveColorBtn.addEventListener('click', async (e) => {
  e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
  const newColor = colorInput.value || theme; // ì„ íƒí•œ ìƒ‰ ê°€ì ¸ì˜¤ê¸°

  try {
    await updateThemeColor(pl.id, newColor); // ì„œë²„ì— í…Œë§ˆ ìƒ‰ ì €ì¥

    // í™”ë©´ ì „ì²´ í…Œë§ˆë¥¼ ìƒˆ ìƒ‰ìœ¼ë¡œ ë‹¤ì‹œ ì ìš©
    theme = newColor;
    applyPlaylistTheme(theme);

    alert('í…Œë§ˆ ìƒ‰ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); // ì„±ê³µ ì•Œë¦¼
  } catch (err) {
    console.error('update theme error:', err); // ì˜¤ë¥˜ ì½˜ì†” ì¶œë ¥
    alert('í…Œë§ˆ ìƒ‰ ì €ì¥ ì‹¤íŒ¨: ' + err.message); // ì‹¤íŒ¨ ì•Œë¦¼
  }
});

// colorWrapì— ë¼ë²¨, input, ì €ì¥ ë²„íŠ¼ ì¶”ê°€
colorWrap.appendChild(colorLabel);
colorWrap.appendChild(colorInput);
colorWrap.appendChild(saveColorBtn);

// controls ì˜ì—­ì— ì¬ìƒ, ì‚­ì œ, í…Œë§ˆ ìƒ‰ ì»¨íŠ¸ë¡¤ ì¶”ê°€
controls.appendChild(playBtn);
controls.appendChild(deleteBtn);
controls.appendChild(colorWrap);

// meta ì˜ì—­ì— ì œëª©, ë¶€ê°€ì •ë³´, ì»¨íŠ¸ë¡¤ ì¶”ê°€
meta.appendChild(title);
meta.appendChild(sub);
meta.appendChild(controls);

// box ì»¨í…Œì´ë„ˆì— ì¸ë„¤ì¼ê³¼ meta ì¶”ê°€
box.appendChild(cover);
box.appendChild(meta);

// ìµœì¢…ì ìœ¼ë¡œ headerì— box ì¶”ê°€
header.appendChild(box);
}

function renderTracks(pl) {
  const list = $('#trackList'); // íŠ¸ë™ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì„ íƒ
  list.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

  const items = pl.items || []; // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ íŠ¸ë™ ë°°ì—´
  if (!items.length) {
    // íŠ¸ë™ì´ ì—†ì„ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
    list.innerHTML =
      '<div class="sub" style="opacity:.7;padding:8px;">'
      + 'ì•„ì§ ì´ ì¬ìƒëª©ë¡ì— ê³¡ì´ ì—†ìŠµë‹ˆë‹¤. '
      + 'ìœ„ì˜ "ê³¡ ì¶”ê°€í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²€ìƒ‰ í™”ë©´ì—ì„œ ì¶”ê°€í•´ ë³´ì„¸ìš”.'
      + '</div>';
    return;
  }

  items.forEach((t, idx) => {
    const row = document.createElement('div');
    row.className = 'plv-track-row'; // íŠ¸ë™ í–‰ ì»¨í…Œì´ë„ˆ

    const index = document.createElement('div');
    index.className = 'sub'; // ì†Œì œëª© ìŠ¤íƒ€ì¼
    index.style.textAlign = 'right'; // ë²ˆí˜¸ ì˜¤ë¥¸ìª½ ì •ë ¬
    index.textContent = idx + 1; // íŠ¸ë™ ë²ˆí˜¸

    const main = document.createElement('div');
    main.className = 'plv-track-main'; // íŠ¸ë™ ì¸ë„¤ì¼ + ì •ë³´ ì˜ì—­
    const img = document.createElement('img');
    img.src = t.thumb || ''; // ì¸ë„¤ì¼ ì´ë¯¸ì§€
    img.alt = 'thumb'; // ëŒ€ì²´ í…ìŠ¤íŠ¸

    const texts = document.createElement('div'); // íŠ¸ë™ ì œëª©/ì•„í‹°ìŠ¤íŠ¸ ì •ë³´
    texts.style.minWidth = 0;
    texts.innerHTML = `
      <div class="plv-track-title">${t.title || ''}</div>
      <div class="plv-track-sub">${t.artist || ''} Â· ${t.source || ''}</div>
    `;

    main.appendChild(img);
    main.appendChild(texts);

    const right = document.createElement('div'); // ì¬ìƒ ë²„íŠ¼ ì˜ì—­
    right.style.textAlign = 'right';
    right.innerHTML = `<button class="btn" data-role="play">ì¬ìƒ</button>`;

    // rowì— ë²ˆí˜¸, main, ì˜¤ë¥¸ìª½ ë²„íŠ¼ ì¶”ê°€
    row.appendChild(index);
    row.appendChild(main);
    row.appendChild(right);

    // íŠ¸ë™ í´ë¦­ ì‹œ player.htmlë¡œ ì´ë™
    row.addEventListener('click', (e) => {
      e.stopPropagation();
      localStorage.setItem('currentTrackId', t.track_id); // ì„ íƒ íŠ¸ë™ ì €ì¥
      location.href = './player.html'; // í”Œë ˆì´ì–´ í˜ì´ì§€ë¡œ ì´ë™
    });

    list.appendChild(row); // ë¦¬ìŠ¤íŠ¸ì— í–‰ ì¶”ê°€
  });
}

  // ê²€ìƒ‰ í™”ë©´ìœ¼ë¡œ ì´ë™í•  ë•Œ ì¬ìƒëª©ë¡ idë¥¼ ê°™ì´ ë„˜ê¹€
  $('#goAddFromSearch').addEventListener('click', () => {
    location.href = `./search.html?addToPlaylist=${encodeURIComponent(playlistId)}`;
  });

  // ì´ˆê¸° ë¡œë“œ
  (async function init() {
    try {
      const pl = await fetchPlaylist();
      renderHeader(pl);
      renderTracks(pl);
    } catch (e) {
      console.error(e);
      alert('ì¬ìƒëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      location.href = './playlist.html';
    }
  })();
</script>
</body>
</html>
