<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Emotion Playlist Â· Playlist</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
  <style>
    #headerSection{
      border-radius:18px;
      overflow:hidden;
      /* ê¸°ë³¸ íŒ¨ë„ ì»¬ëŸ¬ë§Œ ì‚¬ìš© (styles.css ìª½ ë³€ìˆ˜) */
      background: var(--panel, rgba(15,23,42,0.98));
      border:1px solid rgba(148,163,184,0.25);
      transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease;
    }
    #headerSection.theme-colored{
      box-shadow:0 22px 60px rgba(0,0,0,.75);
    }

    .plv-wrap {
      display:flex;
      flex-direction:column;
      gap:16px;
      padding:16px;
    }
    .plv-header {
      display:flex;
      gap:20px;
      align-items:flex-end;
    }
    .plv-cover {
      width:180px;
      height:180px;
      border-radius:16px;
      background:#020617;
      overflow:hidden;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      grid-template-rows:repeat(2,1fr);
      gap:2px;
      flex-shrink:0;
    }
    .plv-cover img {
      width:100%;height:100%;object-fit:cover;
    }
    .plv-title {
      font-size:28px;
      font-weight:700;
      margin-bottom:4px;
    }
    .plv-sub {
      font-size:13px;
      opacity:.7;
    }
    .plv-controls {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
      align-items:center;
    }
    .plv-track-row {
      display:grid;
      grid-template-columns:24px minmax(0,1fr) 80px;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
    }
    .plv-track-row:hover {
      background:rgba(148,163,184,.10);
    }
    .plv-track-main {
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .plv-track-main img {
      width:44px;height:44px;border-radius:8px;object-fit:cover;flex-shrink:0;
    }
    .plv-track-title {
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .plv-track-sub {
      font-size:12px;
      opacity:.7;
    }
    /* ì¬ìƒëª©ë¡ ì‚­ì œ ë²„íŠ¼(ìœ„í—˜ ë²„íŠ¼) ìŠ¤íƒ€ì¼ */
    .btn-danger {
      background:#d14343;
    }
    .btn-danger:hover {
      background:#e25555;
    }

    /* ğŸ¨ í…Œë§ˆ ìƒ‰ ë³€ê²½ UI */
    .theme-color-wrap{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
    }
    .theme-color-wrap input[type="color"]{
      width:28px;
      height:28px;
      border-radius:50%;
      border:none;
      padding:0;
      background:transparent;
      cursor:pointer;
    }
  </style>
</head>
<body data-mood="calm">
<header class="topbar">
  <div class="brand">ğŸ“‚ ì¬ìƒëª©ë¡</div>
  <nav class="nav">
    <a href="./home.html" class="btn">í™ˆ</a>
    <a href="./search.html" class="btn">ê²€ìƒ‰</a>
    <a href="./playlist.html" class="btn">ì¬ìƒëª©ë¡</a>
    <a href="./login.html" id="loginLink" class="btn">ë¡œê·¸ì¸</a>
    <span id="userBadge" class="badge hidden"></span>
    <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </nav>
</header>

<main class="plv-wrap">
  <section id="headerSection" class="panel">
    <!-- JSì—ì„œ ì±„ì›€ -->
  </section>

  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <div class="sub">íŠ¸ë™ ëª©ë¡</div>
      <button id="goAddFromSearch" class="btn">ê³¡ ì¶”ê°€í•˜ê¸° (ê²€ìƒ‰ìœ¼ë¡œ ì´ë™)</button>
    </div>
    <div id="trackList">
      <!-- JSì—ì„œ íŠ¸ë™ ë Œë”ë§ -->
    </div>
  </section>
</main>

<script src="./assets/api.js"></script>
<script src="./assets/auth.js"></script>
<script>
  const $ = (s) => document.querySelector(s);
  const searchParams = new URLSearchParams(location.search);
  const playlistId = searchParams.get('id');

  if (!playlistId) {
    alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
    location.href = './playlist.html';
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìƒ‰ ìœ í‹¸
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function hexToRgb(hex) {
    if (!hex) return { r: 255, g: 255, b: 255 };
    let c = hex.replace('#', '').trim();
    if (c.length === 3) c = c.split('').map(ch => ch + ch).join('');
    const num = parseInt(c, 16);
    return { r: (num >> 16) & 255, g: (num >> 8) & 255, b: num & 255 };
  }
  function rgbToCss({ r, g, b }, a) {
    return (typeof a === 'number') ? `rgba(${r},${g},${b},${a})` : `rgb(${r},${g},${b})`;
  }
  function mixColor(base, accent, t) {
    t = Math.max(0, Math.min(1, t));
    return {
      r: Math.round(base.r + (accent.r - base.r) * t),
      g: Math.round(base.g + (accent.g - base.g) * t),
      b: Math.round(base.b + (accent.b - base.b) * t),
    };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // í…Œë§ˆ ì ìš© (ì „ì—­ì—ì„œ íŠ¹ì • ë³€ìˆ˜ ì°¸ì¡° X)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyPlaylistTheme(themeHex) {
    const accent = hexToRgb(themeHex || '#22d3ee');
    const base = { r: 3, g: 7, b: 18 };

    const pageBg   = mixColor(base, accent, 0.28);
    const panelBg  = mixColor(base, accent, 0.40);
    const headerBg = mixColor(base, accent, 0.52);
    const border   = mixColor(base, accent, 0.70);
    const accentSoft = mixColor(accent, { r: 255, g: 255, b: 255 }, 0.18);

    document.body.style.background = rgbToCss(pageBg);

    const topbar = document.querySelector('.topbar');
    if (topbar) {
      topbar.style.background = rgbToCss(panelBg);
      topbar.style.borderBottom = `1px solid ${rgbToCss(border, 0.7)}`;
      topbar.style.boxShadow = `0 10px 30px rgba(0,0,0,.85)`;
    }

    document.querySelectorAll('.panel').forEach(panel => {
      if (panel.id === 'headerSection') panel.style.background = rgbToCss(headerBg);
      else panel.style.background = rgbToCss(panelBg);
      panel.style.border = `1px solid ${rgbToCss(border, 0.55)}`;
      panel.style.boxShadow = `0 20px 50px ${rgbToCss(accent, 0.35)}`;
    });

    const root = document.documentElement.style;
    root.setProperty('--bg', rgbToCss(pageBg));
    root.setProperty('--bg-soft', rgbToCss(panelBg));
    root.setProperty('--card', rgbToCss(panelBg));
    root.setProperty('--accent', rgbToCss(accent));
    root.setProperty('--accent-soft', rgbToCss(accentSoft));
    root.setProperty('--border-subtle', rgbToCss(border, 0.55));

    // ë²„íŠ¼ í†¤ ì •ë¦¬
    document.querySelectorAll('.btn:not(.btn-danger)').forEach(btn => {
      btn.style.background = rgbToCss(panelBg);
      btn.style.borderColor = rgbToCss(border, 0.7);
      btn.style.boxShadow = `0 4px 12px ${rgbToCss(accent, 0.3)}`;
    });
    document.querySelectorAll('.btn.primary, .btn[data-role="play"]').forEach(btn => {
      btn.style.background = rgbToCss(accent);
      btn.style.borderColor = rgbToCss(accent);
      btn.style.color = '#fff';
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // API helpers
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildCoverThumbs(items) {
    return (items || []).map(t => t.thumb).filter(Boolean).slice(0, 4);
  }
  async function fetchPlaylist() {
    const url = `http://localhost:3001/api/playlists/${encodeURIComponent(playlistId)}`;
    try {
      const res = await fetch(url, { credentials: 'include' });
      const text = await res.text();
      if (!res.ok) {
        console.error('Playlist fetch failed:', res.status, text);
        throw new Error(`HTTP ${res.status} - ${text || 'request failed'}`);
      }
      return JSON.parse(text);
    } catch (e) {
      console.error('fetchPlaylist error:', e);
      throw e;
    }
  }
  async function updateThemeColor(id, themeColor) {
    const res = await fetch(
      `http://localhost:3001/api/playlists/${encodeURIComponent(id)}/theme`,
      {
        method: 'PATCH',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ themeColor }),
      }
    );
    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
    return data;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì¬ìƒ í(í•´ë‹¹ ì¬ìƒëª©ë¡ë§Œ) ì €ì¥ â†’ player.htmlì—ì„œ ì‚¬ìš©
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setQueueFromPlaylist(pl, startIndex = 0) {
    const q = (pl.items || []).map(t => t.track_id);
    localStorage.setItem('playlistQueue', JSON.stringify(q));
    localStorage.setItem('queueIndex', String(Math.max(0, Math.min(startIndex, q.length - 1))));
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ë Œë”ë§
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderHeader(pl) {
    const header = $('#headerSection');
    header.innerHTML = '';

    let theme = pl.theme_color || '#22d3ee';
    applyPlaylistTheme(theme);

    const box = document.createElement('div');
    box.className = 'plv-header';

    const cover = document.createElement('div');
    cover.className = 'plv-cover';
    const thumbs = buildCoverThumbs(pl.items);
    if (thumbs.length) {
      thumbs.forEach(src => {
        const img = document.createElement('img');
        img.src = src; img.alt = 'thumb';
        cover.appendChild(img);
      });
      while (cover.childElementCount < 4) {
        const d = document.createElement('div'); d.style.background = '#020617'; cover.appendChild(d);
      }
    } else {
      const d = document.createElement('div');
      d.style.gridColumn = '1/3'; d.style.gridRow = '1/3';
      d.style.display = 'flex'; d.style.alignItems = 'center'; d.style.justifyContent = 'center';
      d.textContent = 'ğŸµ'; cover.appendChild(d);
    }

    const meta = document.createElement('div');
    const title = document.createElement('div');
    title.className = 'plv-title';
    title.textContent = pl.title;

    const sub = document.createElement('div');
    sub.className = 'plv-sub';
    sub.textContent =
      `${pl.owner_name || 'ë‚˜'} Â· íŠ¸ë™ ${(pl.items || []).length}ê°œ Â· â™¥ ${pl.likes || 0} Â· ${pl.is_public ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'}`;

    const controls = document.createElement('div');
    controls.className = 'plv-controls';

    // â–¶ ì „ì²´ ì¬ìƒ
    const playBtn = document.createElement('button');
    playBtn.className = 'btn primary';
    playBtn.textContent = 'â–¶ ì „ì²´ ì¬ìƒ';
    playBtn.addEventListener('click', () => {
      if (!pl.items?.length) return alert('ì¬ìƒí•  ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.');
      setQueueFromPlaylist(pl, 0);                         // (ìˆì–´ë„ ë¬´ë°©)
      localStorage.setItem('currentTrackId', pl.items[0].track_id);
      location.href = `./player.html?playlistId=${encodeURIComponent(pl.id)}`;
    });

    // âŒ ì‚­ì œ
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn btn-danger';
    deleteBtn.textContent = 'ì¬ìƒëª©ë¡ ì‚­ì œ';
    deleteBtn.addEventListener('click', async () => {
      if (!confirm(`"${pl.title}" ì¬ìƒëª©ë¡ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
      try {
        const res = await API.deletePlaylist(pl.id);
        if (res.ok) { alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); location.href = './playlist.html'; }
        else if (res.error === 'login required' || res.status === 401) {
          alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.'); location.href = './login.html?redirect=playlist';
        } else if (res.error === 'forbidden' || res.status === 403) {
          alert('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
        } else {
          alert('ì‚­ì œ ì‹¤íŒ¨: ' + (res.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (e) {
        console.error('playlist delete error:', e);
        alert('ì¬ìƒëª©ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ğŸ¨ í…Œë§ˆ ìƒ‰ ë³€ê²½
    const colorWrap = document.createElement('div');
    colorWrap.className = 'theme-color-wrap';
    const colorLabel = document.createElement('span');
    colorLabel.className = 'sub'; colorLabel.style.opacity = '.85'; colorLabel.textContent = 'í…Œë§ˆ ìƒ‰';
    const colorInput = document.createElement('input');
    colorInput.type = 'color'; colorInput.value = theme;
    const saveColorBtn = document.createElement('button');
    saveColorBtn.className = 'btn'; saveColorBtn.textContent = 'ìƒ‰ ì €ì¥';
    saveColorBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const newColor = colorInput.value || theme;
      try {
        await updateThemeColor(pl.id, newColor);
        theme = newColor; applyPlaylistTheme(theme);
        alert('í…Œë§ˆ ìƒ‰ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (err) {
        console.error('update theme error:', err);
        alert('í…Œë§ˆ ìƒ‰ ì €ì¥ ì‹¤íŒ¨: ' + err.message);
      }
    });

    colorWrap.appendChild(colorLabel);
    colorWrap.appendChild(colorInput);
    colorWrap.appendChild(saveColorBtn);

    controls.appendChild(playBtn);
    controls.appendChild(deleteBtn);
    controls.appendChild(colorWrap);

    meta.appendChild(title);
    meta.appendChild(sub);
    meta.appendChild(controls);

    box.appendChild(cover);
    box.appendChild(meta);
    header.appendChild(box);
  }

  function renderTracks(pl) {
    const list = $('#trackList');
    list.innerHTML = '';

    const items = pl.items || [];
    if (!items.length) {
      list.innerHTML =
        '<div class="sub" style="opacity:.7;padding:8px;">ì•„ì§ ì´ ì¬ìƒëª©ë¡ì— ê³¡ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ "ê³¡ ì¶”ê°€í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²€ìƒ‰ í™”ë©´ì—ì„œ ì¶”ê°€í•´ ë³´ì„¸ìš”.</div>';
      return;
    }

    items.forEach((t, idx) => {
      const row = document.createElement('div');
      row.className = 'plv-track-row';

      const index = document.createElement('div');
      index.className = 'sub';
      index.style.textAlign = 'right';
      index.textContent = idx + 1;

      const main = document.createElement('div');
      main.className = 'plv-track-main';
      const img = document.createElement('img');
      img.src = t.thumb || ''; img.alt = 'thumb';
      const texts = document.createElement('div');
      texts.style.minWidth = 0;
      texts.innerHTML = `
        <div class="plv-track-title">${t.title || ''}</div>
        <div class="plv-track-sub">${t.artist || ''} Â· ${t.source || ''}</div>
      `;
      main.appendChild(img); main.appendChild(texts);

      const right = document.createElement('div');
      right.style.textAlign = 'right';
      right.innerHTML = `<button class="btn" data-role="play">ì¬ìƒ</button>`;

      row.appendChild(index);
      row.appendChild(main);
      row.appendChild(right);

      // ê°œë³„ íŠ¸ë™ ì¬ìƒ: í•´ë‹¹ ì¸ë±ìŠ¤ë¶€í„° í ì‹œì‘
      row.addEventListener('click', (e) => {
        e.stopPropagation();
        setQueueFromPlaylist(pl, idx);                       // (ìˆì–´ë„ ë¬´ë°©)
        localStorage.setItem('currentTrackId', t.track_id);
        location.href = `./player.html?playlistId=${encodeURIComponent(pl.id)}`;
      });

      list.appendChild(row);
    });
  }

  // ê²€ìƒ‰ìœ¼ë¡œ ì´ë™
  $('#goAddFromSearch').addEventListener('click', () => {
    location.href = `./search.html?addToPlaylist=${encodeURIComponent(playlistId)}`;
  });

  // ì´ˆê¸° ë¡œë“œ
  (async function init() {
    try {
      const pl = await fetchPlaylist();
      renderHeader(pl);
      renderTracks(pl);
    } catch (e) {
      alert('ì¬ìƒëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n' + (e?.message || ''));
      location.href = './playlist.html';
    }
  })();
</script>

</body>
</html>
