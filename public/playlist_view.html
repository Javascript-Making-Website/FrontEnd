<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Emotion Playlist Â· Playlist</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
  <style>
    .plv-wrap {
      display:flex;
      flex-direction:column;
      gap:16px;
      padding:16px;
    }
    .plv-header {
      display:flex;
      gap:20px;
      align-items:flex-end;
    }
    .plv-cover {
      width:180px;
      height:180px;
      border-radius:16px;
      background:#111;
      overflow:hidden;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      grid-template-rows:repeat(2,1fr);
      gap:2px;
      flex-shrink:0;
    }
    .plv-cover img {
      width:100%;height:100%;object-fit:cover;
    }
    .plv-title {
      font-size:28px;
      font-weight:700;
      margin-bottom:4px;
    }
    .plv-sub {
      font-size:13px;
      opacity:.7;
    }
    .plv-controls {
      display:flex;
      gap:8px;
      margin-top:12px;
    }
    .plv-track-row {
      display:grid;
      grid-template-columns:24px minmax(0,1fr) 80px;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
    }
    .plv-track-row:hover {
      background:rgba(255,255,255,.04);
    }
    .plv-track-main {
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .plv-track-main img {
      width:44px;height:44px;border-radius:8px;object-fit:cover;flex-shrink:0;
    }
    .plv-track-title {
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .plv-track-sub {
      font-size:12px;
      opacity:.7;
    }
  </style>
</head>
<body data-mood="calm">
<header class="topbar">
  <div class="brand">ğŸ“‚ ì¬ìƒëª©ë¡</div>
  <nav class="nav">
    <a href="./home.html" class="btn">í™ˆ</a>
    <a href="./search.html" class="btn">ê²€ìƒ‰</a>
    <a href="./playlist.html" class="btn">ì¬ìƒëª©ë¡</a>
    <a href="./login.html" id="loginLink" class="btn">ë¡œê·¸ì¸</a>
    <span id="userBadge" class="badge hidden"></span>
    <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </nav>
</header>

<main class="plv-wrap">
  <section id="headerSection" class="panel">
    <!-- JSì—ì„œ ì±„ì›€ -->
  </section>

  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <div class="sub">íŠ¸ë™ ëª©ë¡</div>
      <button id="goAddFromSearch" class="btn">ê³¡ ì¶”ê°€í•˜ê¸° (ê²€ìƒ‰ìœ¼ë¡œ ì´ë™)</button>
    </div>
    <div id="trackList">
      <!-- JSì—ì„œ íŠ¸ë™ ë Œë”ë§ -->
    </div>
  </section>
</main>

<script src="./assets/api.js"></script>
<script src="./assets/auth.js"></script>
<script>
  const $ = (s)=>document.querySelector(s);
  const searchParams = new URLSearchParams(location.search);
  const playlistId = searchParams.get('id');

  if (!playlistId) {
    alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
    location.href = './playlist.html';
  }

  function buildCoverThumbs(items) {
    const thumbs = (items || []).map(t=>t.thumb).filter(Boolean).slice(0,4);
    return thumbs;
  }

  async function fetchPlaylist() {
    const res = await fetch(`http://localhost:3001/api/playlists/${encodeURIComponent(playlistId)}`, {
      credentials:'include'
    });
    if (!res.ok) throw new Error('playlist load fail');
    return res.json();
  }

  function renderHeader(pl) {
    const header = $('#headerSection');
    header.innerHTML = '';

    const box = document.createElement('div');
    box.className = 'plv-header';

    const cover = document.createElement('div');
    cover.className = 'plv-cover';
    const thumbs = buildCoverThumbs(pl.items);
    if (thumbs.length) {
      thumbs.forEach(src=>{
        const img = document.createElement('img');
        img.src = src;
        img.alt = 'thumb';
        cover.appendChild(img);
      });
      while (cover.childElementCount < 4) {
        const d = document.createElement('div');
        d.style.background = '#111';
        cover.appendChild(d);
      }
    } else {
      const d = document.createElement('div');
      d.style.gridColumn='1/3';
      d.style.gridRow='1/3';
      d.style.display='flex';
      d.style.alignItems='center';
      d.style.justifyContent='center';
      d.textContent='ğŸµ';
      cover.appendChild(d);
    }

    const meta = document.createElement('div');
    const title = document.createElement('div');
    title.className = 'plv-title';
    title.textContent = pl.title;

    const sub = document.createElement('div');
    sub.className = 'plv-sub';
    sub.textContent =
      `${pl.owner_name || 'ë‚˜'} Â· íŠ¸ë™ ${(pl.items || []).length}ê°œ Â· â™¥ ${pl.likes || 0} Â· ${pl.is_public ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'}`;

    const controls = document.createElement('div');
    controls.className = 'plv-controls';
    const playBtn = document.createElement('button');
    playBtn.className = 'btn primary';
    playBtn.textContent = 'â–¶ ì „ì²´ ì¬ìƒ';
    playBtn.addEventListener('click', () => {
      const first = (pl.items || [])[0];
      if (!first) {
        alert('ì¬ìƒí•  ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      localStorage.setItem('currentTrackId', first.track_id);
      location.href = './player.html';
    });

    controls.appendChild(playBtn);

    meta.appendChild(title);
    meta.appendChild(sub);
    meta.appendChild(controls);

    box.appendChild(cover);
    box.appendChild(meta);

    header.appendChild(box);
  }

  function renderTracks(pl) {
    const list = $('#trackList');
    list.innerHTML = '';

    const items = pl.items || [];
    if (!items.length) {
      list.innerHTML =
        '<div class="sub" style="opacity:.7;padding:8px;">ì•„ì§ ì´ ì¬ìƒëª©ë¡ì— ê³¡ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ "ê³¡ ì¶”ê°€í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²€ìƒ‰ í™”ë©´ì—ì„œ ì¶”ê°€í•´ ë³´ì„¸ìš”.</div>';
      return;
    }

    items.forEach((t, idx) => {
      const row = document.createElement('div');
      row.className = 'plv-track-row';

      const index = document.createElement('div');
      index.className = 'sub';
      index.style.textAlign = 'right';
      index.textContent = idx + 1;

      const main = document.createElement('div');
      main.className = 'plv-track-main';
      const img = document.createElement('img');
      img.src = t.thumb || '';
      img.alt = 'thumb';

      const texts = document.createElement('div');
      texts.style.minWidth = 0;
      texts.innerHTML = `
        <div class="plv-track-title">${t.title || ''}</div>
        <div class="plv-track-sub">${t.artist || ''} Â· ${t.source || ''}</div>
      `;

      main.appendChild(img);
      main.appendChild(texts);

      const right = document.createElement('div');
      right.style.textAlign = 'right';
      right.innerHTML = `
        <button class="btn" data-role="play">ì¬ìƒ</button>
      `;

      row.appendChild(index);
      row.appendChild(main);
      row.appendChild(right);

      // row í´ë¦­ â†’ ì¬ìƒ
      row.addEventListener('click', (e) => {
        // ìš°ì¸¡ ë²„íŠ¼ë„ ê°™ì€ ë™ì‘
        e.stopPropagation();
        localStorage.setItem('currentTrackId', t.track_id);
        location.href = './player.html';
      });

      list.appendChild(row);
    });
  }

  // ê²€ìƒ‰ í™”ë©´ìœ¼ë¡œ ì´ë™í•  ë•Œ ì¬ìƒëª©ë¡ idë¥¼ ê°™ì´ ë„˜ê¹€
  $('#goAddFromSearch').addEventListener('click', () => {
    location.href = `./search.html?addToPlaylist=${encodeURIComponent(playlistId)}`;
  });

  (async function init(){
    try {
      const pl = await fetchPlaylist();
      renderHeader(pl);
      renderTracks(pl);
    } catch (e) {
      console.error(e);
      alert('ì¬ìƒëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      location.href = './playlist.html';
    }
  })();
</script>
</body>
</html>
