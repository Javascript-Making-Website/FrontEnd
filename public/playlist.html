<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Emotion Playlist Â· Playlists</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
  <style>
    /* ë‚´ ì¬ìƒëª©ë¡ ê°€ë¡œ ìŠ¤í¬ë¡¤ */
    .my-playlists-row {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 8px 4px 4px;
      scrollbar-width: thin;
    }
    .my-playlists-row::-webkit-scrollbar {
      height: 6px;
    }

    /* ì¬ìƒëª©ë¡ ì¹´ë“œ */
    .pl-card {
      position: relative;
      min-width: 220px;
      max-width: 220px;
      background: var(--card);
      border-radius: 16px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .pl-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,.55);
    }

    /* ì»¤ë²„(ì¸ë„¤ì¼ë“¤ ëª¨ì¸ ì‚¬ê°í˜•) */
    .pl-cover {
      position: relative;
      width: 100%;
      aspect-ratio: 1/1;
      border-radius: 12px;
      overflow: hidden;
      background: linear-gradient(135deg,#111,#222);
      display: grid;
      grid-template-columns: repeat(2,1fr);
      grid-template-rows: repeat(2,1fr);
      gap: 2px;
    }
    .pl-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .pl-cover-fallback {
      grid-column: 1 / 3;
      grid-row: 1 / 3;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:32px;
      opacity:.6;
    }

    /* hover ì¬ìƒ ë²„íŠ¼ */
    .pl-play-hover {
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(135deg,rgba(0,0,0,.0),rgba(0,0,0,.45));
      opacity:0;
      transition:opacity .15s ease, transform .15s ease;
      pointer-events:none;
    }
    .pl-card:hover .pl-play-hover {
      opacity:1;
      transform:scale(1.02);
      pointer-events:auto;
    }
    .pl-play-btn {
      width:56px;
      height:56px;
      border-radius:50%;
      border:none;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--accent, #1ed760);
      font-size:24px;
      cursor:pointer;
    }

    .pl-meta-title {
      font-weight:600;
      font-size:16px;
    }
    .pl-meta-sub {
      font-size:12px;
      opacity:.7;
    }

    /* ê³µìœ  ì¬ìƒëª©ë¡ ë¦¬ìŠ¤íŠ¸ */
    .pl-public-row {
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px 0;
      border-bottom:1px solid rgba(255,255,255,.04);
      cursor:pointer;
    }
    .pl-public-thumb {
      width:56px;
      height:56px;
      border-radius:8px;
      background:#111;
      overflow:hidden;
      flex-shrink:0;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      grid-template-rows:repeat(2,1fr);
      gap:1px;
    }
    .pl-public-thumb img {
      width:100%; height:100%; object-fit:cover;
    }
    .badge-pill {
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      background:rgba(255,255,255,.08);
    }
  </style>
</head>
<body data-mood="calm">
<header class="topbar">
  <div class="brand">ğŸ“‚ ì¬ìƒëª©ë¡</div>
  <nav class="nav">
    <a href="./home.html" class="btn">í™ˆ</a>
    <a href="./search.html" class="btn">ê²€ìƒ‰</a>
    <a href="./playlist.html" class="btn">ë‚´ ì¬ìƒëª©ë¡</a>
    <a href="./login.html" id="loginLink" class="btn">ë¡œê·¸ì¸</a>
    <span id="userBadge" class="badge hidden"></span>
    <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </nav>
</header>

<main style="padding:16px;display:flex;flex-direction:column;gap:24px">

  <!-- ë‚´ ì¬ìƒëª©ë¡ (ê°€ë¡œ ìŠ¤í¬ë¡¤ ì²« ì¤„) -->
  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px">
      <div class="title">ë‚´ ì¬ìƒëª©ë¡</div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="plTitle"
               placeholder="ì¬ìƒëª©ë¡ ì´ë¦„"
               style="padding:8px 10px;border-radius:999px;min-width:180px;
                      background:var(--card);color:var(--text);
                      border:1px solid rgba(255,255,255,.16)"/>
        <button id="createPL" class="btn primary">ìƒì„±</button>
      </div>
    </div>

    <div id="myPlaylistsRow" class="my-playlists-row">
      <!-- JS ë Œë”ë§ -->
    </div>
  </section>

  <!-- ê³µìœ  ì¬ìƒëª©ë¡ (ì•„ë˜, ì„¸ë¡œ ìŠ¤í¬ë¡¤) -->
  <section class="panel" style="max-height:420px;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <div class="title">ê³µìœ  ì¬ìƒëª©ë¡</div>
      <div style="display:flex;gap:4px">
        <button class="btn" id="sortRecent" data-sort="recent">ìµœì‹ </button>
        <button class="btn" id="sortPopular" data-sort="popular">ì¸ê¸°</button>
      </div>
    </div>

    <div id="publicLists">
      <!-- JS ë Œë”ë§ -->
    </div>
  </section>
</main>

<script src="./assets/api.js"></script>
<script src="./assets/auth.js"></script>
<script>
  const BASE = 'http://localhost:3001';

  const $ = (s) => document.querySelector(s);

  function buildCoverThumbs(items) {
    // ìµœëŒ€ 4ê°œê¹Œì§€ ì¸ë„¤ì¼
    const thumbs = (items || [])
      .map(t => t.thumb)
      .filter(Boolean)
      .slice(0, 4);
    return thumbs;
  }

  function goPlaylistDetail(id) {
    location.href = `./playlist_view.html?id=${encodeURIComponent(id)}`;
  }

  async function renderMy() {
    const row = $('#myPlaylistsRow');
    row.innerHTML = '';

    try {
      const { items } = await API.playlists();
      if (!items || !items.length) {
        row.innerHTML =
          '<div class="sub" style="opacity:.7;padding:4px 8px;">ì•„ì§ ë§Œë“  ì¬ìƒëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì˜¤ë¥¸ìª½ì—ì„œ ìƒˆë¡œ ë§Œë“¤ì–´ ë³´ì„¸ìš”.</div>';
        return;
      }

      items.forEach(pl => {
        const card = document.createElement('div');
        card.className = 'pl-card';

        const thumbs = buildCoverThumbs(pl.items);
        const cover = document.createElement('div');
        cover.className = 'pl-cover';

        if (thumbs.length) {
          thumbs.forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            img.alt = 'thumb';
            cover.appendChild(img);
          });
          // ì¸ë„¤ì¼ì´ 1~3ê°œì¼ ë•ŒëŠ” ë‚˜ë¨¸ì§€ë¥¼ ê·¸ëƒ¥ ë¹ˆ ì¹¸ìœ¼ë¡œ ë‘ 
          while (cover.childElementCount < 4) {
            const div = document.createElement('div');
            div.style.background = '#111';
            cover.appendChild(div);
          }
        } else {
          const fallback = document.createElement('div');
          fallback.className = 'pl-cover-fallback';
          fallback.textContent = 'ğŸµ';
          cover.appendChild(fallback);
        }

        // hover play
        const hover = document.createElement('div');
        hover.className = 'pl-play-hover';
        const playBtn = document.createElement('button');
        playBtn.className = 'pl-play-btn';
        playBtn.innerHTML = 'â–¶';
        hover.appendChild(playBtn);
        cover.appendChild(hover);

        // ë©”íƒ€
        const metaTitle = document.createElement('div');
        metaTitle.className = 'pl-meta-title';
        metaTitle.textContent = pl.title;

        const trackCount = (pl.items || []).length;
        const metaSub = document.createElement('div');
        metaSub.className = 'pl-meta-sub';
        metaSub.textContent =
          `íŠ¸ë™ ${trackCount}ê°œ Â· ${pl.is_public ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'} Â· â™¥ ${pl.likes || 0}`;

        card.appendChild(cover);
        card.appendChild(metaTitle);
        card.appendChild(metaSub);

        // ì¹´ë“œ í´ë¦­ â†’ ìƒì„¸ í˜ì´ì§€
        card.addEventListener('click', () => {
          goPlaylistDetail(pl.id);
        });

        // hover ì¬ìƒ ë²„íŠ¼ í´ë¦­ â†’ ì²« ê³¡ ì¬ìƒ
        playBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const first = (pl.items || [])[0];
          if (!first) {
            alert('ì´ ì¬ìƒëª©ë¡ì—ëŠ” ì•„ì§ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          localStorage.setItem('currentTrackId', first.track_id);
          location.href = './player.html';
        });

        row.appendChild(card);
      });
    } catch (e) {
      console.warn(e);
      row.innerHTML =
        '<div class="sub" style="color:#f66;">ë‚´ ì¬ìƒëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
  }

  async function renderPublic(sort = 'recent') {
    const wrap = $('#publicLists');
    wrap.innerHTML = '';

    try {
      const { items } = await API.publicPlaylists({ sort, limit: 50 });
      if (!items || !items.length) {
        wrap.innerHTML =
          '<div class="sub" style="opacity:.7;">ê³µê°œ ì¬ìƒëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      items.forEach(pl => {
        const row = document.createElement('div');
        row.className = 'pl-public-row';

        const thumbBox = document.createElement('div');
        thumbBox.className = 'pl-public-thumb';

        const thumbs = buildCoverThumbs(pl.items);
        if (thumbs.length) {
          thumbs.forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            img.alt = 'thumb';
            thumbBox.appendChild(img);
          });
          while (thumbBox.childElementCount < 4) {
            const d = document.createElement('div');
            d.style.background = '#111';
            thumbBox.appendChild(d);
          }
        } else {
          const d = document.createElement('div');
          d.style.gridColumn = '1/3';
          d.style.gridRow = '1/3';
          d.style.display = 'flex';
          d.style.alignItems = 'center';
          d.style.justifyContent = 'center';
          d.textContent = 'ğŸµ';
          thumbBox.appendChild(d);
        }

        const meta = document.createElement('div');
        meta.style.flex = '1';
        meta.innerHTML = `
          <div class="title" style="font-size:15px;">${pl.title}</div>
          <div class="sub" style="font-size:12px;">
            ${pl.owner_name || 'ìµëª…'} Â· íŠ¸ë™ ${(pl.items || []).length}ê°œ
          </div>
        `;

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.flexDirection = 'column';
        right.style.alignItems = 'flex-end';
        right.innerHTML = `
          <span class="badge-pill">â™¥ ${pl.likes || 0}</span>
          <span class="sub" style="font-size:11px;margin-top:4px;">${pl.is_public ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'}</span>
        `;

        row.appendChild(thumbBox);
        row.appendChild(meta);
        row.appendChild(right);

        row.addEventListener('click', () => {
          goPlaylistDetail(pl.id);
        });

        wrap.appendChild(row);
      });
    } catch (e) {
      console.warn(e);
      wrap.innerHTML =
        '<div class="sub" style="color:#f66;">ê³µìœ  ì¬ìƒëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
  }

  // ì¬ìƒëª©ë¡ ìƒì„±
  $('#createPL').addEventListener('click', async () => {
    const input = $('#plTitle');
    const title = input.value.trim();
    if (!title) {
      alert('ì¬ìƒëª©ë¡ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      input.focus();
      return;
    }

    try {
      await API.createPlaylist({ title, isPublic: false });
      input.value = '';
      await renderMy();
    } catch (e) {
      console.warn(e);
      if (e && (e.status === 401 || e.error === 'login required')) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.');
        location.href = './login.html';
      } else {
        alert('ì¬ìƒëª©ë¡ ìƒì„± ì‹¤íŒ¨');
      }
    }
  });

  // ê³µìœ  ì •ë ¬ ë²„íŠ¼
  $('#sortRecent').addEventListener('click', () => renderPublic('recent'));
  $('#sortPopular').addEventListener('click', () => renderPublic('popular'));

  // ì´ˆê¸° ë Œë”
  renderMy();
  renderPublic('recent');
</script>
</body>
</html>
