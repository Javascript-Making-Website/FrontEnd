<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Emotion Playlist Â· Playlists</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
</head>
<body data-mood="calm">
  <header class="topbar">
    <div class="brand">ğŸ“‚ ì¬ìƒëª©ë¡</div>
    <nav class="nav">
      <a href="./home.html" class="btn">í™ˆ</a>
      <a href="./player.html" class="btn">ê°ìƒ</a>
      <a href="./search.html" class="btn">ê²€ìƒ‰</a>
      <a href="./login.html" id="loginLink" class="btn">ë¡œê·¸ì¸</a>
      <span id="userBadge" class="badge hidden"></span>
      <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
    </nav>
  </header>

  <main class="grid">
    <section class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px">
        <div class="title">ë‚´ ì¬ìƒëª©ë¡</div>
        <div style="display:flex;gap:8px">
          <input id="plTitle" placeholder="ì¬ìƒëª©ë¡ ì´ë¦„"
            style="padding:8px;border-radius:8px;background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,.12)"/>
          <button id="createPL" class="btn primary">ìƒì„±</button>
        </div>
      </div>
      <div id="myLists" class="list"></div>
    </section>

    <aside class="panel">
      <div class="title" style="margin-bottom:8px">ê³µìœ  ì¬ìƒëª©ë¡</div>
      <div id="publicLists" class="list"></div>
    </aside>
  </main>

  <!-- ì „ì—­ API/IIFE ë¨¼ì € ë¡œë“œ -->
  <script src="./assets/api.js"></script>
  <!-- í—¤ë” ë¡œê·¸ì¸ ìƒíƒœ ë™ê¸°í™” (API ë’¤ì—) -->
  <script src="./assets/auth.js"></script>

  <script>
    // ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ ê°±ì‹ ì€ auth.js ë‚´ë¶€ì—ì„œ ì²˜ë¦¬ë¨

    async function renderMy() {
      const wrap = document.getElementById('myLists');
      wrap.innerHTML = '';

      try {
        // í˜„ì¬ APIëŠ” playlists()ê°€ { items } ë°˜í™˜
        const { items } = await API.playlists();

        if (!items || items.length === 0) {
          wrap.innerHTML = '<div class="sub">ì¬ìƒëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        items.forEach(pl => {
          const card = document.createElement('div');
          card.className = 'panel';
          card.style.marginBottom = '8px';
          card.innerHTML = `
            <div class="title">
              ${pl.title} ${pl.is_public ? '<span class="badge">ê³µê°œ</span>' : ''}
            </div>
          `;

          (pl.items || []).forEach(t => {
            const row = document.createElement('div');
            row.className = 'item';
            const thumb = t.thumb || '';
            const artist = t.artist || '';
            const source = t.source || '';
            row.innerHTML = `
              <img src="${thumb}" alt="thumb"/>
              <div>
                <div class="title">${t.title}</div>
                <div class="sub">${artist} Â· <span class="badge">${source}</span></div>
              </div>
              <button class="btn">ì‚­ì œ</button>
            `;

            // ì‚­ì œ ë²„íŠ¼ (í˜„ì¬ API ì‹œê·¸ë‹ˆì²˜ì— ë§ì¶¤)
            row.querySelector('.btn').onclick = async (e) => {
              e.stopPropagation();
              await API.removeFromPlaylist({ playlistId: pl.id, trackId: t.track_id });
              await renderMy();
            };

            // í–‰ í´ë¦­ ì‹œ í”Œë ˆì´ì–´ë¡œ ì´ë™ (í˜„ì¬ íŠ¸ë™ ì§€ì •)
            row.onclick = () => {
              localStorage.setItem('currentTrackId', t.track_id);
              location.href = './player.html';
            };

            card.appendChild(row);
          });

          wrap.appendChild(card);
        });
      } catch (err) {
        if (err && (err.status === 401 || err.error === 'login required')) {
          wrap.innerHTML = '<div class="sub">ë¡œê·¸ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
        } else {
          wrap.innerHTML = '<div class="sub">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
          console.warn(err);
        }
      }
    }

    async function renderPublic() {
      const wrap = document.getElementById('publicLists');
      wrap.innerHTML = '';
      try {
        const { items } = await API.publicPlaylists();
        if (!items || items.length === 0) {
          wrap.innerHTML = '<div class="sub">ê³µê°œ ì¬ìƒëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        items.forEach(pl => {
          const el = document.createElement('div');
          el.className = 'panel';
          el.style.marginBottom = '8px';
          el.innerHTML = `
            <div class="title">${pl.title} <span class="badge">ê³µê°œ</span></div>
            <div class="sub">ì¬ìƒëª©ë¡ ID: ${pl.id}</div>
          `;
          wrap.appendChild(el);
        });
      } catch (e) {
        wrap.innerHTML = '<div class="sub">ê³µê°œ ì¬ìƒëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        console.warn(e);
      }
    }

    document.getElementById('createPL').onclick = async () => {
      const titleEl = document.getElementById('plTitle');
      const title = titleEl.value.trim();
      if (!title) { alert('ì¬ìƒëª©ë¡ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); titleEl.focus(); return; }

      try {
        // í˜„ì¬ API ì‹œê·¸ë‹ˆì²˜ì— ë§ì¶¤
        await API.createPlaylist({ title, isPublic: false });
        titleEl.value = '';
        await renderMy();
      } catch (e) {
        if (e && (e.status === 401 || e.error === 'login required')) {
          alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.');
          location.href = './login.html';
        } else {
          alert('ìƒì„± ì‹¤íŒ¨');
          console.warn(e);
        }
      }
    };

    // ì´ˆê¸° ë Œë”
    renderMy();
    renderPublic();
  </script>
</body>
</html>