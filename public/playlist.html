<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Emotion Playlist Â· Playlists</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
  <style>
    /* ë‚´ ì¬ìƒëª©ë¡ ê°€ë¡œ ìŠ¤í¬ë¡¤ */
    .my-playlists-row {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 8px 4px 4px;
      scrollbar-width: thin;
    }
    .my-playlists-row::-webkit-scrollbar {
      height: 6px;
    }

    /* ì¬ìƒëª©ë¡ ì¹´ë“œ */
    .pl-card {
      position: relative;
      min-width: 220px;
      max-width: 220px;
      background: var(--card);
      border-radius: 16px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .pl-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,.55);
    }

    /* ì¬ìƒëª©ë¡ ì‚­ì œ ë²„íŠ¼ (í˜¸ë²„ ì‹œ ë…¸ì¶œ) */
    .pl-delete-btn {
      position: absolute;
      bottom: 6px;
      right: 8px;
      padding: 4px 6px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      background: rgba(255, 80, 80, 0.9);
      color: #fff;
      cursor: pointer;
      opacity: 0;                 /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
      transform: translateY(4px); /* ì‚´ì§ ë‚´ë ¤ê°€ ìˆê²Œ */
      transition: opacity .15s ease, transform .15s ease;
      z-index: 5;                 /* ì¬ìƒ hover ìœ„ì— ì˜¬ë¼ì˜¤ê²Œ */
      pointer-events: none;       /* ê¸°ë³¸ì€ í´ë¦­ ì•ˆ ë¨ (í˜¸ë²„ ë•Œ ì¼œì§) */
    }
    .pl-card:hover .pl-delete-btn {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;       /* ì¹´ë“œì— í˜¸ë²„ë˜ë©´ í´ë¦­ ê°€ëŠ¥ */
    }
    .pl-delete-btn:hover {
      background: rgba(255, 40, 40, 1);
    }


    /* ì»¤ë²„(ì¸ë„¤ì¼ë“¤ ëª¨ì¸ ì‚¬ê°í˜•) */
    .pl-cover {
      position: relative;
      width: 100%;
      aspect-ratio: 1/1;
      border-radius: 12px;
      overflow: hidden;
      background: linear-gradient(135deg,#111,#222);
      display: grid;
      grid-template-columns: repeat(2,1fr);
      grid-template-rows: repeat(2,1fr);
      gap: 2px;
    }
    .pl-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .pl-cover-fallback {
      grid-column: 1 / 3;
      grid-row: 1 / 3;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:32px;
      opacity:.6;
    }

    /* hover ì¬ìƒ ë²„íŠ¼ */
    .pl-play-hover {
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(135deg,rgba(0,0,0,.0),rgba(0,0,0,.45));
      opacity:0;
      transition:opacity .15s ease, transform .15s ease;
      pointer-events:none;
    }
    .pl-card:hover .pl-play-hover {
      opacity:1;
      transform:scale(1.02);
      pointer-events:auto;
    }
    .pl-play-btn {
      width:56px;
      height:56px;
      border-radius:50%;
      border:none;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--accent, #1ed760);
      font-size:24px;
      cursor:pointer;
    }

    .pl-meta-title {
      font-weight:600;
      font-size:16px;
    }
    .pl-meta-sub {
      font-size:12px;
      opacity:.7;
    }

    /* ê³µìœ  ì¬ìƒëª©ë¡ ë¦¬ìŠ¤íŠ¸ */
    .pl-public-row {
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px 0;
      border-bottom:1px solid rgba(255,255,255,.04);
      cursor:pointer;
    }
    .pl-public-thumb {
      width:56px;
      height:56px;
      border-radius:8px;
      background:#111;
      overflow:hidden;
      flex-shrink:0;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      grid-template-rows:repeat(2,1fr);
      gap:1px;
    }
    .pl-public-thumb img {
      width:100%; height:100%; object-fit:cover;
    }
    .badge-pill {
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      background:rgba(255,255,255,.08);
    }
  </style>
</head>
<body data-mood="calm" data-auth-required="playlist">
<header class="topbar">
  <div class="brand">ğŸ“‚ ì¬ìƒëª©ë¡</div>
  <nav class="nav">
    <a href="./home.html" class="btn">í™ˆ</a>
    <a href="./search.html" class="btn">ê²€ìƒ‰</a>
    <a href="./playlist.html" class="btn">ë‚´ ì¬ìƒëª©ë¡</a>
    <a href="./login.html" id="loginLink" class="btn">ë¡œê·¸ì¸</a>
    <span id="userBadge" class="badge hidden"></span>
    <button id="logoutBtn" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
  </nav>
</header>

<main style="padding:16px;display:flex;flex-direction:column;gap:24px">

  <!-- ë‚´ ì¬ìƒëª©ë¡ (ê°€ë¡œ ìŠ¤í¬ë¡¤ ì²« ì¤„) -->
  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px">
      <div class="title">ë‚´ ì¬ìƒëª©ë¡</div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="plTitle"
              placeholder="ì¬ìƒëª©ë¡ ì´ë¦„"
              style="padding:8px 10px;border-radius:999px;min-width:180px;
                      background:var(--card);color:var(--text);
                      border:1px solid rgba(255,255,255,.16)"/>

        <!-- ğŸ¨ ì¬ìƒëª©ë¡ ìƒ‰ ì„ íƒ -->
        <div style="display:flex;align-items:center;gap:6px;font-size:12px;">
          <span class="sub" style="opacity:.8;">í…Œë§ˆ ìƒ‰</span>
          <input id="plColor"
                type="color"
                value="#22d3ee"
                style="width:32px;height:32px;border-radius:50%;border:none;padding:0;cursor:pointer;background:transparent;"/>
        </div>
  <button id="createPL" class="btn primary">ìƒì„±</button>
</div>

    </div>

    <div id="myPlaylistsRow" class="my-playlists-row">
      <!-- JS ë Œë”ë§ -->
    </div>
  </section>

  <!-- ê³µìœ  ì¬ìƒëª©ë¡ (ì•„ë˜, ì„¸ë¡œ ìŠ¤í¬ë¡¤) -->
  <section class="panel" style="max-height:420px;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <div class="title">ê³µìœ  ì¬ìƒëª©ë¡</div>
      <div style="display:flex;gap:4px">
        <button class="btn" id="sortRecent" data-sort="recent">ìµœì‹ </button>
        <button class="btn" id="sortPopular" data-sort="popular">ì¸ê¸°</button>
      </div>
    </div>

    <div id="publicLists">
      <!-- JS ë Œë”ë§ -->
    </div>
  </section>
</main>

<script src="./assets/api.js"></script>
<script src="./assets/auth.js"></script>
<script>
  // í˜ì´ì§€ ë¡œë“œë˜ìë§ˆì ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
  if (window.Auth) {
    Auth.requireLogin('playlist');
  }

  const $ = (s) => document.querySelector(s);

  function buildCoverThumbs(items) {
    const thumbs = (items || [])
      .map(t => t.thumb)
      .filter(Boolean)
      .slice(0, 4);
    return thumbs;
  }

  function goPlaylistDetail(id) {
    location.href = `./playlist_view.html?id=${encodeURIComponent(id)}`;
  }

  async function renderMy() {
    const row = $('#myPlaylistsRow');
    row.innerHTML = '';

    try {
      const res = await API.playlists();
      console.log('â–¶ /api/playlists ê²°ê³¼:', res); // ë””ë²„ê¹…ìš©
      const items = res.items || [];

      if (!items.length) {
        row.innerHTML =
          '<div class="sub" style="opacity:.7;padding:4px 8px;">ì•„ì§ ë§Œë“  ì¬ìƒëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì˜¤ë¥¸ìª½ì—ì„œ ìƒˆë¡œ ë§Œë“¤ì–´ ë³´ì„¸ìš”.</div>';
        return;
      }

      items.forEach(pl => {
        const card = document.createElement('div');
        card.className = 'pl-card';
        card.dataset.id = pl.id; // í˜¹ì‹œ ë‚˜ì¤‘ì— ì“¸ ìˆ˜ ìˆìœ¼ë‹ˆ ë„£ì–´ë‘ 

        // ğŸ”¥ ì´ ì¬ìƒëª©ë¡ì˜ ìƒ‰ (ì—†ìœ¼ë©´ ê¸°ë³¸)
        const theme = pl.theme_color || '#22d3ee';
        card.style.background = `linear-gradient(135deg, ${theme}25, #020617)`;
        card.style.border = `1px solid ${theme}55`;

        const thumbs = buildCoverThumbs(pl.items);
        const cover = document.createElement('div');
        cover.className = 'pl-cover';

        if (thumbs.length) {
          thumbs.forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            img.alt = 'thumb';
            cover.appendChild(img);
          });
          while (cover.childElementCount < 4) {
            const div = document.createElement('div');
            div.style.background = '#111';
            cover.appendChild(div);
          }
        } else {
          const fallback = document.createElement('div');
          fallback.className = 'pl-cover-fallback';
          fallback.textContent = 'ğŸµ';
          cover.appendChild(fallback);
        }

        const hover = document.createElement('div');
        hover.className = 'pl-play-hover';
        const playBtn = document.createElement('button');
        playBtn.className = 'pl-play-btn';
        playBtn.innerHTML = 'â–¶';
        // ë²„íŠ¼ ë°°ê²½ë„ ì¬ìƒëª©ë¡ ìƒ‰ìœ¼ë¡œ
        playBtn.style.background = theme;
        hover.appendChild(playBtn);
        cover.appendChild(hover);

        // ğŸ”¥ ì—¬ê¸°: ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'pl-delete-btn';
        deleteBtn.textContent = 'âœ•';

        const metaTitle = document.createElement('div');
        metaTitle.className = 'pl-meta-title';
        metaTitle.textContent = pl.title;

        const trackCount = (pl.items || []).length;
        const metaSub = document.createElement('div');
        metaSub.className = 'pl-meta-sub';
        metaSub.textContent =
          `íŠ¸ë™ ${trackCount}ê°œ Â· ${pl.is_public ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'} Â· â™¥ ${pl.likes || 0}`;

        card.appendChild(cover);
        card.appendChild(metaTitle);
        card.appendChild(metaSub);
        card.appendChild(deleteBtn);

        // ì¹´ë“œ í´ë¦­ â†’ ìƒì„¸ í˜ì´ì§€
        card.addEventListener('click', () => {
          goPlaylistDetail(pl.id);
        });

        // â–¶ í”Œë ˆì´ ë²„íŠ¼ (í´ë¦­ ì „íŒŒ ë§‰ê¸°)
        playBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const first = (pl.items || [])[0];
          if (!first) {
            alert('ì´ ì¬ìƒëª©ë¡ì—ëŠ” ì•„ì§ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          localStorage.setItem('currentTrackId', first.track_id);
          location.href = './player.html';
        });

        // âŒ ì‚­ì œ ë²„íŠ¼ (í´ë¦­ ì „íŒŒ ë§‰ê¸° + API í˜¸ì¶œ)
        deleteBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          if (!confirm(`"${pl.title}" ì¬ìƒëª©ë¡ì„ ì‚­ì œí• ê¹Œìš”?`)) return;

          try {
            const res = await API.deletePlaylist(pl.id);
            if (res.ok) {
              card.remove();
              if (!row.children.length) {
                row.innerHTML =
                  '<div class="sub" style="opacity:.7;padding:4px 8px;">ì•„ì§ ë§Œë“  ì¬ìƒëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì˜¤ë¥¸ìª½ì—ì„œ ìƒˆë¡œ ë§Œë“¤ì–´ ë³´ì„¸ìš”.</div>';
              }
            } else {
              alert('ì‚­ì œ ì‹¤íŒ¨: ' + (res.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
          } catch (err) {
            console.warn('â–¶ /api/playlists/:id DELETE ì‹¤íŒ¨:', err);
            alert('ì¬ìƒëª©ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        });

        row.appendChild(card);
      });
    } catch (e) {
      console.warn('â–¶ /api/playlists ì‹¤íŒ¨:', e);

      if (e && (e.status === 401 || e.error === 'login required')) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.');
        location.href = './login.html?redirect=playlist';
        return;
      }

      row.innerHTML =
        '<div class="sub" style="color:#f66;">ë‚´ ì¬ìƒëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
  }

  async function renderPublic(sort = 'recent') {
    const wrap = $('#publicLists');
    wrap.innerHTML = '';

    try {
      const res = await API.publicPlaylists({ sort, limit: 50 });
      console.log('â–¶ /api/playlists/public ê²°ê³¼:', res); // ë””ë²„ê¹…ìš©
      const items = res.items || [];

      if (!items.length) {
        wrap.innerHTML =
          '<div class="sub" style="opacity:.7;">ê³µê°œ ì¬ìƒëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      items.forEach(pl => {
        const row = document.createElement('div');
        row.className = 'pl-public-row';

        const thumbBox = document.createElement('div');
        thumbBox.className = 'pl-public-thumb';

        const thumbs = buildCoverThumbs(pl.items);
        if (thumbs.length) {
          thumbs.forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            img.alt = 'thumb';
            thumbBox.appendChild(img);
          });
          while (thumbBox.childElementCount < 4) {
            const d = document.createElement('div');
            d.style.background = '#111';
            thumbBox.appendChild(d);
          }
        } else {
          const d = document.createElement('div');
          d.style.gridColumn = '1/3';
          d.style.gridRow = '1/3';
          d.style.display = 'flex';
          d.style.alignItems = 'center';
          d.style.justifyContent = 'center';
          d.textContent = 'ğŸµ';
          thumbBox.appendChild(d);
        }

        const meta = document.createElement('div');
        meta.style.flex = '1';
        meta.innerHTML = `
          <div class="title" style="font-size:15px;">${pl.title}</div>
          <div class="sub" style="font-size:12px;">
            ${pl.owner_name || 'ìµëª…'} Â· íŠ¸ë™ ${(pl.items || []).length}ê°œ
          </div>
        `;

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.flexDirection = 'column';
        right.style.alignItems = 'flex-end';
        right.innerHTML = `
          <span class="badge-pill">â™¥ ${pl.likes || 0}</span>
          <span class="sub" style="font-size:11px;margin-top:4px;">${pl.is_public ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'}</span>
        `;

        row.appendChild(thumbBox);
        row.appendChild(meta);
        row.appendChild(right);

        row.addEventListener('click', () => {
          goPlaylistDetail(pl.id);
        });

        wrap.appendChild(row);
      });
    } catch (e) {
      console.warn('â–¶ /api/playlists/public ì‹¤íŒ¨:', e);
      wrap.innerHTML =
        '<div class="sub" style="color:#f66;">ê³µê°œ ì¬ìƒëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
  }

  // ì¬ìƒëª©ë¡ ìƒì„±
  $('#createPL').addEventListener('click', async () => {
  const input = $('#plTitle');
  const colorInput = $('#plColor');
  const title = input.value.trim();
  if (!title) {
    alert('ì¬ìƒëª©ë¡ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
    input.focus();
    return;
  }

  const themeColor = (colorInput && colorInput.value) ? colorInput.value : '#22d3ee';

  try {
    const res = await API.createPlaylist({ title, isPublic: false, themeColor });
    console.log('â–¶ /api/playlists POST ê²°ê³¼:', res);
    input.value = '';
    await renderMy();
  } catch (e) {
      console.warn('â–¶ /api/playlists POST ì‹¤íŒ¨:', e);
      if (e && (e.status === 401 || e.error === 'login required')) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.');
        location.href = './login.html?redirect=playlist';
      } else {
        alert('ì¬ìƒëª©ë¡ ìƒì„± ì‹¤íŒ¨: ' + (e?.error ?? 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    }
  });

  $('#sortRecent').addEventListener('click', () => renderPublic('recent'));
  $('#sortPopular').addEventListener('click', () => renderPublic('popular'));

  // ì´ˆê¸° ë Œë”
  renderMy();
  renderPublic('recent');
</script>
</body>
</html>
