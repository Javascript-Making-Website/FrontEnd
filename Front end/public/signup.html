<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Emotion Playlist Â· Signup</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
</head>
<body data-mood="calm">
  <header class="topbar">
    <div class="brand">ğŸ“ íšŒì›ê°€ì…</div>
    <nav class="nav">
      <a href="./home.html" class="btn">í™ˆ</a>
      <a href="./search.html" class="btn">ê²€ìƒ‰</a>
      <a href="./playlist.html" class="btn">ì¬ìƒëª©ë¡</a>
      <a href="./login.html" class="btn">ë¡œê·¸ì¸</a>
    </nav>
  </header>

  <main class="panel" style="max-width:420px;margin:16px auto;">
    <div class="title" style="margin-bottom:8px">ìƒˆ ê³„ì • ë§Œë“¤ê¸°</div>

    <div style="display:flex;flex-direction:column;gap:8px">
      <input id="username" placeholder="ì•„ì´ë””"
        style="padding:10px;border-radius:10px;background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,.12)"/>

      <input id="email" placeholder="ì´ë©”ì¼ (ì„ íƒ)"
        style="padding:10px;border-radius:10px;background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,.12)"/>

      <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"
        style="padding:10px;border-radius:10px;background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,.12)"/>

      <input id="password2" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
        style="padding:10px;border-radius:10px;background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,.12)"/>

      <button id="signupBtn" class="btn primary">íšŒì›ê°€ì…</button>
    </div>
  </main>

  <!-- ì„œë²„ API / ì¸ì¦ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="./assets/api.js"></script>
  <script src="./assets/auth.js"></script>

  <script>
    const BASE = 'http://localhost:3001';

    document.addEventListener('DOMContentLoaded', () => {
      const usernameEl = document.getElementById('username');
      const emailEl    = document.getElementById('email');
      const pwEl       = document.getElementById('password');
      const pw2El      = document.getElementById('password2');
      const btn        = document.getElementById('signupBtn');

      // í•„ìˆ˜ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™” ì¤‘ë‹¨
      if (!usernameEl || !pwEl || !pw2El || !btn) {
        console.warn('signup elements not found', {
          usernameEl, emailEl, pwEl, pw2El, btn
        });
        return;
      }

      async function handleSignup(e) {
        if (e) e.preventDefault();

        const username = usernameEl.value.trim();
        const email    = (emailEl?.value || '').trim();
        const pw       = pwEl.value;
        const pw2      = pw2El.value;

        if (!username) {
          alert('ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
          usernameEl.focus();
          return;
        }
        if (!pw) {
          alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
          pwEl.focus();
          return;
        }
        if (pw.length < 6) {
          alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
          pwEl.focus();
          return;
        }
        if (pw !== pw2) {
          alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          pw2El.focus();
          return;
        }

        try {
          const res = await fetch(`${BASE}/api/signup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username, password: pw, email })
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            // ì„œë²„ì—ì„œ ë‚´ë ¤ì£¼ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ ê·¸ëŒ€ë¡œ ë…¸ì¶œ
            alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + (data.error || `${res.status} ${res.statusText}`));
            return;
          }

          // í”„ë¡ íŠ¸ ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥ (auth.jsì—ì„œ ì“°ëŠ” í˜•ì‹ ê·¸ëŒ€ë¡œ)
          localStorage.setItem('ep_user', JSON.stringify({
            name: username,
            loggedIn: true,
            createdAt: Date.now()
          }));

          alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.');
          location.href = './home.html';
        } catch (err) {
          console.error('signup error', err);
          alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + (err?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      }

      // ë²„íŠ¼ í´ë¦­ ì‹œ
      btn.addEventListener('click', handleSignup);

      // ê° inputì—ì„œ ì—”í„° ëˆŒë €ì„ ë•Œë„ ë™ì‘
      [usernameEl, emailEl, pwEl, pw2El].forEach((el) => {
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleSignup();
          }
        });
      });
    });
  </script>
</body>
</html>
